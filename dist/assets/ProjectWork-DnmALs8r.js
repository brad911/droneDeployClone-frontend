import{ao as xo,an as No,E as Ye,j as g,r as x,ap as Fo,as as Re,N as ct,aq as Do,i as ro,at as It,ar as Ro,a5 as no,au as ko,av as Et,aw as io,ak as At,b as Uo,d as Ne,ax as Bo,B as fe,T as Pe,Y as so,l as Ge,ay as $o,a3 as ao,m as ae,ac as Go,az as Vo,a4 as ge,Q as $t,aA as jo,aB as zo,aC as qo,aD as Jo,D as Ho,k as ke,C as Ue,F as Wo,I as Yo,y as Xo,M as Zo,aE as Ko}from"./index-wjFNmjwi.js";import{m as se}from"./mapbox-gl-4A0JGIq9.js";import{u as Qo,I as er}from"./index-uFRSZLzC.js";import{F as tr}from"./FormGroup-DABCIsPF.js";function or(e){return No("MuiAlert",e)}const Gt=xo("MuiAlert",["root","action","icon","message","filled","colorSuccess","colorInfo","colorWarning","colorError","filledSuccess","filledInfo","filledWarning","filledError","outlined","outlinedSuccess","outlinedInfo","outlinedWarning","outlinedError","standard","standardSuccess","standardInfo","standardWarning","standardError"]),rr=Ye(g.jsx("path",{d:"M20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4C12.76,4 13.5,4.11 14.2, 4.31L15.77,2.74C14.61,2.26 13.34,2 12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0, 0 22,12M7.91,10.08L6.5,11.5L11,16L21,6L19.59,4.58L11,13.17L7.91,10.08Z"})),nr=Ye(g.jsx("path",{d:"M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"})),ir=Ye(g.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"})),sr=Ye(g.jsx("path",{d:"M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20, 12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10, 10 0 0,0 12,2M11,17H13V11H11V17Z"})),ar=Ye(g.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})),lr=e=>{const{variant:t,color:o,severity:r,classes:n}=e,i={root:["root",`color${It(o||r)}`,`${t}${It(o||r)}`,`${t}`],icon:["icon"],message:["message"],action:["action"]};return Ro(i,or,n)},cr=ct(no,{name:"MuiAlert",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:o}=e;return[t.root,t[o.variant],t[`${o.variant}${It(o.color||o.severity)}`]]}})(ko(({theme:e})=>{const t=e.palette.mode==="light"?e.darken:e.lighten,o=e.palette.mode==="light"?e.lighten:e.darken;return{...e.typography.body2,backgroundColor:"transparent",display:"flex",padding:"6px 16px",variants:[...Object.entries(e.palette).filter(Et(["light"])).map(([r])=>({props:{colorSeverity:r,variant:"standard"},style:{color:e.vars?e.vars.palette.Alert[`${r}Color`]:t(e.palette[r].light,.6),backgroundColor:e.vars?e.vars.palette.Alert[`${r}StandardBg`]:o(e.palette[r].light,.9),[`& .${Gt.icon}`]:e.vars?{color:e.vars.palette.Alert[`${r}IconColor`]}:{color:e.palette[r].main}}})),...Object.entries(e.palette).filter(Et(["light"])).map(([r])=>({props:{colorSeverity:r,variant:"outlined"},style:{color:e.vars?e.vars.palette.Alert[`${r}Color`]:t(e.palette[r].light,.6),border:`1px solid ${(e.vars||e).palette[r].light}`,[`& .${Gt.icon}`]:e.vars?{color:e.vars.palette.Alert[`${r}IconColor`]}:{color:e.palette[r].main}}})),...Object.entries(e.palette).filter(Et(["dark"])).map(([r])=>({props:{colorSeverity:r,variant:"filled"},style:{fontWeight:e.typography.fontWeightMedium,...e.vars?{color:e.vars.palette.Alert[`${r}FilledColor`],backgroundColor:e.vars.palette.Alert[`${r}FilledBg`]}:{backgroundColor:e.palette.mode==="dark"?e.palette[r].dark:e.palette[r].main,color:e.palette.getContrastText(e.palette[r].main)}}}))]}})),ur=ct("div",{name:"MuiAlert",slot:"Icon"})({marginRight:12,padding:"7px 0",display:"flex",fontSize:22,opacity:.9}),dr=ct("div",{name:"MuiAlert",slot:"Message"})({padding:"8px 0",minWidth:0,overflow:"auto"}),pr=ct("div",{name:"MuiAlert",slot:"Action"})({display:"flex",alignItems:"flex-start",padding:"4px 0 0 16px",marginLeft:"auto",marginRight:-8}),Vt={success:g.jsx(rr,{fontSize:"inherit"}),warning:g.jsx(nr,{fontSize:"inherit"}),error:g.jsx(ir,{fontSize:"inherit"}),info:g.jsx(sr,{fontSize:"inherit"})},jt=x.forwardRef(function(t,o){const r=Fo({props:t,name:"MuiAlert"}),{action:n,children:i,className:s,closeText:c="Close",color:a,components:u={},componentsProps:y={},icon:E,iconMapping:l=Vt,onClose:p,role:h="alert",severity:T="success",slotProps:_={},slots:N={},variant:V="standard",...$}=r,L={...r,color:a,severity:T,variant:V,colorSeverity:a||T},F=lr(L),ne={slots:{closeButton:u.CloseButton,closeIcon:u.CloseIcon,...N},slotProps:{...y,..._}},[X,te]=Re("root",{ref:o,shouldForwardComponentProp:!0,className:Do(F.root,s),elementType:cr,externalForwardedProps:{...ne,...$},ownerState:L,additionalProps:{role:h,elevation:0}}),[Z,Ie]=Re("icon",{className:F.icon,elementType:ur,externalForwardedProps:ne,ownerState:L}),[ze,qe]=Re("message",{className:F.message,elementType:dr,externalForwardedProps:ne,ownerState:L}),[xe,Me]=Re("action",{className:F.action,elementType:pr,externalForwardedProps:ne,ownerState:L}),[be,q]=Re("closeButton",{elementType:ro,externalForwardedProps:ne,ownerState:L}),[Le,we]=Re("closeIcon",{elementType:ar,externalForwardedProps:ne,ownerState:L});return g.jsxs(X,{...te,children:[E!==!1?g.jsx(Z,{...Ie,children:E||l[T]||Vt[T]}):null,g.jsx(ze,{...qe,children:i}),n!=null?g.jsx(xe,{...Me,children:n}):null,n==null&&p?g.jsx(xe,{...Me,children:g.jsx(be,{size:"small","aria-label":c,title:c,color:"inherit",onClick:p,...q,children:g.jsx(Le,{fontSize:"small",...we})})}):null]})});/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var fr=io("outline","trash","IconTrash",[["path",{d:"M4 7l16 0",key:"svg-0"}],["path",{d:"M10 11l0 6",key:"svg-1"}],["path",{d:"M14 11l0 6",key:"svg-2"}],["path",{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12",key:"svg-3"}],["path",{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3",key:"svg-4"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var hr=io("outline","x","IconX",[["path",{d:"M18 6l-12 12",key:"svg-0"}],["path",{d:"M6 6l12 12",key:"svg-1"}]]),Qe={},Je={},zt;function gr(){return zt||(zt=1,Je.RADIUS=6378137,Je.FLATTENING=1/298.257223563,Je.POLAR_RADIUS=63567523142e-4),Je}var qt;function yr(){if(qt)return Qe;qt=1;var e=gr();Qe.geometry=t,Qe.ring=r;function t(i){var s=0,c;switch(i.type){case"Polygon":return o(i.coordinates);case"MultiPolygon":for(c=0;c<i.coordinates.length;c++)s+=o(i.coordinates[c]);return s;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(c=0;c<i.geometries.length;c++)s+=t(i.geometries[c]);return s}}function o(i){var s=0;if(i&&i.length>0){s+=Math.abs(r(i[0]));for(var c=1;c<i.length;c++)s-=Math.abs(r(i[c]))}return s}function r(i){var s,c,a,u,y,E,l,p=0,h=i.length;if(h>2){for(l=0;l<h;l++)l===h-2?(u=h-2,y=h-1,E=0):l===h-1?(u=h-1,y=0,E=1):(u=l,y=l+1,E=l+2),s=i[u],c=i[y],a=i[E],p+=(n(a[0])-n(s[0]))*Math.sin(n(c[1]));p=p*e.RADIUS*e.RADIUS/2}return p}function n(i){return i*Math.PI/180}return Qe}var mr=yr();const rt=At(mr);var ie=63710088e-1,lo={centimeters:ie*100,centimetres:ie*100,degrees:360/(2*Math.PI),feet:ie*3.28084,inches:ie*39.37,kilometers:ie/1e3,kilometres:ie/1e3,meters:ie,metres:ie,miles:ie/1609.344,millimeters:ie*1e3,millimetres:ie*1e3,nauticalmiles:ie/1852,radians:1,yards:ie*1.0936};function it(e,t,o={}){const r={type:"Feature"};return(o.id===0||o.id)&&(r.id=o.id),o.bbox&&(r.bbox=o.bbox),r.properties=t||{},r.geometry=e,r}function st(e,t,o={}){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Jt(e[0])||!Jt(e[1]))throw new Error("coordinates must contain numbers");return it({type:"Point",coordinates:e},t,o)}function Er(e,t,o={}){if(e.length<2)throw new Error("coordinates must be an array of two or more positions");return it({type:"LineString",coordinates:e},t,o)}function vr(e,t="kilometers"){const o=lo[t];if(!o)throw new Error(t+" units is invalid");return e*o}function Cr(e,t="kilometers"){const o=lo[t];if(!o)throw new Error(t+" units is invalid");return e/o}function Mt(e){return e%(2*Math.PI)*180/Math.PI}function ye(e){return e%360*Math.PI/180}function Jt(e){return!isNaN(e)&&e!==null&&!Array.isArray(e)}function We(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return[...e.geometry.coordinates];if(e.type==="Point")return[...e.coordinates]}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return[...e];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Sr(e){return e.type==="Feature"?e.geometry:e}function co(e,t,o={}){if(o.final===!0)return Tr(e,t);const r=We(e),n=We(t),i=ye(r[0]),s=ye(n[0]),c=ye(r[1]),a=ye(n[1]),u=Math.sin(s-i)*Math.cos(a),y=Math.cos(c)*Math.sin(a)-Math.sin(c)*Math.cos(a)*Math.cos(s-i);return Mt(Math.atan2(u,y))}function Tr(e,t){let o=co(t,e);return o=(o+180)%360,o}function _r(e,t,o,r={}){const n=We(e),i=ye(n[0]),s=ye(n[1]),c=ye(o),a=Cr(t,r.units),u=Math.asin(Math.sin(s)*Math.cos(a)+Math.cos(s)*Math.sin(a)*Math.cos(c)),y=i+Math.atan2(Math.sin(c)*Math.sin(a)*Math.cos(s),Math.cos(a)-Math.sin(s)*Math.sin(u)),E=Mt(y),l=Mt(u);return st([E,l],r.properties)}function uo(e,t,o={}){var r=We(e),n=We(t),i=ye(n[1]-r[1]),s=ye(n[0]-r[0]),c=ye(r[1]),a=ye(n[1]),u=Math.pow(Math.sin(i/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(c)*Math.cos(a);return vr(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),o.units)}function vt(e,t,o={}){const n=Sr(e).coordinates;let i=0;for(let s=0;s<n.length&&!(t>=i&&s===n.length-1);s++)if(i>=t){const c=t-i;if(c){const a=co(n[s],n[s-1])-180;return _r(n[s],c,a,o)}else return st(n[s])}else i+=uo(n[s],n[s+1],o);return st(n[n.length-1])}function xt(e,t,o){if(e!==null)for(var r,n,i,s,c,a,u,y=0,E=0,l,p=e.type,h=p==="FeatureCollection",T=p==="Feature",_=h?e.features.length:1,N=0;N<_;N++){u=h?e.features[N].geometry:T?e.geometry:e,l=u?u.type==="GeometryCollection":!1,c=l?u.geometries.length:1;for(var V=0;V<c;V++){var $=0,L=0;if(s=l?u.geometries[V]:u,s!==null){a=s.coordinates;var F=s.type;switch(y=o&&(F==="Polygon"||F==="MultiPolygon")?1:0,F){case null:break;case"Point":if(t(a,E,N,$,L)===!1)return!1;E++,$++;break;case"LineString":case"MultiPoint":for(r=0;r<a.length;r++){if(t(a[r],E,N,$,L)===!1)return!1;E++,F==="MultiPoint"&&$++}F==="LineString"&&$++;break;case"Polygon":case"MultiLineString":for(r=0;r<a.length;r++){for(n=0;n<a[r].length-y;n++){if(t(a[r][n],E,N,$,L)===!1)return!1;E++}F==="MultiLineString"&&$++,F==="Polygon"&&L++}F==="Polygon"&&$++;break;case"MultiPolygon":for(r=0;r<a.length;r++){for(L=0,n=0;n<a[r].length;n++){for(i=0;i<a[r][n].length-y;i++){if(t(a[r][n][i],E,N,$,L)===!1)return!1;E++}L++}$++}break;case"GeometryCollection":for(r=0;r<s.geometries.length;r++)if(xt(s.geometries[r],t,o)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function Ir(e,t){var o,r,n,i,s,c,a,u,y,E,l=0,p=e.type==="FeatureCollection",h=e.type==="Feature",T=p?e.features.length:1;for(o=0;o<T;o++){for(c=p?e.features[o].geometry:h?e.geometry:e,u=p?e.features[o].properties:h?e.properties:{},y=p?e.features[o].bbox:h?e.bbox:void 0,E=p?e.features[o].id:h?e.id:void 0,a=c?c.type==="GeometryCollection":!1,s=a?c.geometries.length:1,n=0;n<s;n++){if(i=a?c.geometries[n]:c,i===null){if(t(null,l,u,y,E)===!1)return!1;continue}switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(t(i,l,u,y,E)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<i.geometries.length;r++)if(t(i.geometries[r],l,u,y,E)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}l++}}function Mr(e,t){Ir(e,function(o,r,n,i,s){var c=o===null?null:o.type;switch(c){case null:case"Point":case"LineString":case"Polygon":return t(it(o,n,{bbox:i,id:s}),r,0)===!1?!1:void 0}var a;switch(c){case"MultiPoint":a="Point";break;case"MultiLineString":a="LineString";break;case"MultiPolygon":a="Polygon";break}for(var u=0;u<o.coordinates.length;u++){var y=o.coordinates[u],E={type:a,coordinates:y};if(t(it(E,n),r,u)===!1)return!1}})}function Lr(e,t){Mr(e,function(o,r,n){var i=0;if(o.geometry){var s=o.geometry.type;if(!(s==="Point"||s==="MultiPoint")){var c,a=0,u=0,y=0;if(xt(o,function(E,l,p,h,T){if(c===void 0||r>a||h>u||T>y){c=E,a=r,u=h,y=T,i=0;return}var _=Er([c,E],o.properties);if(t(_,r,n,T,i)===!1)return!1;i++,c=E})===!1)return!1}}})}function br(e,t,o){var r=o,n=!1;return Lr(e,function(i,s,c,a,u){n===!1&&o===void 0?r=i:r=t(r,i,s,c,a,u),n=!0}),r}var Ct,Ht;function wr(){return Ht||(Ht=1,Ct=function e(t,o){if(t===o)return!0;if(t&&o&&typeof t=="object"&&typeof o=="object"){if(t.constructor!==o.constructor)return!1;var r,n,i;if(Array.isArray(t)){if(r=t.length,r!=o.length)return!1;for(n=r;n--!==0;)if(!e(t[n],o[n]))return!1;return!0}if(t.constructor===RegExp)return t.source===o.source&&t.flags===o.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===o.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===o.toString();if(i=Object.keys(t),r=i.length,r!==Object.keys(o).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(o,i[n]))return!1;for(n=r;n--!==0;){var s=i[n];if(!e(t[s],o[s]))return!1}return!0}return t!==t&&o!==o}),Ct}var Pr=wr();const Wt=At(Pr);function St(e,t={}){let o=0,r=0,n=0;return xt(e,function(i){o+=i[0],r+=i[1],n++},!0),st([o/n,r/n],t.properties)}function et(e,t={}){return br(e,(o,r)=>{const n=r.geometry.coordinates;return o+uo(n[0],n[1],t)},0)}const Or=({open:e=!1,onClose:t,onSave:o})=>{const[r,n]=x.useState(null),[i,s]=x.useState(!1),[c,a]=x.useState(0),[u,y]=x.useState({date:new Date().toISOString().split("T")[0],file:null}),{enqueueSnackbar:E}=Uo(),l=Ne(L=>L.auth.token),p=Ne(L=>L.project.id);x.useEffect(()=>{e||(n(null),s(!1),a(0),y({date:new Date().toISOString().split("T")[0],file:null}))},[e]);const h=(L,F)=>{y(ne=>({...ne,[L]:F}))},T=L=>{L.length&&(n(L[0]),h("file",L[0]))},{getRootProps:_,getInputProps:N,isDragActive:V}=Qo({onDrop:T,multiple:!1,accept:{"application/zip":[".zip"]}}),$=async()=>{var L,F,ne;if(!u.file){E("Please select a file to upload.",{variant:"warning"});return}s(!0),a(0);try{const te=(await ae.post("/work-day/get-url",{projectId:p,name:u.date,filename:u.file.name,contentType:u.file.type,size:u.file.size},{headers:{Authorization:l}})).data.data;if(console.log(te,"<===== upload response"),!te)throw new Error("Invalid upload response from server");if(te.uploadType==="single"){if(!te.url)throw new Error("Missing upload URL");try{await Go.put(te.url,u.file,{headers:{"Content-Type":u.file.type},onUploadProgress:Z=>{const Ie=Math.round(Z.loaded*100/Z.total);a(Ie)}})}catch(Z){throw console.error("❌ Single upload failed:",Z),new Error("Single upload failed")}}else if(te.uploadType==="multipart"){const{parts:Z,uploadId:Ie,key:ze,partSize:qe}=te,xe=[];let Me=0;for(;Me<u.file.size;){const q=Math.min(Me+qe,u.file.size);xe.push(u.file.slice(Me,q)),Me=q}const be=[];for(let q=0;q<Z.length;q++)try{const Le=await fetch(Z[q].url,{method:"PUT",body:xe[q]});if(!Le.ok)throw new Error(`Chunk ${q+1} upload failed`);const we=(L=Le.headers.get("ETag"))==null?void 0:L.replace(/"/g,"");be.push({PartNumber:Z[q].partNumber,ETag:we}),a(Math.round((q+1)/Z.length*100))}catch(Le){throw console.error("❌ Chunk upload failed:",Le),new Error("Multipart upload failed")}await ae.post("/work-day/complete-upload",{projectId:p,name:u.date,key:ze,uploadId:Ie,parts:be},{headers:{Authorization:l}})}E("Upload successful!",{variant:"success"}),E("Successfully Created Historical Data",{variant:"success"}),o&&o(),t()}catch(X){console.error(X),E(((ne=(F=X==null?void 0:X.response)==null?void 0:F.data)==null?void 0:ne.message)||X.message||"Upload failed.",{variant:"error"})}finally{s(!1),a(0)}};return g.jsx(Bo,{open:e,onClose:t,children:g.jsxs(fe,{sx:{outline:"none",width:400,maxWidth:"90vw",bgcolor:"background.paper",borderRadius:2,boxShadow:24,mx:"auto",mt:"10vh",p:3},children:[g.jsx(Pe,{variant:"h5",sx:{mb:2},children:"Upload New Capture Into Historical Data"}),g.jsxs(fe,{sx:{display:"flex",flexDirection:"column",gap:2},children:[g.jsx(so,{label:"Date of Capture",type:"date",value:u.date,onChange:L=>h("date",L.target.value),fullWidth:!0,size:"small",disabled:i,InputLabelProps:{shrink:!0}}),g.jsxs(fe,{..._(),sx:{border:"2px dashed #ccc",borderRadius:"8px",padding:4,textAlign:"center",cursor:i?"not-allowed":"pointer",backgroundColor:V?"#f0f0f0":"transparent",mb:2,opacity:i?.5:1,pointerEvents:i?"none":"auto"},children:[g.jsx("input",{...N()}),g.jsx(er,{size:32}),g.jsx(Pe,{variant:"h6",gutterBottom:!0,children:"Upload Zip File"}),g.jsx(Pe,{variant:"body2",sx:{mb:2},children:"Drag & drop your .zip file or click below to browse"}),g.jsx(Ge,{variant:"outlined",disabled:i,children:"Browse Files"}),r&&g.jsxs(Pe,{variant:"subtitle1",sx:{mt:1},children:["Selected: ",r.name]})]}),i&&g.jsxs(fe,{children:[g.jsxs(Pe,{variant:"body2",gutterBottom:!0,children:["Uploading... ",c,"%"]}),g.jsx($o,{variant:"determinate",value:c})]}),g.jsxs(fe,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[g.jsx(Ge,{onClick:t,disabled:i,children:"Cancel"}),g.jsx(Ge,{variant:"contained",onClick:$,disabled:!u.file||i,startIcon:i&&g.jsx(ao,{size:16}),children:i?"Uploading...":"Upload"})]})]})]})})},Lt=function(e,t){const o={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},r={on(i,s,c){if(o[i]===void 0)throw new Error(`Invalid event type: ${i}`);o[i].push({selector:s,fn:c})},render(i){t.store.featureChanged(i)}},n=function(i,s){const c=o[i];let a=c.length;for(;a--;){const u=c[a];if(u.selector(s)){u.fn.call(r,s)||t.store.render(),t.ui.updateMapClasses();break}}};return e.start.call(r),{render:e.render,stop(){e.stop&&e.stop()},trash(){e.trash&&(e.trash(),t.store.render())},combineFeatures(){e.combineFeatures&&e.combineFeatures()},uncombineFeatures(){e.uncombineFeatures&&e.uncombineFeatures()},drag(i){n("drag",i)},click(i){n("click",i)},mousemove(i){n("mousemove",i)},mousedown(i){n("mousedown",i)},mouseup(i){n("mouseup",i)},mouseout(i){n("mouseout",i)},keydown(i){n("keydown",i)},keyup(i){n("keyup",i)},touchstart(i){n("touchstart",i)},touchmove(i){n("touchmove",i)},touchend(i){n("touchend",i)},tap(i){n("tap",i)}}},oe={CANVAS:"mapboxgl-canvas",CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},pe={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},G={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},re={POLYGON:"polygon",LINE:"line_string",POINT:"point"},v={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},w={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select"},Q={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},Xe={MOVE:"move",CHANGE_PROPERTIES:"change_properties",CHANGE_COORDINATES:"change_coordinates"},Y={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},z={ACTIVE:"true",INACTIVE:"false"},po=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],Ar=-90,bt=-85,xr=90,wt=85,Nr=-270,Fr=270,fo=Object.freeze(Object.defineProperty({__proto__:null,LAT_MAX:xr,LAT_MIN:Ar,LAT_RENDERED_MAX:wt,LAT_RENDERED_MIN:bt,LNG_MAX:Fr,LNG_MIN:Nr,activeStates:z,classes:oe,cursors:G,events:Q,geojsonTypes:v,interactions:po,meta:Y,modes:w,sources:pe,types:re,updateActions:Xe},Symbol.toStringTag,{value:"Module"})),Yt={Point:0,LineString:1,MultiLineString:1,Polygon:2};function Dr(e,t){const o=Yt[e.geometry.type]-Yt[t.geometry.type];return o===0&&e.geometry.type===v.POLYGON?e.area-t.area:o}function ho(e){return e.map(t=>(t.geometry.type===v.POLYGON&&(t.area=rt.geometry({type:v.FEATURE,property:{},geometry:t.geometry})),t)).sort(Dr).map(t=>(delete t.area,t))}function go(e,t=0){return[[e.point.x-t,e.point.y-t],[e.point.x+t,e.point.y+t]]}function he(e){if(this._items={},this._nums={},this._length=e?e.length:0,!!e)for(let t=0,o=e.length;t<o;t++)this.add(e[t]),e[t]!==void 0&&(typeof e[t]=="string"?this._items[e[t]]=t:this._nums[e[t]]=t)}he.prototype.add=function(e){return this.has(e)?this:(this._length++,typeof e=="string"?this._items[e]=this._length:this._nums[e]=this._length,this)};he.prototype.delete=function(e){return this.has(e)===!1?this:(this._length--,delete this._items[e],delete this._nums[e],this)};he.prototype.has=function(e){return typeof e!="string"&&typeof e!="number"?!1:this._items[e]!==void 0||this._nums[e]!==void 0};he.prototype.values=function(){const e=[];return Object.keys(this._items).forEach(t=>{e.push({k:t,v:this._items[t]})}),Object.keys(this._nums).forEach(t=>{e.push({k:JSON.parse(t),v:this._nums[t]})}),e.sort((t,o)=>t.v-o.v).map(t=>t.k)};he.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};const Rr=[Y.FEATURE,Y.MIDPOINT,Y.VERTEX],Ve={click:kr,touch:Ur};function kr(e,t,o){return yo(e,t,o,o.options.clickBuffer)}function Ur(e,t,o){return yo(e,t,o,o.options.touchBuffer)}function yo(e,t,o,r){if(o.map===null)return[];const n=e?go(e,r):t,i={};o.options.styles&&(i.layers=o.options.styles.map(u=>u.id).filter(u=>o.map.getLayer(u)!=null));const s=o.map.queryRenderedFeatures(n,i).filter(u=>Rr.indexOf(u.properties.meta)!==-1),c=new he,a=[];return s.forEach(u=>{const y=u.properties.id;c.has(y)||(c.add(y),a.push(u))}),ho(a)}function nt(e,t){const o=Ve.click(e,null,t),r={mouse:G.NONE};return o[0]&&(r.mouse=o[0].properties.active===z.ACTIVE?G.MOVE:G.POINTER,r.feature=o[0].properties.meta),t.events.currentModeName().indexOf("draw")!==-1&&(r.mouse=G.ADD),t.ui.queueMapClasses(r),t.ui.updateMapClasses(),o[0]}function Nt(e,t){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)}const Br=4,$r=12,Gr=500;function Pt(e,t,o={}){const r=o.fineTolerance!=null?o.fineTolerance:Br,n=o.grossTolerance!=null?o.grossTolerance:$r,i=o.interval!=null?o.interval:Gr;e.point=e.point||t.point,e.time=e.time||t.time;const s=Nt(e.point,t.point);return s<r||s<n&&t.time-e.time<i}const Vr=25,jr=250;function Ot(e,t,o={}){const r=o.tolerance!=null?o.tolerance:Vr,n=o.interval!=null?o.interval:jr;return e.point=e.point||t.point,e.time=e.time||t.time,Nt(e.point,t.point)<r&&t.time-e.time<n}let zr=(e,t=21)=>(o=t)=>{let r="",n=o|0;for(;n--;)r+=e[Math.random()*e.length|0];return r};const qr=zr("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",32);function Ft(){return qr()}const ee=function(e,t){this.ctx=e,this.properties=t.properties||{},this.coordinates=t.geometry.coordinates,this.id=t.id||Ft(),this.type=t.geometry.type};ee.prototype.changed=function(){this.ctx.store.featureChanged(this.id)};ee.prototype.incomingCoords=function(e){this.setCoordinates(e)};ee.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};ee.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))};ee.prototype.setProperty=function(e,t){this.properties[e]=t};ee.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:v.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))};ee.prototype.internal=function(e){const t={id:this.id,meta:Y.FEATURE,"meta:type":this.type,active:z.INACTIVE,mode:e};if(this.ctx.options.userProperties)for(const o in this.properties)t[`user_${o}`]=this.properties[o];return{type:v.FEATURE,properties:t,geometry:{coordinates:this.getCoordinates(),type:this.type}}};const Ae=function(e,t){ee.call(this,e,t)};Ae.prototype=Object.create(ee.prototype);Ae.prototype.isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"};Ae.prototype.updateCoordinate=function(e,t,o){arguments.length===3?this.coordinates=[t,o]:this.coordinates=[e,t],this.changed()};Ae.prototype.getCoordinate=function(){return this.getCoordinates()};const _e=function(e,t){ee.call(this,e,t)};_e.prototype=Object.create(ee.prototype);_e.prototype.isValid=function(){return this.coordinates.length>1};_e.prototype.addCoordinate=function(e,t,o){this.changed();const r=parseInt(e,10);this.coordinates.splice(r,0,[t,o])};_e.prototype.getCoordinate=function(e){const t=parseInt(e,10);return JSON.parse(JSON.stringify(this.coordinates[t]))};_e.prototype.removeCoordinate=function(e){this.changed(),this.coordinates.splice(parseInt(e,10),1)};_e.prototype.updateCoordinate=function(e,t,o){const r=parseInt(e,10);this.coordinates[r]=[t,o],this.changed()};const le=function(e,t){ee.call(this,e,t),this.coordinates=this.coordinates.map(o=>o.slice(0,-1))};le.prototype=Object.create(ee.prototype);le.prototype.isValid=function(){return this.coordinates.length===0?!1:this.coordinates.every(e=>e.length>2)};le.prototype.incomingCoords=function(e){this.coordinates=e.map(t=>t.slice(0,-1)),this.changed()};le.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};le.prototype.addCoordinate=function(e,t,o){this.changed();const r=e.split(".").map(i=>parseInt(i,10));this.coordinates[r[0]].splice(r[1],0,[t,o])};le.prototype.removeCoordinate=function(e){this.changed();const t=e.split(".").map(r=>parseInt(r,10)),o=this.coordinates[t[0]];o&&(o.splice(t[1],1),o.length<3&&this.coordinates.splice(t[0],1))};le.prototype.getCoordinate=function(e){const t=e.split(".").map(r=>parseInt(r,10)),o=this.coordinates[t[0]];return JSON.parse(JSON.stringify(o[t[1]]))};le.prototype.getCoordinates=function(){return this.coordinates.map(e=>e.concat([e[0]]))};le.prototype.updateCoordinate=function(e,t,o){this.changed();const r=e.split("."),n=parseInt(r[0],10),i=parseInt(r[1],10);this.coordinates[n]===void 0&&(this.coordinates[n]=[]),this.coordinates[n][i]=[t,o]};const Jr={MultiPoint:Ae,MultiLineString:_e,MultiPolygon:le},ut=(e,t,o,r,n)=>{const i=o.split("."),s=parseInt(i[0],10),c=i[1]?i.slice(1).join("."):null;return e[s][t](c,r,n)},K=function(e,t){if(ee.call(this,e,t),delete this.coordinates,this.model=Jr[t.geometry.type],this.model===void 0)throw new TypeError(`${t.geometry.type} is not a valid type`);this.features=this._coordinatesToFeatures(t.geometry.coordinates)};K.prototype=Object.create(ee.prototype);K.prototype._coordinatesToFeatures=function(e){const t=this.model.bind(this);return e.map(o=>new t(this.ctx,{id:Ft(),type:v.FEATURE,properties:{},geometry:{coordinates:o,type:this.type.replace("Multi","")}}))};K.prototype.isValid=function(){return this.features.every(e=>e.isValid())};K.prototype.setCoordinates=function(e){this.features=this._coordinatesToFeatures(e),this.changed()};K.prototype.getCoordinate=function(e){return ut(this.features,"getCoordinate",e)};K.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(e=>e.type===v.POLYGON?e.getCoordinates():e.coordinates)))};K.prototype.updateCoordinate=function(e,t,o){ut(this.features,"updateCoordinate",e,t,o),this.changed()};K.prototype.addCoordinate=function(e,t,o){ut(this.features,"addCoordinate",e,t,o),this.changed()};K.prototype.removeCoordinate=function(e){ut(this.features,"removeCoordinate",e),this.changed()};K.prototype.getFeatures=function(){return this.features};function M(e){this.map=e.map,this.drawConfig=JSON.parse(JSON.stringify(e.options||{})),this._ctx=e}M.prototype.setSelected=function(e){return this._ctx.store.setSelected(e)};M.prototype.setSelectedCoordinates=function(e){this._ctx.store.setSelectedCoordinates(e),e.reduce((t,o)=>(t[o.feature_id]===void 0&&(t[o.feature_id]=!0,this._ctx.store.get(o.feature_id).changed()),t),{})};M.prototype.getSelected=function(){return this._ctx.store.getSelected()};M.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()};M.prototype.isSelected=function(e){return this._ctx.store.isSelected(e)};M.prototype.getFeature=function(e){return this._ctx.store.get(e)};M.prototype.select=function(e){return this._ctx.store.select(e)};M.prototype.deselect=function(e){return this._ctx.store.deselect(e)};M.prototype.deleteFeature=function(e,t={}){return this._ctx.store.delete(e,t)};M.prototype.addFeature=function(e,t={}){return this._ctx.store.add(e,t)};M.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()};M.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()};M.prototype.setActionableState=function(e={}){const t={trash:e.trash||!1,combineFeatures:e.combineFeatures||!1,uncombineFeatures:e.uncombineFeatures||!1};return this._ctx.events.actionable(t)};M.prototype.changeMode=function(e,t={},o={}){return this._ctx.events.changeMode(e,t,o)};M.prototype.fire=function(e,t){return this._ctx.events.fire(e,t)};M.prototype.updateUIClasses=function(e){return this._ctx.ui.queueMapClasses(e)};M.prototype.activateUIButton=function(e){return this._ctx.ui.setActiveButton(e)};M.prototype.featuresAt=function(e,t,o="click"){if(o!=="click"&&o!=="touch")throw new Error("invalid buffer type");return Ve[o](e,t,this._ctx)};M.prototype.newFeature=function(e){const t=e.geometry.type;return t===v.POINT?new Ae(this._ctx,e):t===v.LINE_STRING?new _e(this._ctx,e):t===v.POLYGON?new le(this._ctx,e):new K(this._ctx,e)};M.prototype.isInstanceOf=function(e,t){if(e===v.POINT)return t instanceof Ae;if(e===v.LINE_STRING)return t instanceof _e;if(e===v.POLYGON)return t instanceof le;if(e==="MultiFeature")return t instanceof K;throw new Error(`Unknown feature class: ${e}`)};M.prototype.doRender=function(e){return this._ctx.store.featureChanged(e)};M.prototype.onSetup=function(){};M.prototype.onDrag=function(){};M.prototype.onClick=function(){};M.prototype.onMouseMove=function(){};M.prototype.onMouseDown=function(){};M.prototype.onMouseUp=function(){};M.prototype.onMouseOut=function(){};M.prototype.onKeyUp=function(){};M.prototype.onKeyDown=function(){};M.prototype.onTouchStart=function(){};M.prototype.onTouchMove=function(){};M.prototype.onTouchEnd=function(){};M.prototype.onTap=function(){};M.prototype.onStop=function(){};M.prototype.onTrash=function(){};M.prototype.onCombineFeature=function(){};M.prototype.onUncombineFeature=function(){};M.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};const mo={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},Hr=Object.keys(mo);function Wr(e){const t=Object.keys(e);return function(o,r={}){let n={};const i=t.reduce((c,a)=>(c[a]=e[a],c),new M(o));function s(c){return a=>i[c](n,a)}return{start(){n=i.onSetup(r),Hr.forEach(c=>{const a=mo[c];let u=()=>!1;e[a]&&(u=()=>!0),this.on(c,u,s(a))})},stop(){i.onStop(n)},trash(){i.onTrash(n)},combineFeatures(){i.onCombineFeatures(n)},uncombineFeatures(){i.onUncombineFeatures(n)},render(c,a){i.toDisplayFeatures(n,c,a)}}}}function Yr(e){const t=Object.keys(e.options.modes).reduce((l,p)=>(l[p]=Wr(e.options.modes[p]),l),{});let o={},r={};const n={};let i=null,s=null;n.drag=function(l,p){p({point:l.point,time:new Date().getTime()})?(e.ui.queueMapClasses({mouse:G.DRAG}),s.drag(l)):l.originalEvent.stopPropagation()},n.mousedrag=function(l){n.drag(l,p=>!Pt(o,p))},n.touchdrag=function(l){n.drag(l,p=>!Ot(r,p))},n.mousemove=function(l){if((l.originalEvent.buttons!==void 0?l.originalEvent.buttons:l.originalEvent.which)===1)return n.mousedrag(l);const h=nt(l,e);l.featureTarget=h,s.mousemove(l)},n.mousedown=function(l){o={time:new Date().getTime(),point:l.point};const p=nt(l,e);l.featureTarget=p,s.mousedown(l)},n.mouseup=function(l){const p=nt(l,e);l.featureTarget=p,Pt(o,{point:l.point,time:new Date().getTime()})?s.click(l):s.mouseup(l)},n.mouseout=function(l){s.mouseout(l)},n.touchstart=function(l){if(!e.options.touchEnabled)return;r={time:new Date().getTime(),point:l.point};const p=Ve.touch(l,null,e)[0];l.featureTarget=p,s.touchstart(l)},n.touchmove=function(l){if(e.options.touchEnabled)return s.touchmove(l),n.touchdrag(l)},n.touchend=function(l){if(l.originalEvent.preventDefault(),!e.options.touchEnabled)return;const p=Ve.touch(l,null,e)[0];l.featureTarget=p,Ot(r,{time:new Date().getTime(),point:l.point})?s.tap(l):s.touchend(l)};const c=l=>!(l===8||l===46||l>=48&&l<=57);n.keydown=function(l){(l.srcElement||l.target).classList.contains(oe.CANVAS)&&((l.keyCode===8||l.keyCode===46)&&e.options.controls.trash?(l.preventDefault(),s.trash()):c(l.keyCode)?s.keydown(l):l.keyCode===49&&e.options.controls.point?a(w.DRAW_POINT):l.keyCode===50&&e.options.controls.line_string?a(w.DRAW_LINE_STRING):l.keyCode===51&&e.options.controls.polygon&&a(w.DRAW_POLYGON))},n.keyup=function(l){c(l.keyCode)&&s.keyup(l)},n.zoomend=function(){e.store.changeZoom()},n.data=function(l){if(l.dataType==="style"){const{setup:p,map:h,options:T,store:_}=e;T.styles.some(V=>h.getLayer(V.id))||(p.addLayers(),_.setDirty(),_.render())}};function a(l,p,h={}){s.stop();const T=t[l];if(T===void 0)throw new Error(`${l} is not valid`);i=l;const _=T(e,p);s=Lt(_,e),h.silent||e.map.fire(Q.MODE_CHANGE,{mode:l}),e.store.setDirty(),e.store.render()}const u={trash:!1,combineFeatures:!1,uncombineFeatures:!1};function y(l){let p=!1;Object.keys(l).forEach(h=>{if(u[h]===void 0)throw new Error("Invalid action type");u[h]!==l[h]&&(p=!0),u[h]=l[h]}),p&&e.map.fire(Q.ACTIONABLE,{actions:u})}return{start(){i=e.options.defaultMode,s=Lt(t[i](e),e)},changeMode:a,actionable:y,currentModeName(){return i},currentModeRender(l,p){return s.render(l,p)},fire(l,p){e.map&&e.map.fire(l,p)},addEventListeners(){e.map.on("mousemove",n.mousemove),e.map.on("mousedown",n.mousedown),e.map.on("mouseup",n.mouseup),e.map.on("data",n.data),e.map.on("touchmove",n.touchmove),e.map.on("touchstart",n.touchstart),e.map.on("touchend",n.touchend),e.container.addEventListener("mouseout",n.mouseout),e.options.keybindings&&(e.container.addEventListener("keydown",n.keydown),e.container.addEventListener("keyup",n.keyup))},removeEventListeners(){e.map.off("mousemove",n.mousemove),e.map.off("mousedown",n.mousedown),e.map.off("mouseup",n.mouseup),e.map.off("data",n.data),e.map.off("touchmove",n.touchmove),e.map.off("touchstart",n.touchstart),e.map.off("touchend",n.touchend),e.container.removeEventListener("mouseout",n.mouseout),e.options.keybindings&&(e.container.removeEventListener("keydown",n.keydown),e.container.removeEventListener("keyup",n.keyup))},trash(l){s.trash(l)},combineFeatures(){s.combineFeatures()},uncombineFeatures(){s.uncombineFeatures()},getMode(){return i}}}function Ze(e){return[].concat(e).filter(t=>t!==void 0)}function Xr(){const e=this;if(!(e.ctx.map&&e.ctx.map.getSource(pe.HOT)!==void 0))return a();const o=e.ctx.events.currentModeName();e.ctx.ui.queueMapClasses({mode:o});let r=[],n=[];e.isDirty?n=e.getAllIds():(r=e.getChangedIds().filter(u=>e.get(u)!==void 0),n=e.sources.hot.filter(u=>u.properties.id&&r.indexOf(u.properties.id)===-1&&e.get(u.properties.id)!==void 0).map(u=>u.properties.id)),e.sources.hot=[];const i=e.sources.cold.length;e.sources.cold=e.isDirty?[]:e.sources.cold.filter(u=>{const y=u.properties.id||u.properties.parent;return r.indexOf(y)===-1});const s=i!==e.sources.cold.length||n.length>0;r.forEach(u=>c(u,"hot")),n.forEach(u=>c(u,"cold"));function c(u,y){const l=e.get(u).internal(o);e.ctx.events.currentModeRender(l,p=>{p.properties.mode=o,e.sources[y].push(p)})}s&&e.ctx.map.getSource(pe.COLD).setData({type:v.FEATURE_COLLECTION,features:e.sources.cold}),e.ctx.map.getSource(pe.HOT).setData({type:v.FEATURE_COLLECTION,features:e.sources.hot}),a();function a(){e.isDirty=!1,e.clearChangedIds()}}function B(e){this._features={},this._featureIds=new he,this._selectedFeatureIds=new he,this._selectedCoordinates=[],this._changedFeatureIds=new he,this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=e,this.sources={hot:[],cold:[]};let t;this.render=()=>{t||(t=requestAnimationFrame(()=>{t=null,Xr.call(this),this._emitSelectionChange&&(this.ctx.events.fire(Q.SELECTION_CHANGE,{features:this.getSelected().map(o=>o.toGeoJSON()),points:this.getSelectedCoordinates().map(o=>({type:v.FEATURE,properties:{},geometry:{type:v.POINT,coordinates:o.coordinates}}))}),this._emitSelectionChange=!1),this.ctx.events.fire(Q.RENDER,{})}))},this.isDirty=!1}B.prototype.createRenderBatch=function(){const e=this.render;let t=0;return this.render=function(){t++},()=>{this.render=e,t>0&&this.render()}};B.prototype.setDirty=function(){return this.isDirty=!0,this};B.prototype.featureCreated=function(e,t={}){if(this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0){const r=this.get(e);this.ctx.events.fire(Q.CREATE,{features:[r.toGeoJSON()]})}return this};B.prototype.featureChanged=function(e,t={}){return this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0&&this.ctx.events.fire(Q.UPDATE,{action:t.action?t.action:Xe.CHANGE_COORDINATES,features:[this.get(e).toGeoJSON()]}),this};B.prototype.getChangedIds=function(){return this._changedFeatureIds.values()};B.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this};B.prototype.getAllIds=function(){return this._featureIds.values()};B.prototype.add=function(e,t={}){return this._features[e.id]=e,this._featureIds.add(e.id),this.featureCreated(e.id,{silent:t.silent}),this};B.prototype.delete=function(e,t={}){const o=[];return Ze(e).forEach(r=>{this._featureIds.has(r)&&(this._featureIds.delete(r),this._selectedFeatureIds.delete(r),t.silent||o.indexOf(this._features[r])===-1&&o.push(this._features[r].toGeoJSON()),delete this._features[r],this.isDirty=!0)}),o.length&&this.ctx.events.fire(Q.DELETE,{features:o}),Eo(this,t),this};B.prototype.get=function(e){return this._features[e]};B.prototype.getAll=function(){return Object.keys(this._features).map(e=>this._features[e])};B.prototype.select=function(e,t={}){return Ze(e).forEach(o=>{this._selectedFeatureIds.has(o)||(this._selectedFeatureIds.add(o),this._changedFeatureIds.add(o),t.silent||(this._emitSelectionChange=!0))}),this};B.prototype.deselect=function(e,t={}){return Ze(e).forEach(o=>{this._selectedFeatureIds.has(o)&&(this._selectedFeatureIds.delete(o),this._changedFeatureIds.add(o),t.silent||(this._emitSelectionChange=!0))}),Eo(this,t),this};B.prototype.clearSelected=function(e={}){return this.deselect(this._selectedFeatureIds.values(),{silent:e.silent}),this};B.prototype.setSelected=function(e,t={}){return e=Ze(e),this.deselect(this._selectedFeatureIds.values().filter(o=>e.indexOf(o)===-1),{silent:t.silent}),this.select(e.filter(o=>!this._selectedFeatureIds.has(o)),{silent:t.silent}),this};B.prototype.setSelectedCoordinates=function(e){return this._selectedCoordinates=e,this._emitSelectionChange=!0,this};B.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this};B.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()};B.prototype.getSelected=function(){return this.getSelectedIds().map(e=>this.get(e))};B.prototype.getSelectedCoordinates=function(){return this._selectedCoordinates.map(t=>({coordinates:this.get(t.feature_id).getCoordinate(t.coord_path)}))};B.prototype.isSelected=function(e){return this._selectedFeatureIds.has(e)};B.prototype.setFeatureProperty=function(e,t,o,r={}){this.get(e).setProperty(t,o),this.featureChanged(e,{silent:r.silent,action:Xe.CHANGE_PROPERTIES})};function Eo(e,t={}){const o=e._selectedCoordinates.filter(r=>e._selectedFeatureIds.has(r.feature_id));e._selectedCoordinates.length!==o.length&&!t.silent&&(e._emitSelectionChange=!0),e._selectedCoordinates=o}B.prototype.storeMapConfig=function(){po.forEach(e=>{this.ctx.map[e]&&(this._mapInitialConfig[e]=this.ctx.map[e].isEnabled())})};B.prototype.restoreMapConfig=function(){Object.keys(this._mapInitialConfig).forEach(e=>{this._mapInitialConfig[e]?this.ctx.map[e].enable():this.ctx.map[e].disable()})};B.prototype.getInitialConfigValue=function(e){return this._mapInitialConfig[e]!==void 0?this._mapInitialConfig[e]:!0};const Zr=["mode","feature","mouse"];function Kr(e){const t={};let o=null,r={mode:null,feature:null,mouse:null},n={mode:null,feature:null,mouse:null};function i(){s({mode:null,feature:null,mouse:null}),c()}function s(p){n=Object.assign(n,p)}function c(){if(!e.container)return;const p=[],h=[];Zr.forEach(T=>{n[T]!==r[T]&&(p.push(`${T}-${r[T]}`),n[T]!==null&&h.push(`${T}-${n[T]}`))}),p.length>0&&e.container.classList.remove(...p),h.length>0&&e.container.classList.add(...h),r=Object.assign(r,n)}function a(p,h={}){const T=document.createElement("button");return T.className=`${oe.CONTROL_BUTTON} ${h.className}`,T.setAttribute("title",h.title),h.container.appendChild(T),T.addEventListener("click",_=>{if(_.preventDefault(),_.stopPropagation(),_.target===o){u(),h.onDeactivate();return}y(p),h.onActivate()},!0),T}function u(){o&&(o.classList.remove(oe.ACTIVE_BUTTON),o=null)}function y(p){u();const h=t[p];h&&h&&p!=="trash"&&(h.classList.add(oe.ACTIVE_BUTTON),o=h)}function E(){const p=e.options.controls,h=document.createElement("div");return h.className=`${oe.CONTROL_GROUP} ${oe.CONTROL_BASE}`,p&&(p[re.LINE]&&(t[re.LINE]=a(re.LINE,{container:h,className:oe.CONTROL_BUTTON_LINE,title:`LineString tool ${e.options.keybindings?"(l)":""}`,onActivate:()=>e.events.changeMode(w.DRAW_LINE_STRING),onDeactivate:()=>e.events.trash()})),p[re.POLYGON]&&(t[re.POLYGON]=a(re.POLYGON,{container:h,className:oe.CONTROL_BUTTON_POLYGON,title:`Polygon tool ${e.options.keybindings?"(p)":""}`,onActivate:()=>e.events.changeMode(w.DRAW_POLYGON),onDeactivate:()=>e.events.trash()})),p[re.POINT]&&(t[re.POINT]=a(re.POINT,{container:h,className:oe.CONTROL_BUTTON_POINT,title:`Marker tool ${e.options.keybindings?"(m)":""}`,onActivate:()=>e.events.changeMode(w.DRAW_POINT),onDeactivate:()=>e.events.trash()})),p.trash&&(t.trash=a("trash",{container:h,className:oe.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:()=>{e.events.trash()}})),p.combine_features&&(t.combine_features=a("combineFeatures",{container:h,className:oe.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:()=>{e.events.combineFeatures()}})),p.uncombine_features&&(t.uncombine_features=a("uncombineFeatures",{container:h,className:oe.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:()=>{e.events.uncombineFeatures()}}))),h}function l(){Object.keys(t).forEach(p=>{const h=t[p];h.parentNode&&h.parentNode.removeChild(h),delete t[p]})}return{setActiveButton:y,queueMapClasses:s,updateMapClasses:c,clearMapClasses:i,addButtons:E,removeButtons:l}}function Qr(e){let t=null,o=null;const r={onRemove(){return e.map.off("load",r.connect),clearInterval(o),r.removeLayers(),e.store.restoreMapConfig(),e.ui.removeButtons(),e.events.removeEventListeners(),e.ui.clearMapClasses(),e.boxZoomInitial&&e.map.boxZoom.enable(),e.map=null,e.container=null,e.store=null,t&&t.parentNode&&t.parentNode.removeChild(t),t=null,this},connect(){e.map.off("load",r.connect),clearInterval(o),r.addLayers(),e.store.storeMapConfig(),e.events.addEventListeners()},onAdd(n){if(e.map=n,e.events=Yr(e),e.ui=Kr(e),e.container=n.getContainer(),e.store=new B(e),t=e.ui.addButtons(),e.options.boxSelect){e.boxZoomInitial=n.boxZoom.isEnabled(),n.boxZoom.disable();const i=n.dragPan.isEnabled();n.dragPan.disable(),n.dragPan.enable(),i||n.dragPan.disable()}return n.loaded()?r.connect():(n.on("load",r.connect),o=setInterval(()=>{n.loaded()&&r.connect()},16)),e.events.start(),t},addLayers(){e.map.addSource(pe.COLD,{data:{type:v.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.map.addSource(pe.HOT,{data:{type:v.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.options.styles.forEach(n=>{e.map.addLayer(n)}),e.store.setDirty(!0),e.store.render()},removeLayers(){e.options.styles.forEach(n=>{e.map.getLayer(n.id)&&e.map.removeLayer(n.id)}),e.map.getSource(pe.COLD)&&e.map.removeSource(pe.COLD),e.map.getSource(pe.HOT)&&e.map.removeSource(pe.HOT)}};return e.setup=r,r}const Tt="#3bb2d0",He="#fbb03b",Xt="#fff",vo=[{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"]],paint:{"fill-color":["case",["==",["get","active"],"true"],He,Tt],"fill-opacity":.1}},{id:"gl-draw-lines",type:"line",filter:["any",["==","$type","LineString"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["case",["==",["get","active"],"true"],He,Tt],"line-dasharray":["case",["==",["get","active"],"true"],[.2,2],[2,0]],"line-width":2}},{id:"gl-draw-point-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Xt}},{id:"gl-draw-point-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":["case",["==",["get","active"],"true"],He,Tt]}},{id:"gl-draw-vertex-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Xt}},{id:"gl-draw-vertex-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":He}},{id:"gl-draw-midpoint",type:"circle",filter:["all",["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":He}}];function dt(e){return function(t){const o=t.featureTarget;return!o||!o.properties?!1:o.properties.meta===e}}function Co(e){return!e.originalEvent||!e.originalEvent.shiftKey?!1:e.originalEvent.button===0}function Fe(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===z.ACTIVE&&e.featureTarget.properties.meta===Y.FEATURE}function Dt(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===z.INACTIVE&&e.featureTarget.properties.meta===Y.FEATURE}function pt(e){return e.featureTarget===void 0}function Rt(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.meta===Y.FEATURE}function Ke(e){const t=e.featureTarget;return!t||!t.properties?!1:t.properties.meta===Y.VERTEX}function at(e){return e.originalEvent?e.originalEvent.shiftKey===!0:!1}function ft(e){return e.keyCode===27}function ht(e){return e.keyCode===13}function en(){return!0}const tn=Object.freeze(Object.defineProperty({__proto__:null,isActiveFeature:Fe,isEnterKey:ht,isEscapeKey:ft,isFeature:Rt,isInactiveFeature:Dt,isOfMetaType:dt,isShiftDown:at,isShiftMousedown:Co,isTrue:en,isVertex:Ke,noTarget:pt},Symbol.toStringTag,{value:"Module"}));function Oe(e,t){this.x=e,this.y=t}Oe.prototype={clone(){return new Oe(this.x,this.y)},add(e){return this.clone()._add(e)},sub(e){return this.clone()._sub(e)},multByPoint(e){return this.clone()._multByPoint(e)},divByPoint(e){return this.clone()._divByPoint(e)},mult(e){return this.clone()._mult(e)},div(e){return this.clone()._div(e)},rotate(e){return this.clone()._rotate(e)},rotateAround(e,t){return this.clone()._rotateAround(e,t)},matMult(e){return this.clone()._matMult(e)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(e){return this.x===e.x&&this.y===e.y},dist(e){return Math.sqrt(this.distSqr(e))},distSqr(e){const t=e.x-this.x,o=e.y-this.y;return t*t+o*o},angle(){return Math.atan2(this.y,this.x)},angleTo(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith(e){return this.angleWithSep(e.x,e.y)},angleWithSep(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult(e){const t=e[0]*this.x+e[1]*this.y,o=e[2]*this.x+e[3]*this.y;return this.x=t,this.y=o,this},_add(e){return this.x+=e.x,this.y+=e.y,this},_sub(e){return this.x-=e.x,this.y-=e.y,this},_mult(e){return this.x*=e,this.y*=e,this},_div(e){return this.x/=e,this.y/=e,this},_multByPoint(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint(e){return this.x/=e.x,this.y/=e.y,this},_unit(){return this._div(this.mag()),this},_perp(){const e=this.y;return this.y=this.x,this.x=-e,this},_rotate(e){const t=Math.cos(e),o=Math.sin(e),r=t*this.x-o*this.y,n=o*this.x+t*this.y;return this.x=r,this.y=n,this},_rotateAround(e,t){const o=Math.cos(e),r=Math.sin(e),n=t.x+o*(this.x-t.x)-r*(this.y-t.y),i=t.y+r*(this.x-t.x)+o*(this.y-t.y);return this.x=n,this.y=i,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Oe};Oe.convert=function(e){if(e instanceof Oe)return e;if(Array.isArray(e))return new Oe(+e[0],+e[1]);if(e.x!==void 0&&e.y!==void 0)return new Oe(+e.x,+e.y);throw new Error("Expected [x, y] or {x, y} point format")};function kt(e,t){const o=t.getBoundingClientRect();return new Oe(e.clientX-o.left-(t.clientLeft||0),e.clientY-o.top-(t.clientTop||0))}function je(e,t,o,r){return{type:v.FEATURE,properties:{meta:Y.VERTEX,parent:e,coord_path:o,active:r?z.ACTIVE:z.INACTIVE},geometry:{type:v.POINT,coordinates:t}}}function So(e,t,o){const r=t.geometry.coordinates,n=o.geometry.coordinates;if(r[1]>wt||r[1]<bt||n[1]>wt||n[1]<bt)return null;const i={lng:(r[0]+n[0])/2,lat:(r[1]+n[1])/2};return{type:v.FEATURE,properties:{meta:Y.MIDPOINT,parent:e,lng:i.lng,lat:i.lat,coord_path:o.properties.coord_path},geometry:{type:v.POINT,coordinates:[i.lng,i.lat]}}}function gt(e,t={},o=null){const{type:r,coordinates:n}=e.geometry,i=e.properties&&e.properties.id;let s=[];r===v.POINT?s.push(je(i,n,o,a(o))):r===v.POLYGON?n.forEach((y,E)=>{c(y,o!==null?`${o}.${E}`:String(E))}):r===v.LINE_STRING?c(n,o):r.indexOf(v.MULTI_PREFIX)===0&&u();function c(y,E){let l="",p=null;y.forEach((h,T)=>{const _=E!=null?`${E}.${T}`:String(T),N=je(i,h,_,a(_));if(t.midpoints&&p){const $=So(i,p,N);$&&s.push($)}p=N;const V=JSON.stringify(h);l!==V&&s.push(N),T===0&&(l=V)})}function a(y){return t.selectedPaths?t.selectedPaths.indexOf(y)!==-1:!1}function u(){const y=r.replace(v.MULTI_PREFIX,"");n.forEach((E,l)=>{const p={type:v.FEATURE,properties:e.properties,geometry:{type:y,coordinates:E}};s=s.concat(gt(p,t,l))})}return s}const me={enable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||!e._ctx||!e._ctx.store||!e._ctx.store.getInitialConfigValue||e._ctx.store.getInitialConfigValue("doubleClickZoom")&&e.map.doubleClickZoom.enable()},0)},disable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||e.map.doubleClickZoom.disable()},0)}},{LAT_MIN:tt,LAT_MAX:ot,LAT_RENDERED_MIN:Zt,LAT_RENDERED_MAX:Kt,LNG_MIN:Qt,LNG_MAX:eo}=fo;function on(e){const t={Point:0,LineString:1,Polygon:2,MultiPoint:1,MultiLineString:2,MultiPolygon:3}[e.geometry.type],o=[e.geometry.coordinates].flat(t),r=o.map(c=>c[0]),n=o.map(c=>c[1]),i=c=>Math.min.apply(null,c),s=c=>Math.max.apply(null,c);return[i(r),i(n),s(r),s(n)]}function Ut(e,t){let o=tt,r=ot,n=tt,i=ot,s=eo,c=Qt;e.forEach(u=>{const y=on(u),E=y[1],l=y[3],p=y[0],h=y[2];E>o&&(o=E),l<r&&(r=l),l>n&&(n=l),E<i&&(i=E),p<s&&(s=p),h>c&&(c=h)});const a=t;return o+a.lat>Kt&&(a.lat=Kt-o),n+a.lat>ot&&(a.lat=ot-n),r+a.lat<Zt&&(a.lat=Zt-r),i+a.lat<tt&&(a.lat=tt-i),s+a.lng<=Qt&&(a.lng+=Math.ceil(Math.abs(a.lng)/360)*360),c+a.lng>=eo&&(a.lng-=Math.ceil(Math.abs(a.lng)/360)*360),a}function Bt(e,t){const o=Ut(e.map(r=>r.toGeoJSON()),t);e.forEach(r=>{const n=r.getCoordinates(),i=u=>{const y={lng:u[0]+o.lng,lat:u[1]+o.lat};return[y.lng,y.lat]},s=u=>u.map(y=>i(y)),c=u=>u.map(y=>s(y));let a;r.type===v.POINT?a=i(n):r.type===v.LINE_STRING||r.type===v.MULTI_POINT?a=n.map(i):r.type===v.POLYGON||r.type===v.MULTI_LINE_STRING?a=n.map(s):r.type===v.MULTI_POLYGON&&(a=n.map(c)),r.incomingCoords(a)})}const R={};R.onSetup=function(e){const t={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initialDragPanState:this.map.dragPan.isEnabled(),initiallySelectedFeatureIds:e.featureIds||[]};return this.setSelected(t.initiallySelectedFeatureIds.filter(o=>this.getFeature(o)!==void 0)),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),t};R.fireUpdate=function(){this.fire(Q.UPDATE,{action:Xe.MOVE,features:this.getSelected().map(e=>e.toGeoJSON())})};R.fireActionable=function(){const e=this.getSelected(),t=e.filter(i=>this.isInstanceOf("MultiFeature",i));let o=!1;if(e.length>1){o=!0;const i=e[0].type.replace("Multi","");e.forEach(s=>{s.type.replace("Multi","")!==i&&(o=!1)})}const r=t.length>0,n=e.length>0;this.setActionableState({combineFeatures:o,uncombineFeatures:r,trash:n})};R.getUniqueIds=function(e){return e.length?e.map(o=>o.properties.id).filter(o=>o!==void 0).reduce((o,r)=>(o.add(r),o),new he).values():[]};R.stopExtendedInteractions=function(e){e.boxSelectElement&&(e.boxSelectElement.parentNode&&e.boxSelectElement.parentNode.removeChild(e.boxSelectElement),e.boxSelectElement=null),(e.canDragMove||e.canBoxSelect)&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.boxSelecting=!1,e.canBoxSelect=!1,e.dragMoving=!1,e.canDragMove=!1};R.onStop=function(){me.enable(this)};R.onMouseMove=function(e,t){return Rt(t)&&e.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(e),!0};R.onMouseOut=function(e){return e.dragMoving?this.fireUpdate():!0};R.onTap=R.onClick=function(e,t){if(pt(t))return this.clickAnywhere(e,t);if(dt(Y.VERTEX)(t))return this.clickOnVertex(e,t);if(Rt(t))return this.clickOnFeature(e,t)};R.clickAnywhere=function(e){const t=this.getSelectedIds();t.length&&(this.clearSelectedFeatures(),t.forEach(o=>this.doRender(o))),me.enable(this),this.stopExtendedInteractions(e)};R.clickOnVertex=function(e,t){this.changeMode(w.DIRECT_SELECT,{featureId:t.featureTarget.properties.parent,coordPath:t.featureTarget.properties.coord_path,startPos:t.lngLat}),this.updateUIClasses({mouse:G.MOVE})};R.startOnActiveFeature=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),this.doRender(t.featureTarget.properties.id),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};R.clickOnFeature=function(e,t){me.disable(this),this.stopExtendedInteractions(e);const o=at(t),r=this.getSelectedIds(),n=t.featureTarget.properties.id,i=this.isSelected(n);if(!o&&i&&this.getFeature(n).type!==v.POINT)return this.changeMode(w.DIRECT_SELECT,{featureId:n});i&&o?(this.deselect(n),this.updateUIClasses({mouse:G.POINTER}),r.length===1&&me.enable(this)):!i&&o?(this.select(n),this.updateUIClasses({mouse:G.MOVE})):!i&&!o&&(r.forEach(s=>this.doRender(s)),this.setSelected(n),this.updateUIClasses({mouse:G.MOVE})),this.doRender(n)};R.onMouseDown=function(e,t){if(e.initialDragPanState=this.map.dragPan.isEnabled(),Fe(t))return this.startOnActiveFeature(e,t);if(this.drawConfig.boxSelect&&Co(t))return this.startBoxSelect(e,t)};R.startBoxSelect=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),e.boxSelectStartLocation=kt(t.originalEvent,this.map.getContainer()),e.canBoxSelect=!0};R.onTouchStart=function(e,t){if(Fe(t))return this.startOnActiveFeature(e,t)};R.onDrag=function(e,t){if(e.canDragMove)return this.dragMove(e,t);if(this.drawConfig.boxSelect&&e.canBoxSelect)return this.whileBoxSelect(e,t)};R.whileBoxSelect=function(e,t){e.boxSelecting=!0,this.updateUIClasses({mouse:G.ADD}),e.boxSelectElement||(e.boxSelectElement=document.createElement("div"),e.boxSelectElement.classList.add(oe.BOX_SELECT),this.map.getContainer().appendChild(e.boxSelectElement));const o=kt(t.originalEvent,this.map.getContainer()),r=Math.min(e.boxSelectStartLocation.x,o.x),n=Math.max(e.boxSelectStartLocation.x,o.x),i=Math.min(e.boxSelectStartLocation.y,o.y),s=Math.max(e.boxSelectStartLocation.y,o.y),c=`translate(${r}px, ${i}px)`;e.boxSelectElement.style.transform=c,e.boxSelectElement.style.WebkitTransform=c,e.boxSelectElement.style.width=`${n-r}px`,e.boxSelectElement.style.height=`${s-i}px`};R.dragMove=function(e,t){e.dragMoving=!0,t.originalEvent.stopPropagation();const o={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};Bt(this.getSelected(),o),e.dragMoveLocation=t.lngLat};R.onTouchEnd=R.onMouseUp=function(e,t){if(e.dragMoving)this.fireUpdate();else if(e.boxSelecting){const o=[e.boxSelectStartLocation,kt(t.originalEvent,this.map.getContainer())],r=this.featuresAt(null,o,"click"),n=this.getUniqueIds(r).filter(i=>!this.isSelected(i));n.length&&(this.select(n),n.forEach(i=>this.doRender(i)),this.updateUIClasses({mouse:G.MOVE}))}this.stopExtendedInteractions(e)};R.toDisplayFeatures=function(e,t,o){t.properties.active=this.isSelected(t.properties.id)?z.ACTIVE:z.INACTIVE,o(t),this.fireActionable(),!(t.properties.active!==z.ACTIVE||t.geometry.type===v.POINT)&&gt(t).forEach(o)};R.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()};R.onCombineFeatures=function(){const e=this.getSelected();if(e.length===0||e.length<2)return;const t=[],o=[],r=e[0].type.replace("Multi","");for(let n=0;n<e.length;n++){const i=e[n];if(i.type.replace("Multi","")!==r)return;i.type.includes("Multi")?i.getCoordinates().forEach(s=>{t.push(s)}):t.push(i.getCoordinates()),o.push(i.toGeoJSON())}if(o.length>1){const n=this.newFeature({type:v.FEATURE,properties:o[0].properties,geometry:{type:`Multi${r}`,coordinates:t}});this.addFeature(n),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([n.id]),this.fire(Q.COMBINE_FEATURES,{createdFeatures:[n.toGeoJSON()],deletedFeatures:o})}this.fireActionable()};R.onUncombineFeatures=function(){const e=this.getSelected();if(e.length===0)return;const t=[],o=[];for(let r=0;r<e.length;r++){const n=e[r];this.isInstanceOf("MultiFeature",n)&&(n.getFeatures().forEach(i=>{this.addFeature(i),i.properties=n.properties,t.push(i.toGeoJSON()),this.select([i.id])}),this.deleteFeature(n.id,{silent:!0}),o.push(n.toGeoJSON()))}t.length>1&&this.fire(Q.UNCOMBINE_FEATURES,{createdFeatures:t,deletedFeatures:o}),this.fireActionable()};const To=dt(Y.VERTEX),_o=dt(Y.MIDPOINT),k={};k.fireUpdate=function(){this.fire(Q.UPDATE,{action:Xe.CHANGE_COORDINATES,features:this.getSelected().map(e=>e.toGeoJSON())})};k.fireActionable=function(e){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:e.selectedCoordPaths.length>0})};k.startDragging=function(e,t){e.initialDragPanState=this.map.dragPan.isEnabled(),this.map.dragPan.disable(),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};k.stopDragging=function(e){e.canDragMove&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.dragMoving=!1,e.canDragMove=!1,e.dragMoveLocation=null};k.onVertex=function(e,t){this.startDragging(e,t);const o=t.featureTarget.properties,r=e.selectedCoordPaths.indexOf(o.coord_path);!at(t)&&r===-1?e.selectedCoordPaths=[o.coord_path]:at(t)&&r===-1&&e.selectedCoordPaths.push(o.coord_path);const n=this.pathsToCoordinates(e.featureId,e.selectedCoordPaths);this.setSelectedCoordinates(n)};k.onMidpoint=function(e,t){this.startDragging(e,t);const o=t.featureTarget.properties;e.feature.addCoordinate(o.coord_path,o.lng,o.lat),this.fireUpdate(),e.selectedCoordPaths=[o.coord_path]};k.pathsToCoordinates=function(e,t){return t.map(o=>({feature_id:e,coord_path:o}))};k.onFeature=function(e,t){e.selectedCoordPaths.length===0?this.startDragging(e,t):this.stopDragging(e)};k.dragFeature=function(e,t,o){Bt(this.getSelected(),o),e.dragMoveLocation=t.lngLat};k.dragVertex=function(e,t,o){const r=e.selectedCoordPaths.map(s=>e.feature.getCoordinate(s)),n=r.map(s=>({type:v.FEATURE,properties:{},geometry:{type:v.POINT,coordinates:s}})),i=Ut(n,o);for(let s=0;s<r.length;s++){const c=r[s];e.feature.updateCoordinate(e.selectedCoordPaths[s],c[0]+i.lng,c[1]+i.lat)}};k.clickNoTarget=function(){this.changeMode(w.SIMPLE_SELECT)};k.clickInactive=function(){this.changeMode(w.SIMPLE_SELECT)};k.clickActiveFeature=function(e){e.selectedCoordPaths=[],this.clearSelectedCoordinates(),e.feature.changed()};k.onSetup=function(e){const t=e.featureId,o=this.getFeature(t);if(!o)throw new Error("You must provide a featureId to enter direct_select mode");if(o.type===v.POINT)throw new TypeError("direct_select mode doesn't handle point features");const r={featureId:t,feature:o,dragMoveLocation:e.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:e.coordPath?[e.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(t,r.selectedCoordPaths)),this.setSelected(t),me.disable(this),this.setActionableState({trash:!0}),r};k.onStop=function(){me.enable(this),this.clearSelectedCoordinates()};k.toDisplayFeatures=function(e,t,o){e.featureId===t.properties.id?(t.properties.active=z.ACTIVE,o(t),gt(t,{map:this.map,midpoints:!0,selectedPaths:e.selectedCoordPaths}).forEach(o)):(t.properties.active=z.INACTIVE,o(t)),this.fireActionable(e)};k.onTrash=function(e){e.selectedCoordPaths.sort((t,o)=>o.localeCompare(t,"en",{numeric:!0})).forEach(t=>e.feature.removeCoordinate(t)),this.fireUpdate(),e.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(e),e.feature.isValid()===!1&&(this.deleteFeature([e.featureId]),this.changeMode(w.SIMPLE_SELECT,{}))};k.onMouseMove=function(e,t){const o=Fe(t),r=To(t),n=_o(t),i=e.selectedCoordPaths.length===0;return o&&i?this.updateUIClasses({mouse:G.MOVE}):r&&!i?this.updateUIClasses({mouse:G.MOVE}):this.updateUIClasses({mouse:G.NONE}),(r||o||n)&&e.dragMoving&&this.fireUpdate(),this.stopDragging(e),!0};k.onMouseOut=function(e){return e.dragMoving&&this.fireUpdate(),!0};k.onTouchStart=k.onMouseDown=function(e,t){if(To(t))return this.onVertex(e,t);if(Fe(t))return this.onFeature(e,t);if(_o(t))return this.onMidpoint(e,t)};k.onDrag=function(e,t){if(e.canDragMove!==!0)return;e.dragMoving=!0,t.originalEvent.stopPropagation();const o={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};e.selectedCoordPaths.length>0?this.dragVertex(e,t,o):this.dragFeature(e,t,o),e.dragMoveLocation=t.lngLat};k.onClick=function(e,t){if(pt(t))return this.clickNoTarget(e,t);if(Fe(t))return this.clickActiveFeature(e,t);if(Dt(t))return this.clickInactive(e,t);this.stopDragging(e)};k.onTap=function(e,t){if(pt(t))return this.clickNoTarget(e,t);if(Fe(t))return this.clickActiveFeature(e,t);if(Dt(t))return this.clickInactive(e,t)};k.onTouchEnd=k.onMouseUp=function(e){e.dragMoving&&this.fireUpdate(),this.stopDragging(e)};const Te={};Te.onSetup=function(){const e=this.newFeature({type:v.FEATURE,properties:{},geometry:{type:v.POINT,coordinates:[]}});return this.addFeature(e),this.clearSelectedFeatures(),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.POINT),this.setActionableState({trash:!0}),{point:e}};Te.stopDrawingAndRemove=function(e){this.deleteFeature([e.point.id],{silent:!0}),this.changeMode(w.SIMPLE_SELECT)};Te.onTap=Te.onClick=function(e,t){this.updateUIClasses({mouse:G.MOVE}),e.point.updateCoordinate("",t.lngLat.lng,t.lngLat.lat),this.fire(Q.CREATE,{features:[e.point.toGeoJSON()]}),this.changeMode(w.SIMPLE_SELECT,{featureIds:[e.point.id]})};Te.onStop=function(e){this.activateUIButton(),e.point.getCoordinate().length||this.deleteFeature([e.point.id],{silent:!0})};Te.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.point.id;if(t.properties.active=r?z.ACTIVE:z.INACTIVE,!r)return o(t)};Te.onTrash=Te.stopDrawingAndRemove;Te.onKeyUp=function(e,t){if(ft(t)||ht(t))return this.stopDrawingAndRemove(e,t)};function lt(e,t){return e.lngLat?e.lngLat.lng===t[0]&&e.lngLat.lat===t[1]:!1}const Ee={};Ee.onSetup=function(){const e=this.newFeature({type:v.FEATURE,properties:{},geometry:{type:v.POLYGON,coordinates:[[]]}});return this.addFeature(e),this.clearSelectedFeatures(),me.disable(this),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.POLYGON),this.setActionableState({trash:!0}),{polygon:e,currentVertexPosition:0}};Ee.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&lt(t,e.polygon.coordinates[0][e.currentVertexPosition-1]))return this.changeMode(w.SIMPLE_SELECT,{featureIds:[e.polygon.id]});this.updateUIClasses({mouse:G.ADD}),e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),e.currentVertexPosition++,e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat)};Ee.clickOnVertex=function(e){return this.changeMode(w.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};Ee.onMouseMove=function(e,t){e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),Ke(t)&&this.updateUIClasses({mouse:G.POINTER})};Ee.onTap=Ee.onClick=function(e,t){return Ke(t)?this.clickOnVertex(e,t):this.clickAnywhere(e,t)};Ee.onKeyUp=function(e,t){ft(t)?(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(w.SIMPLE_SELECT)):ht(t)&&this.changeMode(w.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};Ee.onStop=function(e){this.updateUIClasses({mouse:G.NONE}),me.enable(this),this.activateUIButton(),this.getFeature(e.polygon.id)!==void 0&&(e.polygon.removeCoordinate(`0.${e.currentVertexPosition}`),e.polygon.isValid()?this.fire(Q.CREATE,{features:[e.polygon.toGeoJSON()]}):(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(w.SIMPLE_SELECT,{},{silent:!0})))};Ee.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.polygon.id;if(t.properties.active=r?z.ACTIVE:z.INACTIVE,!r)return o(t);if(t.geometry.coordinates.length===0)return;const n=t.geometry.coordinates[0].length;if(!(n<3)){if(t.properties.meta=Y.FEATURE,o(je(e.polygon.id,t.geometry.coordinates[0][0],"0.0",!1)),n>3){const i=t.geometry.coordinates[0].length-3;o(je(e.polygon.id,t.geometry.coordinates[0][i],`0.${i}`,!1))}if(n<=4){const i=[[t.geometry.coordinates[0][0][0],t.geometry.coordinates[0][0][1]],[t.geometry.coordinates[0][1][0],t.geometry.coordinates[0][1][1]]];if(o({type:v.FEATURE,properties:t.properties,geometry:{coordinates:i,type:v.LINE_STRING}}),n===3)return}return o(t)}};Ee.onTrash=function(e){this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(w.SIMPLE_SELECT)};const ve={};ve.onSetup=function(e){e=e||{};const t=e.featureId;let o,r,n="forward";if(t){if(o=this.getFeature(t),!o)throw new Error("Could not find a feature with the provided featureId");let i=e.from;if(i&&i.type==="Feature"&&i.geometry&&i.geometry.type==="Point"&&(i=i.geometry),i&&i.type==="Point"&&i.coordinates&&i.coordinates.length===2&&(i=i.coordinates),!i||!Array.isArray(i))throw new Error("Please use the `from` property to indicate which point to continue the line from");const s=o.coordinates.length-1;if(o.coordinates[s][0]===i[0]&&o.coordinates[s][1]===i[1])r=s+1,o.addCoordinate(r,...o.coordinates[s]);else if(o.coordinates[0][0]===i[0]&&o.coordinates[0][1]===i[1])n="backwards",r=0,o.addCoordinate(r,...o.coordinates[0]);else throw new Error("`from` should match the point at either the start or the end of the provided LineString")}else o=this.newFeature({type:v.FEATURE,properties:{},geometry:{type:v.LINE_STRING,coordinates:[]}}),r=0,this.addFeature(o);return this.clearSelectedFeatures(),me.disable(this),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.LINE),this.setActionableState({trash:!0}),{line:o,currentVertexPosition:r,direction:n}};ve.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&lt(t,e.line.coordinates[e.currentVertexPosition-1])||e.direction==="backwards"&&lt(t,e.line.coordinates[e.currentVertexPosition+1]))return this.changeMode(w.SIMPLE_SELECT,{featureIds:[e.line.id]});this.updateUIClasses({mouse:G.ADD}),e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),e.direction==="forward"?(e.currentVertexPosition++,e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat)):e.line.addCoordinate(0,t.lngLat.lng,t.lngLat.lat)};ve.clickOnVertex=function(e){return this.changeMode(w.SIMPLE_SELECT,{featureIds:[e.line.id]})};ve.onMouseMove=function(e,t){e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),Ke(t)&&this.updateUIClasses({mouse:G.POINTER})};ve.onTap=ve.onClick=function(e,t){if(Ke(t))return this.clickOnVertex(e,t);this.clickAnywhere(e,t)};ve.onKeyUp=function(e,t){ht(t)?this.changeMode(w.SIMPLE_SELECT,{featureIds:[e.line.id]}):ft(t)&&(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(w.SIMPLE_SELECT))};ve.onStop=function(e){me.enable(this),this.activateUIButton(),this.getFeature(e.line.id)!==void 0&&(e.line.removeCoordinate(`${e.currentVertexPosition}`),e.line.isValid()?this.fire(Q.CREATE,{features:[e.line.toGeoJSON()]}):(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(w.SIMPLE_SELECT,{},{silent:!0})))};ve.onTrash=function(e){this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(w.SIMPLE_SELECT)};ve.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.line.id;if(t.properties.active=r?z.ACTIVE:z.INACTIVE,!r)return o(t);t.geometry.coordinates.length<2||(t.properties.meta=Y.FEATURE,o(je(e.line.id,t.geometry.coordinates[e.direction==="forward"?t.geometry.coordinates.length-2:1],`${e.direction==="forward"?t.geometry.coordinates.length-2:1}`,!1)),o(t))};const Io={simple_select:R,direct_select:k,draw_point:Te,draw_polygon:Ee,draw_line_string:ve},rn={defaultMode:w.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:vo,modes:Io,controls:{},userProperties:!1,suppressAPIEvents:!0},nn={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},sn={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function to(e,t){return e.map(o=>o.source?o:Object.assign({},o,{id:`${o.id}.${t}`,source:t==="hot"?pe.HOT:pe.COLD}))}function an(e={}){let t=Object.assign({},e);return e.controls||(t.controls={}),e.displayControlsDefault===!1?t.controls=Object.assign({},sn,e.controls):t.controls=Object.assign({},nn,e.controls),t=Object.assign({},rn,t),t.styles=to(t.styles,"cold").concat(to(t.styles,"hot")),t}var _t,oo;function ln(){if(oo)return _t;oo=1,_t=t;var e={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function t(o){if(!o||!o.type)return null;var r=e[o.type];if(!r)return null;if(r==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:o}]};if(r==="feature")return{type:"FeatureCollection",features:[o]};if(r==="featurecollection")return o}return _t}var cn=ln();const un=At(cn);function Mo(e,t){return e.length!==t.length?!1:JSON.stringify(e.map(o=>o).sort())===JSON.stringify(t.map(o=>o).sort())}const dn={Polygon:le,LineString:_e,Point:Ae,MultiPolygon:K,MultiLineString:K,MultiPoint:K};function pn(e,t){t.modes=w;const o=e.options.suppressAPIEvents!==void 0?!!e.options.suppressAPIEvents:!0;return t.getFeatureIdsAt=function(r){return Ve.click({point:r},null,e).map(i=>i.properties.id)},t.getSelectedIds=function(){return e.store.getSelectedIds()},t.getSelected=function(){return{type:v.FEATURE_COLLECTION,features:e.store.getSelectedIds().map(r=>e.store.get(r)).map(r=>r.toGeoJSON())}},t.getSelectedPoints=function(){return{type:v.FEATURE_COLLECTION,features:e.store.getSelectedCoordinates().map(r=>({type:v.FEATURE,properties:{},geometry:{type:v.POINT,coordinates:r.coordinates}}))}},t.set=function(r){if(r.type===void 0||r.type!==v.FEATURE_COLLECTION||!Array.isArray(r.features))throw new Error("Invalid FeatureCollection");const n=e.store.createRenderBatch();let i=e.store.getAllIds().slice();const s=t.add(r),c=new he(s);return i=i.filter(a=>!c.has(a)),i.length&&t.delete(i),n(),s},t.add=function(r){const i=JSON.parse(JSON.stringify(un(r))).features.map(s=>{if(s.id=s.id||Ft(),s.geometry===null)throw new Error("Invalid geometry: null");if(e.store.get(s.id)===void 0||e.store.get(s.id).type!==s.geometry.type){const c=dn[s.geometry.type];if(c===void 0)throw new Error(`Invalid geometry type: ${s.geometry.type}.`);const a=new c(e,s);e.store.add(a,{silent:o})}else{const c=e.store.get(s.id),a=c.properties;c.properties=s.properties,Wt(a,s.properties)||e.store.featureChanged(c.id,{silent:o}),Wt(c.getCoordinates(),s.geometry.coordinates)||c.incomingCoords(s.geometry.coordinates)}return s.id});return e.store.render(),i},t.get=function(r){const n=e.store.get(r);if(n)return n.toGeoJSON()},t.getAll=function(){return{type:v.FEATURE_COLLECTION,features:e.store.getAll().map(r=>r.toGeoJSON())}},t.delete=function(r){return e.store.delete(r,{silent:o}),t.getMode()===w.DIRECT_SELECT&&!e.store.getSelectedIds().length?e.events.changeMode(w.SIMPLE_SELECT,void 0,{silent:o}):e.store.render(),t},t.deleteAll=function(){return e.store.delete(e.store.getAllIds(),{silent:o}),t.getMode()===w.DIRECT_SELECT?e.events.changeMode(w.SIMPLE_SELECT,void 0,{silent:o}):e.store.render(),t},t.changeMode=function(r,n={}){return r===w.SIMPLE_SELECT&&t.getMode()===w.SIMPLE_SELECT?(Mo(n.featureIds||[],e.store.getSelectedIds())||(e.store.setSelected(n.featureIds,{silent:o}),e.store.render()),t):(r===w.DIRECT_SELECT&&t.getMode()===w.DIRECT_SELECT&&n.featureId===e.store.getSelectedIds()[0]||e.events.changeMode(r,n,{silent:o}),t)},t.getMode=function(){return e.events.getMode()},t.trash=function(){return e.events.trash({silent:o}),t},t.combineFeatures=function(){return e.events.combineFeatures({silent:o}),t},t.uncombineFeatures=function(){return e.events.uncombineFeatures({silent:o}),t},t.setFeatureProperty=function(r,n,i){return e.store.setFeatureProperty(r,n,i,{silent:o}),t},t}const fn=Object.freeze(Object.defineProperty({__proto__:null,CommonSelectors:tn,ModeHandler:Lt,StringSet:he,constrainFeatureMovement:Ut,createMidPoint:So,createSupplementaryPoints:gt,createVertex:je,doubleClickZoom:me,euclideanDistance:Nt,featuresAt:Ve,getFeatureAtAndSetCursors:nt,isClick:Pt,isEventAtCoordinates:lt,isTap:Ot,mapEventToBoundingBox:go,moveFeatures:Bt,sortFeatures:ho,stringSetsAreEqual:Mo,theme:vo,toDenseArray:Ze},Symbol.toStringTag,{value:"Module"})),hn=function(e,t){e=an(e);const o={options:e};t=pn(o,t),o.api=t;const r=Qr(o);return t.onAdd=r.onAdd,t.onRemove=r.onRemove,t.types=re,t.options=e,t};function yt(e){hn(e,this)}yt.modes=Io;yt.constants=fo;yt.lib=fn;const gn=({commentInput:e,setCommentInput:t,addCommentLayer:o,setCommentFeatures:r,commentFeatures:n,handleDeleteComment:i,workDay:s,drawRef:c})=>{var E,l,p,h,T;const a=Ne(_=>_.auth.user),u=Ne(_=>_.auth.token),y=async(_,N)=>{try{const V=`comment-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,$={...e.feature},L={...$,type:"Feature",geometry:N||$.geometry,properties:{...$.properties,id:V,workDayId:s.id,comment:_,type:"comment",createdAt:new Date().toISOString(),createdBy:a}},F={geometry:L.geometry,properties:L.properties,featureType:L.properties.type,workDayId:s.id};(await ae.post("/mapFeature",F,{headers:{Authorization:u}})).status===201&&ge("Successfully Added Comment",{variant:"success"}),r(X=>[...X,L]),console.log(L,"<=== yeets"),c.add(L),t({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}})}catch(V){console.error(V)}};return g.jsx(Vo,{in:e.open,children:g.jsxs(no,{elevation:4,sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,p:1.5,width:250,backgroundColor:"#ffffff",border:"1px solid #e0e0e0",borderRadius:1.5},children:[g.jsxs(fe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[g.jsx(Pe,{variant:"subtitle2",sx:{fontSize:"0.875rem"},children:e.isEdit?"Edit Comment":"Add Comment"}),g.jsx(ro,{size:"small",onClick:()=>t({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),sx:{p:.5},children:g.jsx(hr,{size:14})})]}),g.jsx(so,{autoFocus:!0,size:"small",fullWidth:!0,variant:"outlined",multiline:!0,rows:2,placeholder:"Enter comment...",value:((l=(E=e.feature)==null?void 0:E.properties)==null?void 0:l.comment)||"",onChange:_=>{if(e.feature){const N={...e.feature,properties:{...e.feature.properties,comment:_.target.value}};t({...e,feature:N})}},sx:{mb:1}}),g.jsxs(fe,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[e.isEdit&&e.feature&&g.jsx(Ge,{size:"small",variant:"contained",color:"error",startIcon:g.jsx(fr,{size:14}),onClick:()=>{i(e.feature)},sx:{fontSize:"0.75rem",py:.5},children:"Delete"}),g.jsx(Ge,{size:"small",variant:"contained",onClick:()=>{var _,N;return y(((N=(_=e.feature)==null?void 0:_.properties)==null?void 0:N.comment)||"")},disabled:!((T=(h=(p=e.feature)==null?void 0:p.properties)==null?void 0:h.comment)!=null&&T.trim()),sx:{fontSize:"0.75rem",py:.5},children:e.isEdit?"Update":"Add"})]})]})})};class yn{constructor(t){if(typeof t=="function")this.onChange=t,this.initialColor="#3bb2d0",this.initialOpacity=.2;else{const{onChange:o,initialColor:r="#3bb2d0",initialOpacity:n=.2}=t||{};this.onChange=o,this.initialColor=r,this.initialOpacity=n}this._map=null,this._container=null,this._isOpen=!1,this._color=this.initialColor,this._opacity=this.initialOpacity}onAdd(t){this._map=t;const o=document.createElement("div");o.className="mapboxgl-ctrl mapboxgl-ctrl-group",o.style.position="relative";const r=document.createElement("button");r.type="button",r.className="mapboxgl-ctrl-icon",r.setAttribute("aria-label","Color & Opacity"),r.style.width="30px",r.style.height="30px",r.style.display="inline-flex",r.style.alignItems="center",r.style.justifyContent="center";const n=document.createElement("span");n.style.width="14px",n.style.height="14px",n.style.borderRadius="50%",n.style.background=this._color,n.style.opacity=this._opacity,n.style.boxShadow="0 0 0 1px rgba(0,0,0,0.2) inset",r.appendChild(n),this._dot=n;const i=document.createElement("div");i.style.position="absolute",i.style.top="0",i.style.right="100%",i.style.marginRight="8px",i.style.display="none",i.style.flexDirection="column",i.style.gap="8px",i.style.padding="8px",i.style.background="#fff",i.style.border="1px solid rgba(0,0,0,0.15)",i.style.borderRadius="8px",i.style.boxShadow="0 2px 8px rgba(0,0,0,0.12)",i.style.zIndex="2",i.style.width="140px";const s=document.createElement("input");s.type="color",s.value=this._color,s.style.width="100%",s.addEventListener("input",y=>{this._color=y.target.value,this._update()});const c=document.createElement("div");c.style.display="flex",c.style.flexDirection="column",c.style.fontSize="12px",c.style.gap="4px";const a=document.createElement("span");a.textContent=`Opacity: ${Math.round(this._opacity*100)}%`;const u=document.createElement("input");return u.type="range",u.min="0.1",u.max="1",u.step="0.05",u.value=this._opacity,u.addEventListener("input",y=>{this._opacity=parseFloat(y.target.value),a.textContent=`Opacity: ${Math.round(this._opacity*100)}%`,this._update()}),c.appendChild(a),c.appendChild(u),i.appendChild(s),i.appendChild(c),r.addEventListener("click",y=>{y.stopPropagation(),this._isOpen=!this._isOpen,i.style.display=this._isOpen?"flex":"none"}),document.addEventListener("click",y=>{o.contains(y.target)||(this._isOpen=!1,i.style.display="none")}),o.appendChild(r),o.appendChild(i),this._container=o,o}onRemove(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._map=null}_update(){this._dot&&(this._dot.style.background=this._color,this._dot.style.opacity=this._opacity),typeof this.onChange=="function"&&this.onChange(this._color,this._opacity)}}se.accessToken="pk.eyJ1IjoiaGlyYWtyYWoiLCJhIjoiY21icXd5eHRnMDNtaTJxczcxd2RmbTZwOCJ9.P6kpsuLMDdeK2DIMJZMrmw";const mn=[{title:"Projects",to:"/project",icon:zo},{title:"Project Name",icon:qo},{title:"Exterior(Map View)",icon:Jo}],Be=({label:e,createdBy:t,createdAt:o})=>`
    <div style="
      font-family: 'Arial', sans-serif;
      background-color: #fff;
      border: 1px solid #B3D3F0; /* secondary200 */
      border-radius: 8px;
      overflow: hidden;
      width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    ">
      <!-- Header -->
      <div style="
        background-color: #2563EB; /* primaryMain */
        color: #fff;
        font-weight: 600;
        font-size: 13px;
        padding: 8px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        ${e}
      </div>
      
      <!-- Body -->
      <div style="
        padding: 6px 8px;
        background-color: #D6E6F5; /* secondaryLight */
        display: flex;
        justify-content: space-between;
        font-size: 8px;
        color: #1F3F66; /* secondary800 */
      ">
        <span>${t}</span>
        <span style="color: #666;">
          ${new Date(o).toLocaleDateString()} ${new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}
        </span>
      </div>
    </div>
  `,$e=(e,t)=>{let o,r;return e.createdBy?o=e.createdBy:o=JSON.parse(e.user_createdBy),e.createdAt?r=e.createdAt:r=e.user_createdAt,{createdBy:`${o.firstName} ${o.lastName}`,createdAt:new Date(r),label:t}};function Tn(){const e=x.useRef(null),t=x.useRef(null),o=x.useRef(null),r=Ne(f=>f.auth.user),[n,i]=x.useState(!1),[s,c]=x.useState(""),[a,u]=x.useState({orthomosaic:!0,annotations:!0,showComments:!0,showPolygons:!0,showLineString:!0,builtinOverlay:!1,shapeOverlay:!1}),[y,E]=x.useState(!1),[l,p]=x.useState([]),[h,T]=x.useState([]),[_,N]=x.useState(!1),[V,$]=x.useState({}),[L,F]=x.useState(null),[ne,X]=x.useState(!1),[te,Z]=x.useState([]),[Ie,ze]=x.useState("#2563EB"),[qe,xe]=x.useState(.5),[Me,be]=x.useState({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),[q,Le]=x.useState([]),we=Ne(f=>f.project.id),Ce=Ne(f=>f.auth.token);x.useEffect(()=>{if(!we)return;(async()=>{var m,I,b,D,W,J,U,O;try{N(!0),F(null);const S=((I=(m=(await ae.get("/work-day",{params:{projectId:we,status:"completed"},headers:{Authorization:Ce}})).data)==null?void 0:m.data)==null?void 0:I.results)||[];if(p(S.map(d=>d.name)),$(S[0]),T(S),S.length>0){c(S[0].name);const d=await ae.get("/mapFeature",{params:{workDayId:S[0].id},headers:{Authorization:Ce}});((D=(b=d.data)==null?void 0:b.data)==null?void 0:D.results.length)!==0&&Z((J=(W=d.data)==null?void 0:W.data)==null?void 0:J.results)}else F("No completed work days found for this project.")}catch(C){F(((O=(U=C.response)==null?void 0:U.data)==null?void 0:O.message)||"Failed to load project data. Please try again."),p([]),T([])}finally{N(!1)}})()},[we,Ce]),x.useEffect(()=>{if(!e.current||t.current)return;if(!se.accessToken){F("Mapbox API key is not configured.");return}const f=new se.Map({container:e.current,style:"mapbox://styles/mapbox/satellite-streets-v12",center:[72.5714,23.0225],zoom:15,attributionControl:!1,preserveDrawingBuffer:!0,minZoom:0,maxZoom:23}),m=Ie,I=qe;var b=Ie,D=I;const W=(J,U)=>{const O=["coalesce",["get","user_color"],["get","color_hex"],["get","color"],J],C=["coalesce",["get","user_opacity"],["get","opacity"],U];return[{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":O,"fill-outline-color":O,"fill-opacity":C}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":O,"line-width":1}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],paint:{"line-color":O,"line-width":1}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":O,"fill-outline-color":O,"fill-opacity":C}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":O,"line-width":1}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],paint:{"line-color":O,"line-width":2}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","false"]],paint:{"circle-radius":4,"circle-color":O}},{id:"gl-draw-point-comment",type:"circle",filter:["all",["==","active","false"],["==","meta","feature"],["==","user_type","comment"]],paint:{"circle-radius":4,"circle-color":O,"circle-stroke-color":"#fff","circle-stroke-width":2}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":6,"circle-color":O,"circle-stroke-color":O,"circle-stroke-width":2}},{id:"gl-draw-point-comment-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["==","meta","feature"],["==","user_type","comment"]],paint:{"circle-radius":6,"circle-color":O,"circle-stroke-color":"#fff","circle-stroke-width":3}}]};return f.on("load",()=>{t.current=f,i(!0),F(null),f.addControl(new se.FullscreenControl,"top-right"),f.addControl(new se.NavigationControl({visualizePitch:!0}),"top-right");const J=new se.ScaleControl({unit:"metric",maxWidth:100});f.addControl(J,"bottom-left"),setTimeout(()=>{const C=f.getContainer().querySelector(".mapboxgl-ctrl-scale");C&&(C.style.display="block",C.style.visibility="visible",C.style.opacity="1")},1e3);const U=new yn((C,S)=>{console.log(C,S,"<==== picked"),b=C||m,D=S||I,console.log(b,"<==== current"),ze(C),xe(S)});f.addControl(U,"top-right");const O=new yt({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!0,line_string:!0,point:!0,trash:!0},styles:W(b,D)});f.addControl(O,"top-right"),o.current=O,f.on("draw.create",async C=>{var H;const S=V.id;C.features.forEach(P=>{O.setFeatureProperty(P.id,"color",b)});const d=(H=C.features)==null?void 0:H[0];if(d){if(t.current.__activePopup&&t.current.__activePopup.remove(),d.geometry.type==="LineString"){if(!d||d.geometry.type!=="LineString")return;const ce=`${et(d,{units:"meters"}).toFixed(2)} m`,ue=`polygon-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;d.properties.createdBy=r,d.properties.createdAt=new Date,d.createdAt=new Date().toISOString,d.properties.comment=ce,d.properties.color=b,d.properties.id=ue;try{const A={featureType:"line",geometry:d.geometry,properties:d.properties,workDayId:S};(await ae.post("/mapFeature",A,{headers:{Authorization:Ce}})).status===201&&ge("Line created ",{variant:"success"}),O.add(d)}catch(A){console.error(A)}ge(ce,{variant:"success"})}if(d.geometry.type==="Polygon"){const P=rt.geometry(d.geometry).toFixed(2),ce=`${P} m²`,ue=`polygon-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,A=St(d).geometry.coordinates;O.setFeatureProperty(d.id,"id",ue),d.properties.color=b,d.properties.createdAt=new Date,d.properties.createdBy=r,d.properties.areaM2=P,d.properties.id=ue,d.properties.opacity=D;try{const j={featureType:"polygon",geometry:d.geometry,properties:d.properties,workDayId:S};(await ae.post("/mapFeature",j,{headers:{Authorization:Ce}})).status===201&&ge("Polygon created ",{variant:"success"}),setTimeout(()=>{const Se=new se.Popup({closeButton:!0,offset:15}).setLngLat(A).setHTML(Be($e(d.properties,ce))).addTo(t.current);t.current.__activePopup=Se,O.add(d)},0)}catch(j){console.error(j)}}if(d.geometry.type==="Point"){const P=f.getCanvas().getBoundingClientRect();be({open:!0,feature:{feature:d,geometry:d.geometry,color:b,properties:{color:b}},isEdit:!1,position:{x:P.width/2,y:P.height/2}})}}}),f.on("draw.update",async C=>{var H,P,ce,ue;t.current.__activePopup&&t.current.__activePopup.remove(),console.log("updating something");const S=V.id,d=(H=C.features)==null?void 0:H[0];if(d){if(C.features.forEach(A=>{O.setFeatureProperty(A.id,"color",b)}),((P=d==null?void 0:d.geometry)==null?void 0:P.type)==="Polygon"){const A=rt.geometry(d.geometry),j=(A/1e6).toFixed(2),de=A.toFixed(2);St(d).geometry.coordinates,t.current.__activePopup=popup,d.properties.color=b,d.properties.areaKm2=j,d.properties.areaM2=de,d.properties.opacity=D;try{const Se={featureType:"polygon",geometry:d.geometry,properties:d.properties,workDayId:S};(await ae.patch(`/mapFeature/propertyId/${d==null?void 0:d.properties.id}`,Se,{headers:{Authorization:Ce}})).status===200&&ge("Polygon Updated ",{variant:"success"})}catch(Se){console.error(Se)}}if(((ce=d==null?void 0:d.geometry)==null?void 0:ce.type)==="LineString")try{const A=et(d,{units:"kilometers"}),j=(A*1e3).toFixed(2),de=vt(d,A/2,{units:"kilometers"}).geometry.coordinates;d.properties.color=b,d.properties.lengthKm=A.toFixed(2),d.properties.lengthM=j;const Se={featureType:"line",geometry:d.geometry,properties:d.properties,workDayId:S};(await ae.patch(`/mapFeature/propertyId/${d==null?void 0:d.properties.id}`,Se,{headers:{Authorization:Ce}})).status===200&&ge("Line Updated",{variant:"success"})}catch(A){console.error("Error updating line:",A)}if(((ue=d==null?void 0:d.geometry)==null?void 0:ue.type)==="Point")try{const[A,j]=d.geometry.coordinates;d.properties.color=b,d.properties.coordinates=`${j.toFixed(6)}, ${A.toFixed(6)}`;const de={featureType:"comment",geometry:d.geometry,properties:d.properties,workDayId:S};(await ae.patch(`/mapFeature/propertyId/${d==null?void 0:d.properties.id}`,de,{headers:{Authorization:Ce}})).status===200&&ge("Point Updated",{variant:"success"})}catch(A){console.error("Error updating point:",A)}}}),f.on("draw.delete",async C=>{Le(d=>d.filter(H=>H.properties.id!==S.properties.id)),console.log("on delete"),t.current.__activePopup&&t.current.__activePopup.remove();const S=C.features[0];console.log("Deleted features:",C.features);try{(await ae.delete(`/mapfeature/propertyId/${S.properties.id}`)).status===200&&ge("Successfully removed feature",{variant:"success"})}catch(d){console.error("error removing feature",d)}}),f.on("click",C=>{var ce,ue;console.log("on click"),t.current.__activePopup&&t.current.__activePopup.remove();const S=["gl-draw-line-inactive","gl-draw-line-inactive.hot","gl-draw-line-active","gl-draw-line-active.hot","gl-draw-line-static","gl-draw-point-inactive","gl-draw-point-inactive.hot","gl-draw-point-active","gl-draw-point-active.hot","gl-draw-point-static","gl-draw-polygon-fill-inactive","gl-draw-polygon-fill-inactive.cold","gl-draw-polygon-fill-inactive.hot","gl-draw-polygon-fill-active","gl-draw-polygon-fill-static","gl-draw-polygon-stroke-inactive","gl-draw-polygon-stroke-inactive.cold","gl-draw-polygon-stroke-active","gl-draw-polygon-stroke-static"],d=f.getStyle().layers.map(A=>A.id).filter(A=>S.includes(A)),H=f.queryRenderedFeatures(C.point,{layers:d});if(!H.length)return;const P=H[0];if(P.geometry.type==="Point"&&P.properties.user_type==="comment"){console.log(P,"<==== yeeter");const A=P.geometry.coordinates.slice(),j=((ce=P.properties)==null?void 0:ce.comment)||((ue=P.properties)==null?void 0:ue.user_comment)||"",de=new se.Popup().setLngLat(A).setHTML(Be($e(P.properties,j))).addTo(f);t.current.__activePopup=de}if(P.geometry.type==="Polygon"){console.log(P,"<=== featuer agae ");const j=`${rt.geometry(P.geometry).toFixed(2)} m²`,de=St(P).geometry.coordinates;new se.Popup().setLngLat(de).setHTML(Be($e(P.properties,j))).addTo(f)}if(P.geometry.type==="LineString"){console.log(P,"<==== feature line string selection");const A=et(P,{units:"kilometers"}),j=vt(P,A/2,{units:"kilometers"}).geometry.coordinates,de=A*1e3,Se=`${de.toFixed(2)} m`;if(j&&!j.some(Number.isNaN)){const mt=new se.Popup().setLngLat(j).setHTML(Be($e(P.properties,Se))).addTo(f);t.current.__activePopup=mt}ge(`Length: ${de.toFixed(2)} m`,{variant:"success"})}}),f.on("draw.selectionchange",C=>{if(C.features.length>0){const S=C.features[0];if(S.geometry.type==="LineString"&&S.properties.mode!=="draw_polygon"){console.log(S,"<==== feature line string selection");const d=et(S,{units:"kilometers"}),H=vt(S,d/2,{units:"kilometers"}).geometry.coordinates,P=d*1e3,ce=`${P.toFixed(2)} m`;if(H&&!H.some(Number.isNaN)){const ue=new se.Popup().setLngLat(H).setHTML(Be($e(S.properties,ce))).addTo(f);t.current.__activePopup=ue}ge(`Length: ${P.toFixed(2)} m`,{variant:"success"})}if(S.geometry.type==="Point"){console.log(S,"<============wew");const d=new se.Popup().setLngLat(S.geometry.coordinates).setHTML(Be($e(S.properties,S.properties.comment))).addTo(f);t.current.__activePopup=d}}})}),f.on("sourcedata",J=>{var U;(U=J.sourceId)!=null&&U.includes("ortho-")&&J.isSourceLoaded&&(console.log("on source data remove"),X(!1))}),()=>{f&&f.remove&&f.remove(),t.current=null,i(!1)}},[V]),x.useEffect(()=>{if(!s||!t.current||!n||!h.length)return;(async()=>{var I;const m=h.find(b=>b.name===s);if(m){o.current.deleteAll();try{const{data:b}=await ae.get("/mapFeature",{params:{workDayId:m.id,limit:1e6},headers:{Authorization:Ce}}),W={type:"FeatureCollection",features:(((I=b==null?void 0:b.data)==null?void 0:I.results)||[]).map(({geometry:J,properties:U,createdBy:O,createdAt:C})=>({type:"Feature",geometry:J,properties:{...U,createdBy:O,createdAt:C,comment:(U==null?void 0:U.comment)||"",color:(U==null?void 0:U.color)||(U==null?void 0:U.hex_color)||Ie,message:(U==null?void 0:U.message)||"No message set"}}))};console.log(W.features,"<======== yeeeter"),Le(W.features)}catch(b){console.error("Error loading map features:",b)}}})()},[s,n,h]),x.useEffect(()=>{if(!s||!V.id)return;Lo(V.id);const f=h.find(C=>C.name===s);if(!t.current||!n||!f)return;const m=t.current,I=`overlay-${f.id}`,b=`shape-overlay-${f.id}`,D={fill:`overlay-fill-${f.id}`,line:`overlay-line-${f.id}`,point:`overlay-point-${f.id}`},W={fill:`shapeOverlay-fill-${f.id}`,line:`shapeOverlay-line-${f.id}`,point:`shapeOverlay-point-${f.id}`};Object.values(D).forEach(C=>{m.getLayer(C)&&m.removeLayer(C)}),Object.values(W).forEach(C=>{m.getLayer(C)&&m.removeLayer(C)}),m.getSource(I)&&m.removeSource(I),m.getSource(b)&&m.removeSource(b),o.current&&o.current.deleteAll();const J=q.filter(C=>{var S;return(S=C.properties)==null?void 0:S.overlay}),U=q.filter(C=>{var S;return!((S=C.properties)!=null&&S.overlay)}),O=q.filter(C=>{var S;return(S=C.properties)==null?void 0:S.shapefile});if(console.log(O,"<============ shape overlay features"),console.log(J,"<============ overlay features"),o.current&&U.length){const C=U.filter(S=>{var H;const d=(H=S.geometry)==null?void 0:H.type;return d==="Polygon"&&a.showPolygons||d==="LineString"&&a.showLineString||d==="Point"&&a.showComments});C.length&&a.annotations&&(o.current.add({type:"FeatureCollection",features:C}),o.current.changeMode("simple_select"))}if(a.builtinOverlay&&J.length&&(m.addSource(I,{type:"geojson",data:{type:"FeatureCollection",features:J}}),a.showPolygons&&m.addLayer({id:D.fill,type:"fill",source:I,filter:["==",["geometry-type"],"Polygon"],paint:{"fill-color":["coalesce",["get","color_hex"],"#2563EB"],"fill-opacity":.3}}),a.showLineString&&m.addLayer({id:D.line,type:"line",source:I,filter:["==",["geometry-type"],"LineString"],paint:{"line-color":["coalesce",["get","color_hex"],"#2563EB"],"line-width":1,"line-join":"round","line-cap":"round"}}),a.showComments&&m.addLayer({id:D.point,type:"circle",source:I,filter:["==",["geometry-type"],"Point"],paint:{"circle-radius":3,"circle-color":["coalesce",["get","color_hex"],"#2563EB"]}})),a.shapeOverlay&&O.length&&(m.addSource(b,{type:"geojson",data:{type:"FeatureCollection",features:O}}),a.showPolygons&&m.addLayer({id:W.fill,type:"fill",source:b,filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],paint:{"fill-color":["coalesce",["get","color"],"#2563EB"],"fill-opacity":.3}}),a.showLineString&&m.addLayer({id:W.line,type:"line",source:b,filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]],paint:{"line-color":["coalesce",["get","color"],"#2563EB"],"line-width":2,"line-join":"round","line-cap":"round"}}),a.showComments&&m.addLayer({id:W.point,type:"circle",source:b,filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],paint:{"circle-radius":5,"circle-color":["coalesce",["get","color"],"#2563EB"],"circle-stroke-width":1,"circle-stroke-color":"#ffffff"}})),a.orthomosaic&&f.tileBaseUrl&&(X(!0),bo(f)),f.tileBounds)wo(f.tileBounds);else if(J.length){const C=new se.LngLatBounds;J.forEach(S=>{S.geometry.type==="Point"?C.extend(S.geometry.coordinates):S.geometry.type==="LineString"?S.geometry.coordinates.forEach(d=>C.extend(d)):S.geometry.type==="Polygon"&&S.geometry.coordinates.flat().forEach(d=>C.extend(d))}),C.isEmpty()||m.fitBounds(C,{padding:40})}},[q,a,n,s,h]);const Lo=f=>{const m=t.current;if(!m)return;[`ortho-${f}`,"all-features-points","all-features-lines","all-features-polygons","all-features-polygons-outline","comment-labels"].forEach(D=>{m.getLayer(D)&&(console.log("Removing layer:",D),m.removeLayer(D))}),[`ortho-${f}`,"all-features"].forEach(D=>{m.getSource(D)&&(console.log("Removing source:",D),m.removeSource(D))})},bo=f=>{const m=t.current;if(!m||!f.tileBaseUrl)return;const I=`ortho-${f.id}`;try{m.getLayer(I)&&m.removeLayer(I),m.getSource(I)&&m.removeSource(I),m.addSource(I,{type:"raster",tiles:[`${f.tileBaseUrl}/{z}/{x}/{y}.png`],tileSize:256,minzoom:10,maxzoom:23});const b=m.getStyle().layers.find(D=>D.id.startsWith("gl-draw-")).id;m.addLayer({id:I,type:"raster",source:I,paint:{"raster-opacity":a.orthomosaic?1:0,"raster-brightness-min":0,"raster-brightness-max":1}},b),console.log("Raster layer added:",I,"URL:",f.tileBaseUrl),setTimeout(()=>{const D=m.getLayer(I),W=m.getSource(I);console.log("Layer check:",{layerExists:!!D,sourceExists:!!W,layerVisible:m.getLayoutProperty(I,"visibility")!=="none",paintOpacity:m.getPaintProperty(I,"raster-opacity")})},1e3),X(!1)}catch(b){console.error("Error adding tile layer:",b),F("Failed to load orthomosaic tiles."),X(!1)}},wo=f=>{const m=t.current;if(!m)return;const{north:I,south:b,east:D,west:W}=f;m.fitBounds([[W,b],[D,I]],{padding:50,maxZoom:18})},De=f=>{u(m=>({...m,[f.target.name]:f.target.checked}))},Po=f=>{c(f.target.value);const m=h.find(I=>I.name===f.target.value);$(m)},Oo=f=>{const m=t.current;if(!(!m||!n)){if(console.log("Updating comment layer with features:",f),m.getLayer("comment-points")&&(console.log("Removing existing comment layer"),m.removeLayer("comment-points")),m.getSource("comments")&&(console.log("Removing existing comment source"),m.removeSource("comments")),console.log("checking features ",f),f&&f.length>0&&a.showComments){console.log("Adding new comment layer with",f.length,"features"),m.addSource("comments",{type:"geojson",data:{type:"FeatureCollection",features:f}}),m.addLayer({id:"comment-points",type:"symbol",source:"comments",layout:{"icon-image":"marker-15","icon-size":1.5,"text-field":["get","comment"],"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-size":.5,"text-color":"#000","text-halo-color":"#fff","text-halo-width":2}});const I=m.getLayer("comment-points");I&&console.log("Comment layer added successfully with ID:",I.id)}else console.log("No features to display, comment layer removed");m.isStyleLoaded()&&m.triggerRepaint(),console.log("Comment layer update complete")}},Ao=async f=>{console.log("=== COMMENT DELETION DEBUG ==="),console.log("Attempting to delete comment",f),console.log("Current commentFeatures:",te),console.log(te[0].properties.comment),console.log(f.properties.comment);const m=te.filter(I=>I.properties.id!==f.properties.id);try{await ae.delete(`/mapFeature/propertyId/${f.properties.id}`,{headers:{Authorization:Ce}})}catch(I){console.error(I)}console.log("Updated commentFeatures after deletion:",m),ge("Successfully Removed Comment",{variant:"success"}),Z(m),refreshCommentLayer(),be({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),console.log("=== END DELETION DEBUG ===")};return we?g.jsxs($t,{children:[g.jsxs(fe,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[g.jsx(Pe,{variant:"h1",gutterBottom:!0,children:"Exterior (Map View)"}),g.jsx(Ge,{variant:"contained",onClick:()=>E(!0),disabled:_,children:"Upload New"})]}),g.jsx(Or,{open:y,onClose:()=>E(!1)}),g.jsx(jo,{links:mn,card:!0,custom:!0,rightAlign:!1}),g.jsx(Ho,{sx:{my:2}}),g.jsxs(fe,{display:"flex",height:"calc(100vh - 320px)",gap:1,children:[g.jsxs(fe,{sx:{width:"250px",pr:2,height:"100%"},children:[g.jsx(Pe,{onClick:()=>{const f=t.current.queryRenderedFeatures();console.log("Total Rendered Features:",f.length);const m=t.current.queryRenderedFeatures({layers:["overlay-fill-68ad75d9366cff02d631be9f","overlay-line-68ad75d9366cff02d631be9f","overlay-point-68ad75d9366cff02d631be9f"]});console.log("Overlay Rendered Features:",m.length)},variant:"h3",gutterBottom:!0,children:"Layers"}),g.jsxs(tr,{children:[g.jsx(ke,{control:g.jsx(Ue,{checked:a.orthomosaic,onChange:De,name:"orthomosaic",disabled:_}),label:"Orthomosaic"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.showLineString,onChange:De,name:"showLineString",disabled:_}),label:"Lines"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.showPolygons,onChange:De,name:"showPolygons",disabled:_}),label:"Polygons"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.showComments,onChange:De,name:"showComments",disabled:_}),label:"Comments"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.builtinOverlay,onChange:De,name:"builtinOverlay",disabled:_}),label:"CAD Overlay"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.shapeOverlay,onChange:De,name:"shapeOverlay",disabled:_}),label:"SHP Overlay"})]}),g.jsxs(Wo,{fullWidth:!0,sx:{mt:3},children:[g.jsx(Yo,{children:"Historical Data"}),g.jsx(Xo,{value:s||"",onChange:Po,label:"Historical Data",disabled:_||l.length===0,children:l.map(f=>g.jsx(Zo,{value:f,children:Ko(f).format("DD-MM-YYYY")},f))})]}),_&&g.jsx(fe,{sx:{display:"flex",justifyContent:"center",mt:2},children:g.jsx(ao,{size:24})}),!_&&l.length===0&&g.jsx(jt,{severity:"info",sx:{mt:2},children:"No historical data available for this project."})]}),g.jsx(fe,{ref:e,sx:{flex:1,borderRadius:2,overflow:"hidden",height:"100%",position:"relative",border:"1px solid #e0e0e0","& .mapboxgl-ctrl-scale":{border:"2px solid #333",borderTop:"none",color:"#333",backgroundColor:"rgba(255, 255, 255, 0.8)",padding:"2px 6px",fontSize:"12px",fontWeight:"bold"}}}),g.jsx(gn,{addCommentLayer:Oo,setCommentFeatures:Z,commentInput:Me,setCommentInput:be,commentFeatures:te,handleDeleteComment:Ao,workDay:V,drawRef:o.current})]})]}):g.jsx($t,{children:g.jsx(jt,{severity:"warning",children:"No project selected. Please select a project first."})})}export{Tn as default};
