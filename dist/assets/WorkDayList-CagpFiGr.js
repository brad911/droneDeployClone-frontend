import{aw as _e,t as ce,j as e,r as c,u as Pe,b as Fe,d as De,M as Me,B as p,T as y,S as re,af as Ae,b3 as Le,h as j}from"./index-BLy9ZLZ-.js";import{d as R}from"./dayjs.min-DEva5p_r.js";import{T as Ue}from"./TextField-Bk6Jrq2q.js";import{B as v,I as $e}from"./InputLabel-HXpEqKZ-.js";import{F as oe}from"./OutlinedInput-plb3PIeX.js";import{S as ne}from"./Select-Nt7Xxr__.js";import{M as ie}from"./MenuItem-Co4muxbj.js";import{a as Ne,b as Re,c as Ee,d as E,T as d,e as Ye}from"./TableRow-CE_PWqZ9.js";import{P as Be}from"./Pagination-BSdq-J5M.js";import{a as Ge,b as Oe,D as He}from"./DialogContent-Cf4CrW24.js";import{D as Xe}from"./DialogTitle-45-MXI7v.js";import"./FormHelperText-_XPFxAT3.js";import"./LastPage-CT58xXwA.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var Y=_e("outline","photo-edit","IconPhotoEdit",[["path",{d:"M15 8h.01",key:"svg-0"}],["path",{d:"M11 20h-4a3 3 0 0 1 -3 -3v-10a3 3 0 0 1 3 -3h10a3 3 0 0 1 3 3v4",key:"svg-1"}],["path",{d:"M4 15l4 -4c.928 -.893 2.072 -.893 3 0l3 3",key:"svg-2"}],["path",{d:"M14 14l1 -1c.31 -.298 .644 -.497 .987 -.596",key:"svg-3"}],["path",{d:"M18.42 15.61a2.1 2.1 0 0 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39z",key:"svg-4"}]]);const Ke=ce(e.jsx("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"})),le=ce(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"})),qe=[{value:"processing",label:"Processing"},{value:"completed",label:"Completed"},{value:"failed",label:"Failed"}],Ve=[{value:"createdAt:desc",label:"Newest"},{value:"createdAt:asc",label:"Oldest"},{value:"name:asc",label:"Name (A-Z)"},{value:"name:desc",label:"Name (Z-A)"}],pt=()=>{const w=c.useRef(null),m=Pe(),{enqueueSnackbar:i}=Fe(),[I,B]=c.useState([]),[de,G]=c.useState(!0),[O,H]=c.useState(null),[_,P]=c.useState(1),[F]=c.useState(10),[he,pe]=c.useState(0),[X,ue]=c.useState(""),[D,me]=c.useState("createdAt:desc"),[M,xe]=c.useState(""),g=De(t=>t.auth.token),[fe,K]=c.useState({}),T=c.useRef(null),[k,A]=c.useState({type:"",workDay:null}),[q,z]=c.useState({}),[S,V]=c.useState({}),[Z,L]=c.useState({open:!1,workDayId:null}),[C,J]=c.useState(!1);c.useEffect(()=>{(async()=>{var a,n,s,r,o,h;G(!0),H(null);try{const l={page:_,limit:F,sortBy:D};M&&(l.name=M);const x=await j.get("/work-day",{params:l,headers:{Authorization:g}});B(((a=x.data.data)==null?void 0:a.results)||[]),pe(((n=x.data.data)==null?void 0:n.totalResults)||0)}catch(l){console.log(l,"<===== error fetching workdays"),H(((r=(s=l.response)==null?void 0:s.data)==null?void 0:r.message)||l.message),i(((h=(o=l.response)==null?void 0:o.data)==null?void 0:h.message)||l.message||"Failed to fetch work days",{variant:"error"})}finally{G(!1)}})()},[g,_,F,D,M,i]);const ge=t=>t?t.url?t.url:t.Location?t.Location:null:null,ye=async t=>{var n,s,r;const a=t.rawFile;if(!a){i("No file found to download",{variant:"warning"});return}try{const h=(n=(await j.get(`/work-day/get-download-url/${a}`,{headers:{Authorization:g}})).data)==null?void 0:n.data;h?(window.open(h,"_blank"),i("Download started",{variant:"success"})):i("No download link available.",{variant:"warning"})}catch(o){i(((r=(s=o.response)==null?void 0:s.data)==null?void 0:r.message)||o.message||"Download failed",{variant:"error"})}},je=async(t,a)=>{var n,s;K(r=>({...r,[t._id||t.id]:!0}));try{await j.patch(`/work-day/${t._id||t.id}`,{status:a},{headers:{Authorization:g}}),B(r=>r.map(o=>(o._id||o.id)===(t._id||t.id)?{...o,status:a}:o)),i("Status updated!",{variant:"success"})}catch(r){i(((s=(n=r.response)==null?void 0:n.data)==null?void 0:s.message)||r.message||"Failed to update status",{variant:"error"})}finally{K(r=>({...r,[t._id||t.id]:!1}))}},Q=()=>{P(1),xe(X)},be=(t,a)=>{A({workDay:t,type:a}),T.current&&T.current.click()},ve=async t=>{var h,l,x,te;const a=(h=t.target.files)==null?void 0:h[0];if(!a||!k.type||!k.workDay)return;const{type:n,workDay:s}=k,r=a.name.split(".").pop().toLowerCase(),o=`${s.id||s._id}_${n}`;if(n==="tiff"&&r!=="tiff"&&r!=="tiff"){i(`Only .${n.toUpperCase()} files are allowed`,{variant:"error"});return}V(u=>({...u,[o]:!0})),z(u=>({...u,[o]:0}));try{const U=(await j.post("/work-day/upload-resultFile",{workDayId:s.id||s._id,type:n,filename:a.name,contentType:a.type,size:a.size},{headers:{Authorization:g}})).data.data;if(n==="kml"||n==="jpg"&&a.size<=52428800)await j.put(U.url,a,{headers:{"Content-Type":a.type},onUploadProgress:b=>{const $=Math.round(b.loaded*100/b.total);z(N=>({...N,[o]:$}))}}),i(`${n.toUpperCase()} uploaded successfully`,{variant:"success"});else if(n==="jpg"&&a.size>52428800){console.log(n,a.size,"<==="),console.log(U,"<==== wow owowowo");const{parts:b,uploadId:$,key:N,partSize:ke}=U,ae=[];let W=0;for(;W<a.size;){const f=Math.min(W+ke,a.size);ae.push(a.slice(W,f)),W=f}const se=[];for(let f=0;f<b.length;f++){const ze=(l=(await fetch(b[f].url,{method:"PUT",body:ae[f]})).headers.get("ETag"))==null?void 0:l.replace(/"/g,"");se.push({PartNumber:b[f].partNumber,ETag:ze});const We=Math.round((f+1)/b.length*100);z(Ie=>({...Ie,[o]:We}))}await j.post("/work-day/complete-upload",{workDayId:s.id||s._id,type:n,key:N,uploadId:$,parts:se},{headers:{Authorization:g}}),i("JPG uploaded successfully (multipart)",{variant:"success"})}}catch(u){i(((te=(x=u.response)==null?void 0:x.data)==null?void 0:te.message)||u.message||"Upload failed",{variant:"error"})}finally{V(u=>({...u,[o]:!1})),setTimeout(()=>{z(u=>({...u,[o]:0}))},2e3),T.current&&(T.current.value=""),A({type:"",workDay:null})}},we=t=>{const a=I.find(s=>(s._id||s.id)===t);if(!a){i("Work day not found",{variant:"error"});return}if(!(a.tiffFile&&a.tiffFile.trim()!=="")){i("Please upload .tiff first before generating tiles.",{variant:"warning"});return}L({open:!0,workDayId:t})},Te=async()=>{var a,n,s;const{workDayId:t}=Z;J(!0);try{(a=(await j.get(`/work-day/generate-tiles/${t}`,{headers:{Authorization:g}})).data)!=null&&a.success?(i("Tile generation started successfully! This process will take at least 10 minutes to complete.",{variant:"success"}),L({open:!1,workDayId:null})):i("Failed to start tile generation",{variant:"error"})}catch(r){i(((s=(n=r.response)==null?void 0:n.data)==null?void 0:s.message)||r.message||"Failed to generate tiles",{variant:"error"})}finally{J(!1)}},ee=()=>{L({open:!1,workDayId:null})},Se=t=>{A({workDay:t,type:"dxf"}),w.current&&w.current.click()},Ce=async()=>{var r,o,h,l;const{workDay:t}=k,a=(o=(r=w.current)==null?void 0:r.files)==null?void 0:o[0];if(!a){i("Please select a .dxf file",{variant:"warning"});return}if(a.name.split(".").pop().toLowerCase()!=="dxf"){i("Only .dxf files are allowed",{variant:"error"});return}i("Uploading DXF file",{variant:"info"});const s=new FormData;s.append("file",a);try{await j.post(`/mapFeature/overlayUpload/${t._id||t.id}`,s,{headers:{Authorization:g,"Content-Type":"multipart/form-data"}}),i("DXF uploaded successfully!",{variant:"success"}),w.current&&(w.current.value="")}catch(x){console.error("DXF upload failed",x),i(((l=(h=x.response)==null?void 0:h.data)==null?void 0:l.message)||x.message,{variant:"error"})}};return e.jsxs(Me,{children:[e.jsx(p,{children:e.jsx(y,{variant:"h2",mb:2,gutterBottom:!0,children:"Historical Work Days"})}),e.jsxs(re,{direction:{xs:"column",sm:"row"},spacing:2,mb:2,alignItems:"center",children:[e.jsx(Ue,{label:"Search by Project",size:"small",value:X,onChange:t=>ue(t.target.value),onKeyDown:t=>{t.key==="Enter"&&Q()}}),e.jsx(v,{variant:"contained",onClick:Q,sx:{minWidth:100},children:"Search"}),e.jsxs(oe,{size:"small",sx:{minWidth:150},children:[e.jsx($e,{children:"Sort By"}),e.jsx(ne,{value:D,label:"Sort By",onChange:t=>{me(t.target.value),P(1)},children:Ve.map(t=>e.jsx(ie,{value:t.value,children:t.label},t.value))})]})]}),de?e.jsx(y,{variant:"body1",children:"Loading work days..."}):O?e.jsx(y,{color:"error",children:O}):e.jsx(e.Fragment,{children:e.jsxs(Ae,{sx:{p:3,mx:"auto",mt:3},children:[e.jsx(Ne,{children:e.jsxs(Re,{size:"small",children:[e.jsx(Ee,{children:e.jsxs(E,{sx:{bgcolor:m.palette.primary.light},children:[e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Time Stamp"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Historical Date"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Project Name"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Project"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Owner"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Status"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Tiff"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Action"})]})}),e.jsx(Ye,{children:I.length===0?e.jsx(E,{children:e.jsx(d,{colSpan:7,align:"center",children:"No work days found."})}):I.map(t=>{var h;const a=(h=t.resultFiles)==null?void 0:h[0],n=!!ge(a),s=t._id||t.id,r=t.projectId||{},o=r.owner||{};return e.jsxs(E,{children:[e.jsx(d,{children:t.createdAt?R(t.createdAt).format("DD/MM/YYYY"):t.name}),e.jsx(d,{children:R(t.name,"YYYY-MM-DD",!0).isValid()?R(t.name).format("DD/MM/YYYY"):t.name||"-"}),e.jsx(d,{children:r.name||"-"}),e.jsx(d,{children:r.location||"-"}),e.jsx(d,{children:o.firstName||o.lastName?`${o.firstName||""} ${o.lastName||""}`.trim():o.email||"-"}),e.jsx(d,{children:e.jsx(oe,{size:"small",sx:{minWidth:120},children:e.jsx(ne,{value:t.status||"",onChange:l=>je(t,l.target.value),disabled:fe[s],children:qe.map(l=>e.jsx(ie,{value:l.value,children:l.label},l.value))})})}),e.jsx(d,{children:t.tiffFile?t.tiffFile.split("-")[5]:"-"}),e.jsx(d,{children:e.jsxs(re,{spacing:1,sx:{minWidth:200},children:[e.jsx(v,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(Ke,{}),onClick:()=>ye(t),disabled:!n&&!t.rawFile,fullWidth:!0,sx:{height:36,fontSize:"0.75rem",fontWeight:500,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:2}},children:"Download"}),e.jsxs(p,{children:[e.jsx(v,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(le,{}),onClick:()=>be(t,"jpg"),disabled:S[`${s}_jpg`],fullWidth:!0,sx:{height:36,fontSize:"0.75rem",fontWeight:500,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:2}},children:"Upload Tiff"}),S[`${s}_jpg`]&&e.jsxs(p,{sx:{mt:.5},children:[e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Uploading..."," ",q[`${s}_jpg`]||0,"%"]}),e.jsx(p,{sx:{width:"100%",mt:.5},children:e.jsx(p,{sx:{height:3,bgcolor:"grey.200",borderRadius:1.5,overflow:"hidden"},children:e.jsx(p,{sx:{width:`${q[`${s}_jpg`]||0}%`,height:"100%",bgcolor:"secondary.main",transition:"width 0.3s ease"}})})})]})]}),e.jsx(v,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(le,{}),onClick:()=>Se(t),disabled:S[`${t._id||t.id}_dxf`],fullWidth:!0,sx:{height:36,fontSize:"0.75rem",fontWeight:500,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:2}},children:"Upload DXF"}),e.jsx(v,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(Y,{}),onClick:()=>we(s),disabled:S[`${s}_jpg`]||S[`${s}_kml`],fullWidth:!0,sx:{height:36,fontSize:"0.75rem",fontWeight:500,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:2}},children:"Generate Tiles"})]})})]},s)})})]})}),e.jsx(p,{display:"flex",justifyContent:"center",mt:2,children:e.jsx(Be,{count:Math.ceil(he/F),page:_,onChange:(t,a)=>P(a),color:"primary"})})]})}),e.jsx("input",{type:"file",ref:T,style:{display:"none"},onChange:ve}),e.jsx("input",{type:"file",ref:w,style:{display:"none"},accept:".dxf",onChange:Ce}),e.jsxs(Ge,{open:Z.open,onClose:C?void 0:ee,"aria-labelledby":"generate-tiles-dialog-title","aria-describedby":"generate-tiles-dialog-description",PaperProps:{sx:{borderRadius:2,minWidth:400,boxShadow:"0 8px 32px rgba(0, 0, 0, 0.12)"}},children:[e.jsx(Xe,{id:"generate-tiles-dialog-title",sx:{bgcolor:"primary.light",color:"warning.contrastText",fontWeight:600,fontSize:"1.1rem"},children:"⚠️ Confirmation"}),e.jsx(Oe,{sx:{pt:3,pb:2},children:C?e.jsxs(p,{sx:{textAlign:"center",py:4},children:[e.jsx(p,{sx:{width:64,height:64,borderRadius:"50%",bgcolor:"primary.light",display:"flex",alignItems:"center",justifyContent:"center",mx:"auto",mb:2},children:e.jsx(Y,{sx:{color:"primary.light",fontSize:32}})}),e.jsx(y,{variant:"h6",sx:{fontWeight:600,mb:2,color:"text.primary"},children:"Generating Tiles..."}),e.jsx(y,{variant:"body1",sx:{color:"text.secondary",lineHeight:1.6,mb:3},children:"Please wait while we process your request. This may take several minutes."}),e.jsx(p,{sx:{width:"100%",maxWidth:300,mx:"auto"},children:e.jsx(Le,{})})]}):e.jsxs(p,{sx:{display:"flex",alignItems:"flex-start",gap:2,mt:2},children:[e.jsx(p,{sx:{width:48,height:48,borderRadius:"50%",bgcolor:"primary.light",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,mt:.5},children:e.jsx(Y,{sx:{color:"primary.light",fontSize:24}})}),e.jsxs(p,{children:[e.jsx(y,{variant:"h6",sx:{fontWeight:600,mb:1,color:"text.primary"},children:"Time-Intensive Operation"}),e.jsxs(y,{variant:"body1",id:"generate-tiles-dialog-description",sx:{color:"text.secondary",lineHeight:1.6},children:["This tile generation process will take at least"," ",e.jsx("strong",{children:"10 minutes"})," to complete. The system will process your data in the background."]})]})]})}),e.jsxs(He,{sx:{p:3,pt:1,gap:1},children:[e.jsx(v,{onClick:ee,variant:"outlined",disabled:C,sx:{color:"error.main",borderColor:"error.main",fontWeight:500,px:3,py:1,"&:hover":{bgcolor:"error.50",borderColor:"error.dark"},"&:disabled":{color:"grey.400",borderColor:"grey.300"}},children:"Cancel"}),e.jsx(v,{onClick:Te,variant:"contained",disabled:C,sx:{bgcolor:"primary.main",color:"white",fontWeight:500,px:3,py:1,"&:hover":{bgcolor:"secondary.light",color:"black"},"&:focus":{bgcolor:"primary.main"},"&:disabled":{bgcolor:"grey.300",color:"grey.500"}},children:C?"Processing...":"Proceed"})]})]})]})};export{pt as default};
