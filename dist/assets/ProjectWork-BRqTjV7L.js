import{am as No,al as Fo,E as Ye,j as h,r as F,an as Do,aq as De,N as ct,ao as Ro,i as io,ar as It,ap as ko,a6 as so,as as Uo,at as $t,au as Gt,av as Et,aw as ao,ak as At,b as Bo,d as Ne,ax as $o,B as fe,T as Pe,Y as lo,l as Ue,ay as Go,a3 as co,m as ae,ac as Vo,az as jo,a4 as ge,Q as Vt,aA as zo,aB as qo,aC as Jo,aD as Ho,D as Wo,k as ze,C as qe,F as Yo,I as Xo,y as Zo,M as Ko,aE as Qo}from"./index-CUEl61rj.js";import{m as se}from"./mapbox-gl-BPWDk9Xp.js";import{u as er,I as tr}from"./index-5V-rjSt-.js";import{F as or}from"./FormGroup-A0rqsv9Y.js";function rr(e){return Fo("MuiAlert",e)}const jt=No("MuiAlert",["root","action","icon","message","filled","colorSuccess","colorInfo","colorWarning","colorError","filledSuccess","filledInfo","filledWarning","filledError","outlined","outlinedSuccess","outlinedInfo","outlinedWarning","outlinedError","standard","standardSuccess","standardInfo","standardWarning","standardError"]),nr=Ye(h.jsx("path",{d:"M20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4C12.76,4 13.5,4.11 14.2, 4.31L15.77,2.74C14.61,2.26 13.34,2 12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0, 0 22,12M7.91,10.08L6.5,11.5L11,16L21,6L19.59,4.58L11,13.17L7.91,10.08Z"})),ir=Ye(h.jsx("path",{d:"M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"})),sr=Ye(h.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"})),ar=Ye(h.jsx("path",{d:"M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20, 12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10, 10 0 0,0 12,2M11,17H13V11H11V17Z"})),lr=Ye(h.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})),cr=e=>{const{variant:t,color:o,severity:r,classes:n}=e,i={root:["root",`color${It(o||r)}`,`${t}${It(o||r)}`,`${t}`],icon:["icon"],message:["message"],action:["action"]};return ko(i,rr,n)},ur=ct(so,{name:"MuiAlert",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:o}=e;return[t.root,t[o.variant],t[`${o.variant}${It(o.color||o.severity)}`]]}})(Uo(({theme:e})=>{const t=e.palette.mode==="light"?$t:Gt,o=e.palette.mode==="light"?Gt:$t;return{...e.typography.body2,backgroundColor:"transparent",display:"flex",padding:"6px 16px",variants:[...Object.entries(e.palette).filter(Et(["light"])).map(([r])=>({props:{colorSeverity:r,variant:"standard"},style:{color:e.vars?e.vars.palette.Alert[`${r}Color`]:t(e.palette[r].light,.6),backgroundColor:e.vars?e.vars.palette.Alert[`${r}StandardBg`]:o(e.palette[r].light,.9),[`& .${jt.icon}`]:e.vars?{color:e.vars.palette.Alert[`${r}IconColor`]}:{color:e.palette[r].main}}})),...Object.entries(e.palette).filter(Et(["light"])).map(([r])=>({props:{colorSeverity:r,variant:"outlined"},style:{color:e.vars?e.vars.palette.Alert[`${r}Color`]:t(e.palette[r].light,.6),border:`1px solid ${(e.vars||e).palette[r].light}`,[`& .${jt.icon}`]:e.vars?{color:e.vars.palette.Alert[`${r}IconColor`]}:{color:e.palette[r].main}}})),...Object.entries(e.palette).filter(Et(["dark"])).map(([r])=>({props:{colorSeverity:r,variant:"filled"},style:{fontWeight:e.typography.fontWeightMedium,...e.vars?{color:e.vars.palette.Alert[`${r}FilledColor`],backgroundColor:e.vars.palette.Alert[`${r}FilledBg`]}:{backgroundColor:e.palette.mode==="dark"?e.palette[r].dark:e.palette[r].main,color:e.palette.getContrastText(e.palette[r].main)}}}))]}})),dr=ct("div",{name:"MuiAlert",slot:"Icon"})({marginRight:12,padding:"7px 0",display:"flex",fontSize:22,opacity:.9}),pr=ct("div",{name:"MuiAlert",slot:"Message"})({padding:"8px 0",minWidth:0,overflow:"auto"}),fr=ct("div",{name:"MuiAlert",slot:"Action"})({display:"flex",alignItems:"flex-start",padding:"4px 0 0 16px",marginLeft:"auto",marginRight:-8}),zt={success:h.jsx(nr,{fontSize:"inherit"}),warning:h.jsx(ir,{fontSize:"inherit"}),error:h.jsx(sr,{fontSize:"inherit"}),info:h.jsx(ar,{fontSize:"inherit"})},qt=F.forwardRef(function(t,o){const r=Do({props:t,name:"MuiAlert"}),{action:n,children:i,className:s,closeText:c="Close",color:a,components:u={},componentsProps:y={},icon:m,iconMapping:l=zt,onClose:d,role:f="alert",severity:C="success",slotProps:S={},slots:D={},variant:V="standard",...$}=r,I={...r,color:a,severity:C,variant:V,colorSeverity:a||C},R=cr(I),ne={slots:{closeButton:u.CloseButton,closeIcon:u.CloseIcon,...D},slotProps:{...y,...S}},[W,Q]=De("root",{ref:o,shouldForwardComponentProp:!0,className:Ro(R.root,s),elementType:ur,externalForwardedProps:{...ne,...$},ownerState:I,additionalProps:{role:f,elevation:0}}),[Y,Ie]=De("icon",{className:R.icon,elementType:dr,externalForwardedProps:ne,ownerState:I}),[Ge,Ve]=De("message",{className:R.message,elementType:pr,externalForwardedProps:ne,ownerState:I}),[xe,Me]=De("action",{className:R.action,elementType:fr,externalForwardedProps:ne,ownerState:I}),[Le,J]=De("closeButton",{elementType:io,externalForwardedProps:ne,ownerState:I}),[be,we]=De("closeIcon",{elementType:lr,externalForwardedProps:ne,ownerState:I});return h.jsxs(W,{...Q,children:[m!==!1?h.jsx(Y,{...Ie,children:m||l[C]||zt[C]}):null,h.jsx(Ge,{...Ve,children:i}),n!=null?h.jsx(xe,{...Me,children:n}):null,n==null&&d?h.jsx(xe,{...Me,children:h.jsx(Le,{size:"small","aria-label":c,title:c,color:"inherit",onClick:d,...J,children:h.jsx(be,{fontSize:"small",...we})})}):null]})});/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var hr=ao("outline","trash","IconTrash",[["path",{d:"M4 7l16 0",key:"svg-0"}],["path",{d:"M10 11l0 6",key:"svg-1"}],["path",{d:"M14 11l0 6",key:"svg-2"}],["path",{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12",key:"svg-3"}],["path",{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3",key:"svg-4"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var gr=ao("outline","x","IconX",[["path",{d:"M18 6l-12 12",key:"svg-0"}],["path",{d:"M6 6l12 12",key:"svg-1"}]]),Qe={},Je={},Jt;function yr(){return Jt||(Jt=1,Je.RADIUS=6378137,Je.FLATTENING=1/298.257223563,Je.POLAR_RADIUS=63567523142e-4),Je}var Ht;function mr(){if(Ht)return Qe;Ht=1;var e=yr();Qe.geometry=t,Qe.ring=r;function t(i){var s=0,c;switch(i.type){case"Polygon":return o(i.coordinates);case"MultiPolygon":for(c=0;c<i.coordinates.length;c++)s+=o(i.coordinates[c]);return s;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(c=0;c<i.geometries.length;c++)s+=t(i.geometries[c]);return s}}function o(i){var s=0;if(i&&i.length>0){s+=Math.abs(r(i[0]));for(var c=1;c<i.length;c++)s-=Math.abs(r(i[c]))}return s}function r(i){var s,c,a,u,y,m,l,d=0,f=i.length;if(f>2){for(l=0;l<f;l++)l===f-2?(u=f-2,y=f-1,m=0):l===f-1?(u=f-1,y=0,m=1):(u=l,y=l+1,m=l+2),s=i[u],c=i[y],a=i[m],d+=(n(a[0])-n(s[0]))*Math.sin(n(c[1]));d=d*e.RADIUS*e.RADIUS/2}return d}function n(i){return i*Math.PI/180}return Qe}var Er=mr();const rt=At(Er);var ie=63710088e-1,uo={centimeters:ie*100,centimetres:ie*100,degrees:360/(2*Math.PI),feet:ie*3.28084,inches:ie*39.37,kilometers:ie/1e3,kilometres:ie/1e3,meters:ie,metres:ie,miles:ie/1609.344,millimeters:ie*1e3,millimetres:ie*1e3,nauticalmiles:ie/1852,radians:1,yards:ie*1.0936};function it(e,t,o={}){const r={type:"Feature"};return(o.id===0||o.id)&&(r.id=o.id),o.bbox&&(r.bbox=o.bbox),r.properties=t||{},r.geometry=e,r}function st(e,t,o={}){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!Wt(e[0])||!Wt(e[1]))throw new Error("coordinates must contain numbers");return it({type:"Point",coordinates:e},t,o)}function vr(e,t,o={}){if(e.length<2)throw new Error("coordinates must be an array of two or more positions");return it({type:"LineString",coordinates:e},t,o)}function Cr(e,t="kilometers"){const o=uo[t];if(!o)throw new Error(t+" units is invalid");return e*o}function Sr(e,t="kilometers"){const o=uo[t];if(!o)throw new Error(t+" units is invalid");return e/o}function Mt(e){return e%(2*Math.PI)*180/Math.PI}function ye(e){return e%360*Math.PI/180}function Wt(e){return!isNaN(e)&&e!==null&&!Array.isArray(e)}function We(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return[...e.geometry.coordinates];if(e.type==="Point")return[...e.coordinates]}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return[...e];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Tr(e){return e.type==="Feature"?e.geometry:e}function po(e,t,o={}){if(o.final===!0)return _r(e,t);const r=We(e),n=We(t),i=ye(r[0]),s=ye(n[0]),c=ye(r[1]),a=ye(n[1]),u=Math.sin(s-i)*Math.cos(a),y=Math.cos(c)*Math.sin(a)-Math.sin(c)*Math.cos(a)*Math.cos(s-i);return Mt(Math.atan2(u,y))}function _r(e,t){let o=po(t,e);return o=(o+180)%360,o}function Ir(e,t,o,r={}){const n=We(e),i=ye(n[0]),s=ye(n[1]),c=ye(o),a=Sr(t,r.units),u=Math.asin(Math.sin(s)*Math.cos(a)+Math.cos(s)*Math.sin(a)*Math.cos(c)),y=i+Math.atan2(Math.sin(c)*Math.sin(a)*Math.cos(s),Math.cos(a)-Math.sin(s)*Math.sin(u)),m=Mt(y),l=Mt(u);return st([m,l],r.properties)}function fo(e,t,o={}){var r=We(e),n=We(t),i=ye(n[1]-r[1]),s=ye(n[0]-r[0]),c=ye(r[1]),a=ye(n[1]),u=Math.pow(Math.sin(i/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(c)*Math.cos(a);return Cr(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),o.units)}function vt(e,t,o={}){const n=Tr(e).coordinates;let i=0;for(let s=0;s<n.length&&!(t>=i&&s===n.length-1);s++)if(i>=t){const c=t-i;if(c){const a=po(n[s],n[s-1])-180;return Ir(n[s],c,a,o)}else return st(n[s])}else i+=fo(n[s],n[s+1],o);return st(n[n.length-1])}function xt(e,t,o){if(e!==null)for(var r,n,i,s,c,a,u,y=0,m=0,l,d=e.type,f=d==="FeatureCollection",C=d==="Feature",S=f?e.features.length:1,D=0;D<S;D++){u=f?e.features[D].geometry:C?e.geometry:e,l=u?u.type==="GeometryCollection":!1,c=l?u.geometries.length:1;for(var V=0;V<c;V++){var $=0,I=0;if(s=l?u.geometries[V]:u,s!==null){a=s.coordinates;var R=s.type;switch(y=o&&(R==="Polygon"||R==="MultiPolygon")?1:0,R){case null:break;case"Point":if(t(a,m,D,$,I)===!1)return!1;m++,$++;break;case"LineString":case"MultiPoint":for(r=0;r<a.length;r++){if(t(a[r],m,D,$,I)===!1)return!1;m++,R==="MultiPoint"&&$++}R==="LineString"&&$++;break;case"Polygon":case"MultiLineString":for(r=0;r<a.length;r++){for(n=0;n<a[r].length-y;n++){if(t(a[r][n],m,D,$,I)===!1)return!1;m++}R==="MultiLineString"&&$++,R==="Polygon"&&I++}R==="Polygon"&&$++;break;case"MultiPolygon":for(r=0;r<a.length;r++){for(I=0,n=0;n<a[r].length;n++){for(i=0;i<a[r][n].length-y;i++){if(t(a[r][n][i],m,D,$,I)===!1)return!1;m++}I++}$++}break;case"GeometryCollection":for(r=0;r<s.geometries.length;r++)if(xt(s.geometries[r],t,o)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function Mr(e,t){var o,r,n,i,s,c,a,u,y,m,l=0,d=e.type==="FeatureCollection",f=e.type==="Feature",C=d?e.features.length:1;for(o=0;o<C;o++){for(c=d?e.features[o].geometry:f?e.geometry:e,u=d?e.features[o].properties:f?e.properties:{},y=d?e.features[o].bbox:f?e.bbox:void 0,m=d?e.features[o].id:f?e.id:void 0,a=c?c.type==="GeometryCollection":!1,s=a?c.geometries.length:1,n=0;n<s;n++){if(i=a?c.geometries[n]:c,i===null){if(t(null,l,u,y,m)===!1)return!1;continue}switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(t(i,l,u,y,m)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<i.geometries.length;r++)if(t(i.geometries[r],l,u,y,m)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}l++}}function br(e,t){Mr(e,function(o,r,n,i,s){var c=o===null?null:o.type;switch(c){case null:case"Point":case"LineString":case"Polygon":return t(it(o,n,{bbox:i,id:s}),r,0)===!1?!1:void 0}var a;switch(c){case"MultiPoint":a="Point";break;case"MultiLineString":a="LineString";break;case"MultiPolygon":a="Polygon";break}for(var u=0;u<o.coordinates.length;u++){var y=o.coordinates[u],m={type:a,coordinates:y};if(t(it(m,n),r,u)===!1)return!1}})}function Lr(e,t){br(e,function(o,r,n){var i=0;if(o.geometry){var s=o.geometry.type;if(!(s==="Point"||s==="MultiPoint")){var c,a=0,u=0,y=0;if(xt(o,function(m,l,d,f,C){if(c===void 0||r>a||f>u||C>y){c=m,a=r,u=f,y=C,i=0;return}var S=vr([c,m],o.properties);if(t(S,r,n,C,i)===!1)return!1;i++,c=m})===!1)return!1}}})}function wr(e,t,o){var r=o,n=!1;return Lr(e,function(i,s,c,a,u){n===!1&&o===void 0?r=i:r=t(r,i,s,c,a,u),n=!0}),r}var Ct,Yt;function Pr(){return Yt||(Yt=1,Ct=function e(t,o){if(t===o)return!0;if(t&&o&&typeof t=="object"&&typeof o=="object"){if(t.constructor!==o.constructor)return!1;var r,n,i;if(Array.isArray(t)){if(r=t.length,r!=o.length)return!1;for(n=r;n--!==0;)if(!e(t[n],o[n]))return!1;return!0}if(t.constructor===RegExp)return t.source===o.source&&t.flags===o.flags;if(t.valueOf!==Object.prototype.valueOf)return t.valueOf()===o.valueOf();if(t.toString!==Object.prototype.toString)return t.toString()===o.toString();if(i=Object.keys(t),r=i.length,r!==Object.keys(o).length)return!1;for(n=r;n--!==0;)if(!Object.prototype.hasOwnProperty.call(o,i[n]))return!1;for(n=r;n--!==0;){var s=i[n];if(!e(t[s],o[s]))return!1}return!0}return t!==t&&o!==o}),Ct}var Or=Pr();const Xt=At(Or);function St(e,t={}){let o=0,r=0,n=0;return xt(e,function(i){o+=i[0],r+=i[1],n++},!0),st([o/n,r/n],t.properties)}function et(e,t={}){return wr(e,(o,r)=>{const n=r.geometry.coordinates;return o+fo(n[0],n[1],t)},0)}const Ar=({open:e=!1,onClose:t,onSave:o})=>{const[r,n]=F.useState(null),[i,s]=F.useState(!1),[c,a]=F.useState(0),[u,y]=F.useState({date:new Date().toISOString().split("T")[0],file:null}),{enqueueSnackbar:m}=Bo(),l=Ne(I=>I.auth.token),d=Ne(I=>I.project.id);F.useEffect(()=>{e||(n(null),s(!1),a(0),y({date:new Date().toISOString().split("T")[0],file:null}))},[e]);const f=(I,R)=>{y(ne=>({...ne,[I]:R}))},C=I=>{I.length&&(n(I[0]),f("file",I[0]))},{getRootProps:S,getInputProps:D,isDragActive:V}=er({onDrop:C,multiple:!1,accept:{"application/zip":[".zip"]}}),$=async()=>{var I,R,ne;if(!u.file){m("Please select a file to upload.",{variant:"warning"});return}s(!0),a(0);try{const Q=(await ae.post("/work-day/get-url",{projectId:d,name:u.date,filename:u.file.name,contentType:u.file.type,size:u.file.size},{headers:{Authorization:l}})).data.data;if(console.log(Q,"<===== upload response"),!Q)throw new Error("Invalid upload response from server");if(Q.uploadType==="single"){if(!Q.url)throw new Error("Missing upload URL");try{await Vo.put(Q.url,u.file,{headers:{"Content-Type":u.file.type},onUploadProgress:Y=>{const Ie=Math.round(Y.loaded*100/Y.total);a(Ie)}})}catch(Y){throw console.error("❌ Single upload failed:",Y),new Error("Single upload failed")}}else if(Q.uploadType==="multipart"){const{parts:Y,uploadId:Ie,key:Ge,partSize:Ve}=Q,xe=[];let Me=0;for(;Me<u.file.size;){const J=Math.min(Me+Ve,u.file.size);xe.push(u.file.slice(Me,J)),Me=J}const Le=[];for(let J=0;J<Y.length;J++)try{const be=await fetch(Y[J].url,{method:"PUT",body:xe[J]});if(!be.ok)throw new Error(`Chunk ${J+1} upload failed`);const we=(I=be.headers.get("ETag"))==null?void 0:I.replace(/"/g,"");Le.push({PartNumber:Y[J].partNumber,ETag:we}),a(Math.round((J+1)/Y.length*100))}catch(be){throw console.error("❌ Chunk upload failed:",be),new Error("Multipart upload failed")}await ae.post("/work-day/complete-upload",{projectId:d,name:u.date,key:Ge,uploadId:Ie,parts:Le},{headers:{Authorization:l}})}m("Upload successful!",{variant:"success"}),m("Successfully Created Historical Data",{variant:"success"}),o&&o(),t()}catch(W){console.error(W),m(((ne=(R=W==null?void 0:W.response)==null?void 0:R.data)==null?void 0:ne.message)||W.message||"Upload failed.",{variant:"error"})}finally{s(!1),a(0)}};return h.jsx($o,{open:e,onClose:t,children:h.jsxs(fe,{sx:{outline:"none",width:400,maxWidth:"90vw",bgcolor:"background.paper",borderRadius:2,boxShadow:24,mx:"auto",mt:"10vh",p:3},children:[h.jsx(Pe,{variant:"h5",sx:{mb:2},children:"Upload New Capture Into Historical Data"}),h.jsxs(fe,{sx:{display:"flex",flexDirection:"column",gap:2},children:[h.jsx(lo,{label:"Date of Capture",type:"date",value:u.date,onChange:I=>f("date",I.target.value),fullWidth:!0,size:"small",disabled:i,InputLabelProps:{shrink:!0}}),h.jsxs(fe,{...S(),sx:{border:"2px dashed #ccc",borderRadius:"8px",padding:4,textAlign:"center",cursor:i?"not-allowed":"pointer",backgroundColor:V?"#f0f0f0":"transparent",mb:2,opacity:i?.5:1,pointerEvents:i?"none":"auto"},children:[h.jsx("input",{...D()}),h.jsx(tr,{size:32}),h.jsx(Pe,{variant:"h6",gutterBottom:!0,children:"Upload Zip File"}),h.jsx(Pe,{variant:"body2",sx:{mb:2},children:"Drag & drop your .zip file or click below to browse"}),h.jsx(Ue,{variant:"outlined",disabled:i,children:"Browse Files"}),r&&h.jsxs(Pe,{variant:"subtitle1",sx:{mt:1},children:["Selected: ",r.name]})]}),i&&h.jsxs(fe,{children:[h.jsxs(Pe,{variant:"body2",gutterBottom:!0,children:["Uploading... ",c,"%"]}),h.jsx(Go,{variant:"determinate",value:c})]}),h.jsxs(fe,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[h.jsx(Ue,{onClick:t,disabled:i,children:"Cancel"}),h.jsx(Ue,{variant:"contained",onClick:$,disabled:!u.file||i,startIcon:i&&h.jsx(co,{size:16}),children:i?"Uploading...":"Upload"})]})]})]})})},bt=function(e,t){const o={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},r={on(i,s,c){if(o[i]===void 0)throw new Error(`Invalid event type: ${i}`);o[i].push({selector:s,fn:c})},render(i){t.store.featureChanged(i)}},n=function(i,s){const c=o[i];let a=c.length;for(;a--;){const u=c[a];if(u.selector(s)){u.fn.call(r,s)||t.store.render(),t.ui.updateMapClasses();break}}};return e.start.call(r),{render:e.render,stop(){e.stop&&e.stop()},trash(){e.trash&&(e.trash(),t.store.render())},combineFeatures(){e.combineFeatures&&e.combineFeatures()},uncombineFeatures(){e.uncombineFeatures&&e.uncombineFeatures()},drag(i){n("drag",i)},click(i){n("click",i)},mousemove(i){n("mousemove",i)},mousedown(i){n("mousedown",i)},mouseup(i){n("mouseup",i)},mouseout(i){n("mouseout",i)},keydown(i){n("keydown",i)},keyup(i){n("keyup",i)},touchstart(i){n("touchstart",i)},touchmove(i){n("touchmove",i)},touchend(i){n("touchend",i)},tap(i){n("tap",i)}}},oe={CANVAS:"mapboxgl-canvas",CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},pe={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},G={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},re={POLYGON:"polygon",LINE:"line_string",POINT:"point"},E={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},M={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select"},Z={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},Xe={MOVE:"move",CHANGE_PROPERTIES:"change_properties",CHANGE_COORDINATES:"change_coordinates"},H={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},q={ACTIVE:"true",INACTIVE:"false"},ho=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],xr=-90,Lt=-85,Nr=90,wt=85,Fr=-270,Dr=270,go=Object.freeze(Object.defineProperty({__proto__:null,LAT_MAX:Nr,LAT_MIN:xr,LAT_RENDERED_MAX:wt,LAT_RENDERED_MIN:Lt,LNG_MAX:Dr,LNG_MIN:Fr,activeStates:q,classes:oe,cursors:G,events:Z,geojsonTypes:E,interactions:ho,meta:H,modes:M,sources:pe,types:re,updateActions:Xe},Symbol.toStringTag,{value:"Module"})),Zt={Point:0,LineString:1,MultiLineString:1,Polygon:2};function Rr(e,t){const o=Zt[e.geometry.type]-Zt[t.geometry.type];return o===0&&e.geometry.type===E.POLYGON?e.area-t.area:o}function yo(e){return e.map(t=>(t.geometry.type===E.POLYGON&&(t.area=rt.geometry({type:E.FEATURE,property:{},geometry:t.geometry})),t)).sort(Rr).map(t=>(delete t.area,t))}function mo(e,t=0){return[[e.point.x-t,e.point.y-t],[e.point.x+t,e.point.y+t]]}function he(e){if(this._items={},this._nums={},this._length=e?e.length:0,!!e)for(let t=0,o=e.length;t<o;t++)this.add(e[t]),e[t]!==void 0&&(typeof e[t]=="string"?this._items[e[t]]=t:this._nums[e[t]]=t)}he.prototype.add=function(e){return this.has(e)?this:(this._length++,typeof e=="string"?this._items[e]=this._length:this._nums[e]=this._length,this)};he.prototype.delete=function(e){return this.has(e)===!1?this:(this._length--,delete this._items[e],delete this._nums[e],this)};he.prototype.has=function(e){return typeof e!="string"&&typeof e!="number"?!1:this._items[e]!==void 0||this._nums[e]!==void 0};he.prototype.values=function(){const e=[];return Object.keys(this._items).forEach(t=>{e.push({k:t,v:this._items[t]})}),Object.keys(this._nums).forEach(t=>{e.push({k:JSON.parse(t),v:this._nums[t]})}),e.sort((t,o)=>t.v-o.v).map(t=>t.k)};he.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};const kr=[H.FEATURE,H.MIDPOINT,H.VERTEX],Be={click:Ur,touch:Br};function Ur(e,t,o){return Eo(e,t,o,o.options.clickBuffer)}function Br(e,t,o){return Eo(e,t,o,o.options.touchBuffer)}function Eo(e,t,o,r){if(o.map===null)return[];const n=e?mo(e,r):t,i={};o.options.styles&&(i.layers=o.options.styles.map(u=>u.id).filter(u=>o.map.getLayer(u)!=null));const s=o.map.queryRenderedFeatures(n,i).filter(u=>kr.indexOf(u.properties.meta)!==-1),c=new he,a=[];return s.forEach(u=>{const y=u.properties.id;c.has(y)||(c.add(y),a.push(u))}),yo(a)}function nt(e,t){const o=Be.click(e,null,t),r={mouse:G.NONE};return o[0]&&(r.mouse=o[0].properties.active===q.ACTIVE?G.MOVE:G.POINTER,r.feature=o[0].properties.meta),t.events.currentModeName().indexOf("draw")!==-1&&(r.mouse=G.ADD),t.ui.queueMapClasses(r),t.ui.updateMapClasses(),o[0]}function Nt(e,t){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)}const $r=4,Gr=12,Vr=500;function Pt(e,t,o={}){const r=o.fineTolerance!=null?o.fineTolerance:$r,n=o.grossTolerance!=null?o.grossTolerance:Gr,i=o.interval!=null?o.interval:Vr;e.point=e.point||t.point,e.time=e.time||t.time;const s=Nt(e.point,t.point);return s<r||s<n&&t.time-e.time<i}const jr=25,zr=250;function Ot(e,t,o={}){const r=o.tolerance!=null?o.tolerance:jr,n=o.interval!=null?o.interval:zr;return e.point=e.point||t.point,e.time=e.time||t.time,Nt(e.point,t.point)<r&&t.time-e.time<n}let qr=(e,t=21)=>(o=t)=>{let r="",n=o|0;for(;n--;)r+=e[Math.random()*e.length|0];return r};const Jr=qr("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",32);function Ft(){return Jr()}const K=function(e,t){this.ctx=e,this.properties=t.properties||{},this.coordinates=t.geometry.coordinates,this.id=t.id||Ft(),this.type=t.geometry.type};K.prototype.changed=function(){this.ctx.store.featureChanged(this.id)};K.prototype.incomingCoords=function(e){this.setCoordinates(e)};K.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};K.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))};K.prototype.setProperty=function(e,t){this.properties[e]=t};K.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:E.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))};K.prototype.internal=function(e){const t={id:this.id,meta:H.FEATURE,"meta:type":this.type,active:q.INACTIVE,mode:e};if(this.ctx.options.userProperties)for(const o in this.properties)t[`user_${o}`]=this.properties[o];return{type:E.FEATURE,properties:t,geometry:{coordinates:this.getCoordinates(),type:this.type}}};const Ae=function(e,t){K.call(this,e,t)};Ae.prototype=Object.create(K.prototype);Ae.prototype.isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"};Ae.prototype.updateCoordinate=function(e,t,o){arguments.length===3?this.coordinates=[t,o]:this.coordinates=[e,t],this.changed()};Ae.prototype.getCoordinate=function(){return this.getCoordinates()};const _e=function(e,t){K.call(this,e,t)};_e.prototype=Object.create(K.prototype);_e.prototype.isValid=function(){return this.coordinates.length>1};_e.prototype.addCoordinate=function(e,t,o){this.changed();const r=parseInt(e,10);this.coordinates.splice(r,0,[t,o])};_e.prototype.getCoordinate=function(e){const t=parseInt(e,10);return JSON.parse(JSON.stringify(this.coordinates[t]))};_e.prototype.removeCoordinate=function(e){this.changed(),this.coordinates.splice(parseInt(e,10),1)};_e.prototype.updateCoordinate=function(e,t,o){const r=parseInt(e,10);this.coordinates[r]=[t,o],this.changed()};const le=function(e,t){K.call(this,e,t),this.coordinates=this.coordinates.map(o=>o.slice(0,-1))};le.prototype=Object.create(K.prototype);le.prototype.isValid=function(){return this.coordinates.length===0?!1:this.coordinates.every(e=>e.length>2)};le.prototype.incomingCoords=function(e){this.coordinates=e.map(t=>t.slice(0,-1)),this.changed()};le.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};le.prototype.addCoordinate=function(e,t,o){this.changed();const r=e.split(".").map(i=>parseInt(i,10));this.coordinates[r[0]].splice(r[1],0,[t,o])};le.prototype.removeCoordinate=function(e){this.changed();const t=e.split(".").map(r=>parseInt(r,10)),o=this.coordinates[t[0]];o&&(o.splice(t[1],1),o.length<3&&this.coordinates.splice(t[0],1))};le.prototype.getCoordinate=function(e){const t=e.split(".").map(r=>parseInt(r,10)),o=this.coordinates[t[0]];return JSON.parse(JSON.stringify(o[t[1]]))};le.prototype.getCoordinates=function(){return this.coordinates.map(e=>e.concat([e[0]]))};le.prototype.updateCoordinate=function(e,t,o){this.changed();const r=e.split("."),n=parseInt(r[0],10),i=parseInt(r[1],10);this.coordinates[n]===void 0&&(this.coordinates[n]=[]),this.coordinates[n][i]=[t,o]};const Hr={MultiPoint:Ae,MultiLineString:_e,MultiPolygon:le},ut=(e,t,o,r,n)=>{const i=o.split("."),s=parseInt(i[0],10),c=i[1]?i.slice(1).join("."):null;return e[s][t](c,r,n)},X=function(e,t){if(K.call(this,e,t),delete this.coordinates,this.model=Hr[t.geometry.type],this.model===void 0)throw new TypeError(`${t.geometry.type} is not a valid type`);this.features=this._coordinatesToFeatures(t.geometry.coordinates)};X.prototype=Object.create(K.prototype);X.prototype._coordinatesToFeatures=function(e){const t=this.model.bind(this);return e.map(o=>new t(this.ctx,{id:Ft(),type:E.FEATURE,properties:{},geometry:{coordinates:o,type:this.type.replace("Multi","")}}))};X.prototype.isValid=function(){return this.features.every(e=>e.isValid())};X.prototype.setCoordinates=function(e){this.features=this._coordinatesToFeatures(e),this.changed()};X.prototype.getCoordinate=function(e){return ut(this.features,"getCoordinate",e)};X.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(e=>e.type===E.POLYGON?e.getCoordinates():e.coordinates)))};X.prototype.updateCoordinate=function(e,t,o){ut(this.features,"updateCoordinate",e,t,o),this.changed()};X.prototype.addCoordinate=function(e,t,o){ut(this.features,"addCoordinate",e,t,o),this.changed()};X.prototype.removeCoordinate=function(e){ut(this.features,"removeCoordinate",e),this.changed()};X.prototype.getFeatures=function(){return this.features};function T(e){this.map=e.map,this.drawConfig=JSON.parse(JSON.stringify(e.options||{})),this._ctx=e}T.prototype.setSelected=function(e){return this._ctx.store.setSelected(e)};T.prototype.setSelectedCoordinates=function(e){this._ctx.store.setSelectedCoordinates(e),e.reduce((t,o)=>(t[o.feature_id]===void 0&&(t[o.feature_id]=!0,this._ctx.store.get(o.feature_id).changed()),t),{})};T.prototype.getSelected=function(){return this._ctx.store.getSelected()};T.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()};T.prototype.isSelected=function(e){return this._ctx.store.isSelected(e)};T.prototype.getFeature=function(e){return this._ctx.store.get(e)};T.prototype.select=function(e){return this._ctx.store.select(e)};T.prototype.deselect=function(e){return this._ctx.store.deselect(e)};T.prototype.deleteFeature=function(e,t={}){return this._ctx.store.delete(e,t)};T.prototype.addFeature=function(e,t={}){return this._ctx.store.add(e,t)};T.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()};T.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()};T.prototype.setActionableState=function(e={}){const t={trash:e.trash||!1,combineFeatures:e.combineFeatures||!1,uncombineFeatures:e.uncombineFeatures||!1};return this._ctx.events.actionable(t)};T.prototype.changeMode=function(e,t={},o={}){return this._ctx.events.changeMode(e,t,o)};T.prototype.fire=function(e,t){return this._ctx.events.fire(e,t)};T.prototype.updateUIClasses=function(e){return this._ctx.ui.queueMapClasses(e)};T.prototype.activateUIButton=function(e){return this._ctx.ui.setActiveButton(e)};T.prototype.featuresAt=function(e,t,o="click"){if(o!=="click"&&o!=="touch")throw new Error("invalid buffer type");return Be[o](e,t,this._ctx)};T.prototype.newFeature=function(e){const t=e.geometry.type;return t===E.POINT?new Ae(this._ctx,e):t===E.LINE_STRING?new _e(this._ctx,e):t===E.POLYGON?new le(this._ctx,e):new X(this._ctx,e)};T.prototype.isInstanceOf=function(e,t){if(e===E.POINT)return t instanceof Ae;if(e===E.LINE_STRING)return t instanceof _e;if(e===E.POLYGON)return t instanceof le;if(e==="MultiFeature")return t instanceof X;throw new Error(`Unknown feature class: ${e}`)};T.prototype.doRender=function(e){return this._ctx.store.featureChanged(e)};T.prototype.onSetup=function(){};T.prototype.onDrag=function(){};T.prototype.onClick=function(){};T.prototype.onMouseMove=function(){};T.prototype.onMouseDown=function(){};T.prototype.onMouseUp=function(){};T.prototype.onMouseOut=function(){};T.prototype.onKeyUp=function(){};T.prototype.onKeyDown=function(){};T.prototype.onTouchStart=function(){};T.prototype.onTouchMove=function(){};T.prototype.onTouchEnd=function(){};T.prototype.onTap=function(){};T.prototype.onStop=function(){};T.prototype.onTrash=function(){};T.prototype.onCombineFeature=function(){};T.prototype.onUncombineFeature=function(){};T.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};const vo={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},Wr=Object.keys(vo);function Yr(e){const t=Object.keys(e);return function(o,r={}){let n={};const i=t.reduce((c,a)=>(c[a]=e[a],c),new T(o));function s(c){return a=>i[c](n,a)}return{start(){n=i.onSetup(r),Wr.forEach(c=>{const a=vo[c];let u=()=>!1;e[a]&&(u=()=>!0),this.on(c,u,s(a))})},stop(){i.onStop(n)},trash(){i.onTrash(n)},combineFeatures(){i.onCombineFeatures(n)},uncombineFeatures(){i.onUncombineFeatures(n)},render(c,a){i.toDisplayFeatures(n,c,a)}}}}function Xr(e){const t=Object.keys(e.options.modes).reduce((l,d)=>(l[d]=Yr(e.options.modes[d]),l),{});let o={},r={};const n={};let i=null,s=null;n.drag=function(l,d){d({point:l.point,time:new Date().getTime()})?(e.ui.queueMapClasses({mouse:G.DRAG}),s.drag(l)):l.originalEvent.stopPropagation()},n.mousedrag=function(l){n.drag(l,d=>!Pt(o,d))},n.touchdrag=function(l){n.drag(l,d=>!Ot(r,d))},n.mousemove=function(l){if((l.originalEvent.buttons!==void 0?l.originalEvent.buttons:l.originalEvent.which)===1)return n.mousedrag(l);const f=nt(l,e);l.featureTarget=f,s.mousemove(l)},n.mousedown=function(l){o={time:new Date().getTime(),point:l.point};const d=nt(l,e);l.featureTarget=d,s.mousedown(l)},n.mouseup=function(l){const d=nt(l,e);l.featureTarget=d,Pt(o,{point:l.point,time:new Date().getTime()})?s.click(l):s.mouseup(l)},n.mouseout=function(l){s.mouseout(l)},n.touchstart=function(l){if(!e.options.touchEnabled)return;r={time:new Date().getTime(),point:l.point};const d=Be.touch(l,null,e)[0];l.featureTarget=d,s.touchstart(l)},n.touchmove=function(l){if(e.options.touchEnabled)return s.touchmove(l),n.touchdrag(l)},n.touchend=function(l){if(l.originalEvent.preventDefault(),!e.options.touchEnabled)return;const d=Be.touch(l,null,e)[0];l.featureTarget=d,Ot(r,{time:new Date().getTime(),point:l.point})?s.tap(l):s.touchend(l)};const c=l=>!(l===8||l===46||l>=48&&l<=57);n.keydown=function(l){(l.srcElement||l.target).classList.contains(oe.CANVAS)&&((l.keyCode===8||l.keyCode===46)&&e.options.controls.trash?(l.preventDefault(),s.trash()):c(l.keyCode)?s.keydown(l):l.keyCode===49&&e.options.controls.point?a(M.DRAW_POINT):l.keyCode===50&&e.options.controls.line_string?a(M.DRAW_LINE_STRING):l.keyCode===51&&e.options.controls.polygon&&a(M.DRAW_POLYGON))},n.keyup=function(l){c(l.keyCode)&&s.keyup(l)},n.zoomend=function(){e.store.changeZoom()},n.data=function(l){if(l.dataType==="style"){const{setup:d,map:f,options:C,store:S}=e;C.styles.some(V=>f.getLayer(V.id))||(d.addLayers(),S.setDirty(),S.render())}};function a(l,d,f={}){s.stop();const C=t[l];if(C===void 0)throw new Error(`${l} is not valid`);i=l;const S=C(e,d);s=bt(S,e),f.silent||e.map.fire(Z.MODE_CHANGE,{mode:l}),e.store.setDirty(),e.store.render()}const u={trash:!1,combineFeatures:!1,uncombineFeatures:!1};function y(l){let d=!1;Object.keys(l).forEach(f=>{if(u[f]===void 0)throw new Error("Invalid action type");u[f]!==l[f]&&(d=!0),u[f]=l[f]}),d&&e.map.fire(Z.ACTIONABLE,{actions:u})}return{start(){i=e.options.defaultMode,s=bt(t[i](e),e)},changeMode:a,actionable:y,currentModeName(){return i},currentModeRender(l,d){return s.render(l,d)},fire(l,d){e.map&&e.map.fire(l,d)},addEventListeners(){e.map.on("mousemove",n.mousemove),e.map.on("mousedown",n.mousedown),e.map.on("mouseup",n.mouseup),e.map.on("data",n.data),e.map.on("touchmove",n.touchmove),e.map.on("touchstart",n.touchstart),e.map.on("touchend",n.touchend),e.container.addEventListener("mouseout",n.mouseout),e.options.keybindings&&(e.container.addEventListener("keydown",n.keydown),e.container.addEventListener("keyup",n.keyup))},removeEventListeners(){e.map.off("mousemove",n.mousemove),e.map.off("mousedown",n.mousedown),e.map.off("mouseup",n.mouseup),e.map.off("data",n.data),e.map.off("touchmove",n.touchmove),e.map.off("touchstart",n.touchstart),e.map.off("touchend",n.touchend),e.container.removeEventListener("mouseout",n.mouseout),e.options.keybindings&&(e.container.removeEventListener("keydown",n.keydown),e.container.removeEventListener("keyup",n.keyup))},trash(l){s.trash(l)},combineFeatures(){s.combineFeatures()},uncombineFeatures(){s.uncombineFeatures()},getMode(){return i}}}function Ze(e){return[].concat(e).filter(t=>t!==void 0)}function Zr(){const e=this;if(!(e.ctx.map&&e.ctx.map.getSource(pe.HOT)!==void 0))return a();const o=e.ctx.events.currentModeName();e.ctx.ui.queueMapClasses({mode:o});let r=[],n=[];e.isDirty?n=e.getAllIds():(r=e.getChangedIds().filter(u=>e.get(u)!==void 0),n=e.sources.hot.filter(u=>u.properties.id&&r.indexOf(u.properties.id)===-1&&e.get(u.properties.id)!==void 0).map(u=>u.properties.id)),e.sources.hot=[];const i=e.sources.cold.length;e.sources.cold=e.isDirty?[]:e.sources.cold.filter(u=>{const y=u.properties.id||u.properties.parent;return r.indexOf(y)===-1});const s=i!==e.sources.cold.length||n.length>0;r.forEach(u=>c(u,"hot")),n.forEach(u=>c(u,"cold"));function c(u,y){const l=e.get(u).internal(o);e.ctx.events.currentModeRender(l,d=>{d.properties.mode=o,e.sources[y].push(d)})}s&&e.ctx.map.getSource(pe.COLD).setData({type:E.FEATURE_COLLECTION,features:e.sources.cold}),e.ctx.map.getSource(pe.HOT).setData({type:E.FEATURE_COLLECTION,features:e.sources.hot}),a();function a(){e.isDirty=!1,e.clearChangedIds()}}function B(e){this._features={},this._featureIds=new he,this._selectedFeatureIds=new he,this._selectedCoordinates=[],this._changedFeatureIds=new he,this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=e,this.sources={hot:[],cold:[]};let t;this.render=()=>{t||(t=requestAnimationFrame(()=>{t=null,Zr.call(this),this._emitSelectionChange&&(this.ctx.events.fire(Z.SELECTION_CHANGE,{features:this.getSelected().map(o=>o.toGeoJSON()),points:this.getSelectedCoordinates().map(o=>({type:E.FEATURE,properties:{},geometry:{type:E.POINT,coordinates:o.coordinates}}))}),this._emitSelectionChange=!1),this.ctx.events.fire(Z.RENDER,{})}))},this.isDirty=!1}B.prototype.createRenderBatch=function(){const e=this.render;let t=0;return this.render=function(){t++},()=>{this.render=e,t>0&&this.render()}};B.prototype.setDirty=function(){return this.isDirty=!0,this};B.prototype.featureCreated=function(e,t={}){if(this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0){const r=this.get(e);this.ctx.events.fire(Z.CREATE,{features:[r.toGeoJSON()]})}return this};B.prototype.featureChanged=function(e,t={}){return this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0&&this.ctx.events.fire(Z.UPDATE,{action:t.action?t.action:Xe.CHANGE_COORDINATES,features:[this.get(e).toGeoJSON()]}),this};B.prototype.getChangedIds=function(){return this._changedFeatureIds.values()};B.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this};B.prototype.getAllIds=function(){return this._featureIds.values()};B.prototype.add=function(e,t={}){return this._features[e.id]=e,this._featureIds.add(e.id),this.featureCreated(e.id,{silent:t.silent}),this};B.prototype.delete=function(e,t={}){const o=[];return Ze(e).forEach(r=>{this._featureIds.has(r)&&(this._featureIds.delete(r),this._selectedFeatureIds.delete(r),t.silent||o.indexOf(this._features[r])===-1&&o.push(this._features[r].toGeoJSON()),delete this._features[r],this.isDirty=!0)}),o.length&&this.ctx.events.fire(Z.DELETE,{features:o}),Co(this,t),this};B.prototype.get=function(e){return this._features[e]};B.prototype.getAll=function(){return Object.keys(this._features).map(e=>this._features[e])};B.prototype.select=function(e,t={}){return Ze(e).forEach(o=>{this._selectedFeatureIds.has(o)||(this._selectedFeatureIds.add(o),this._changedFeatureIds.add(o),t.silent||(this._emitSelectionChange=!0))}),this};B.prototype.deselect=function(e,t={}){return Ze(e).forEach(o=>{this._selectedFeatureIds.has(o)&&(this._selectedFeatureIds.delete(o),this._changedFeatureIds.add(o),t.silent||(this._emitSelectionChange=!0))}),Co(this,t),this};B.prototype.clearSelected=function(e={}){return this.deselect(this._selectedFeatureIds.values(),{silent:e.silent}),this};B.prototype.setSelected=function(e,t={}){return e=Ze(e),this.deselect(this._selectedFeatureIds.values().filter(o=>e.indexOf(o)===-1),{silent:t.silent}),this.select(e.filter(o=>!this._selectedFeatureIds.has(o)),{silent:t.silent}),this};B.prototype.setSelectedCoordinates=function(e){return this._selectedCoordinates=e,this._emitSelectionChange=!0,this};B.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this};B.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()};B.prototype.getSelected=function(){return this.getSelectedIds().map(e=>this.get(e))};B.prototype.getSelectedCoordinates=function(){return this._selectedCoordinates.map(t=>({coordinates:this.get(t.feature_id).getCoordinate(t.coord_path)}))};B.prototype.isSelected=function(e){return this._selectedFeatureIds.has(e)};B.prototype.setFeatureProperty=function(e,t,o,r={}){this.get(e).setProperty(t,o),this.featureChanged(e,{silent:r.silent,action:Xe.CHANGE_PROPERTIES})};function Co(e,t={}){const o=e._selectedCoordinates.filter(r=>e._selectedFeatureIds.has(r.feature_id));e._selectedCoordinates.length!==o.length&&!t.silent&&(e._emitSelectionChange=!0),e._selectedCoordinates=o}B.prototype.storeMapConfig=function(){ho.forEach(e=>{this.ctx.map[e]&&(this._mapInitialConfig[e]=this.ctx.map[e].isEnabled())})};B.prototype.restoreMapConfig=function(){Object.keys(this._mapInitialConfig).forEach(e=>{this._mapInitialConfig[e]?this.ctx.map[e].enable():this.ctx.map[e].disable()})};B.prototype.getInitialConfigValue=function(e){return this._mapInitialConfig[e]!==void 0?this._mapInitialConfig[e]:!0};const Kr=["mode","feature","mouse"];function Qr(e){const t={};let o=null,r={mode:null,feature:null,mouse:null},n={mode:null,feature:null,mouse:null};function i(){s({mode:null,feature:null,mouse:null}),c()}function s(d){n=Object.assign(n,d)}function c(){if(!e.container)return;const d=[],f=[];Kr.forEach(C=>{n[C]!==r[C]&&(d.push(`${C}-${r[C]}`),n[C]!==null&&f.push(`${C}-${n[C]}`))}),d.length>0&&e.container.classList.remove(...d),f.length>0&&e.container.classList.add(...f),r=Object.assign(r,n)}function a(d,f={}){const C=document.createElement("button");return C.className=`${oe.CONTROL_BUTTON} ${f.className}`,C.setAttribute("title",f.title),f.container.appendChild(C),C.addEventListener("click",S=>{if(S.preventDefault(),S.stopPropagation(),S.target===o){u(),f.onDeactivate();return}y(d),f.onActivate()},!0),C}function u(){o&&(o.classList.remove(oe.ACTIVE_BUTTON),o=null)}function y(d){u();const f=t[d];f&&f&&d!=="trash"&&(f.classList.add(oe.ACTIVE_BUTTON),o=f)}function m(){const d=e.options.controls,f=document.createElement("div");return f.className=`${oe.CONTROL_GROUP} ${oe.CONTROL_BASE}`,d&&(d[re.LINE]&&(t[re.LINE]=a(re.LINE,{container:f,className:oe.CONTROL_BUTTON_LINE,title:`LineString tool ${e.options.keybindings?"(l)":""}`,onActivate:()=>e.events.changeMode(M.DRAW_LINE_STRING),onDeactivate:()=>e.events.trash()})),d[re.POLYGON]&&(t[re.POLYGON]=a(re.POLYGON,{container:f,className:oe.CONTROL_BUTTON_POLYGON,title:`Polygon tool ${e.options.keybindings?"(p)":""}`,onActivate:()=>e.events.changeMode(M.DRAW_POLYGON),onDeactivate:()=>e.events.trash()})),d[re.POINT]&&(t[re.POINT]=a(re.POINT,{container:f,className:oe.CONTROL_BUTTON_POINT,title:`Marker tool ${e.options.keybindings?"(m)":""}`,onActivate:()=>e.events.changeMode(M.DRAW_POINT),onDeactivate:()=>e.events.trash()})),d.trash&&(t.trash=a("trash",{container:f,className:oe.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:()=>{e.events.trash()}})),d.combine_features&&(t.combine_features=a("combineFeatures",{container:f,className:oe.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:()=>{e.events.combineFeatures()}})),d.uncombine_features&&(t.uncombine_features=a("uncombineFeatures",{container:f,className:oe.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:()=>{e.events.uncombineFeatures()}}))),f}function l(){Object.keys(t).forEach(d=>{const f=t[d];f.parentNode&&f.parentNode.removeChild(f),delete t[d]})}return{setActiveButton:y,queueMapClasses:s,updateMapClasses:c,clearMapClasses:i,addButtons:m,removeButtons:l}}function en(e){let t=null,o=null;const r={onRemove(){return e.map.off("load",r.connect),clearInterval(o),r.removeLayers(),e.store.restoreMapConfig(),e.ui.removeButtons(),e.events.removeEventListeners(),e.ui.clearMapClasses(),e.boxZoomInitial&&e.map.boxZoom.enable(),e.map=null,e.container=null,e.store=null,t&&t.parentNode&&t.parentNode.removeChild(t),t=null,this},connect(){e.map.off("load",r.connect),clearInterval(o),r.addLayers(),e.store.storeMapConfig(),e.events.addEventListeners()},onAdd(n){if(e.map=n,e.events=Xr(e),e.ui=Qr(e),e.container=n.getContainer(),e.store=new B(e),t=e.ui.addButtons(),e.options.boxSelect){e.boxZoomInitial=n.boxZoom.isEnabled(),n.boxZoom.disable();const i=n.dragPan.isEnabled();n.dragPan.disable(),n.dragPan.enable(),i||n.dragPan.disable()}return n.loaded()?r.connect():(n.on("load",r.connect),o=setInterval(()=>{n.loaded()&&r.connect()},16)),e.events.start(),t},addLayers(){e.map.addSource(pe.COLD,{data:{type:E.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.map.addSource(pe.HOT,{data:{type:E.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.options.styles.forEach(n=>{e.map.addLayer(n)}),e.store.setDirty(!0),e.store.render()},removeLayers(){e.options.styles.forEach(n=>{e.map.getLayer(n.id)&&e.map.removeLayer(n.id)}),e.map.getSource(pe.COLD)&&e.map.removeSource(pe.COLD),e.map.getSource(pe.HOT)&&e.map.removeSource(pe.HOT)}};return e.setup=r,r}const Tt="#3bb2d0",He="#fbb03b",Kt="#fff",So=[{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"]],paint:{"fill-color":["case",["==",["get","active"],"true"],He,Tt],"fill-opacity":.1}},{id:"gl-draw-lines",type:"line",filter:["any",["==","$type","LineString"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["case",["==",["get","active"],"true"],He,Tt],"line-dasharray":["case",["==",["get","active"],"true"],[.2,2],[2,0]],"line-width":2}},{id:"gl-draw-point-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Kt}},{id:"gl-draw-point-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":["case",["==",["get","active"],"true"],He,Tt]}},{id:"gl-draw-vertex-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Kt}},{id:"gl-draw-vertex-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":He}},{id:"gl-draw-midpoint",type:"circle",filter:["all",["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":He}}];function dt(e){return function(t){const o=t.featureTarget;return!o||!o.properties?!1:o.properties.meta===e}}function To(e){return!e.originalEvent||!e.originalEvent.shiftKey?!1:e.originalEvent.button===0}function Fe(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===q.ACTIVE&&e.featureTarget.properties.meta===H.FEATURE}function Dt(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===q.INACTIVE&&e.featureTarget.properties.meta===H.FEATURE}function pt(e){return e.featureTarget===void 0}function Rt(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.meta===H.FEATURE}function Ke(e){const t=e.featureTarget;return!t||!t.properties?!1:t.properties.meta===H.VERTEX}function at(e){return e.originalEvent?e.originalEvent.shiftKey===!0:!1}function ft(e){return e.keyCode===27}function ht(e){return e.keyCode===13}function tn(){return!0}const on=Object.freeze(Object.defineProperty({__proto__:null,isActiveFeature:Fe,isEnterKey:ht,isEscapeKey:ft,isFeature:Rt,isInactiveFeature:Dt,isOfMetaType:dt,isShiftDown:at,isShiftMousedown:To,isTrue:tn,isVertex:Ke,noTarget:pt},Symbol.toStringTag,{value:"Module"}));function Oe(e,t){this.x=e,this.y=t}Oe.prototype={clone(){return new Oe(this.x,this.y)},add(e){return this.clone()._add(e)},sub(e){return this.clone()._sub(e)},multByPoint(e){return this.clone()._multByPoint(e)},divByPoint(e){return this.clone()._divByPoint(e)},mult(e){return this.clone()._mult(e)},div(e){return this.clone()._div(e)},rotate(e){return this.clone()._rotate(e)},rotateAround(e,t){return this.clone()._rotateAround(e,t)},matMult(e){return this.clone()._matMult(e)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(e){return this.x===e.x&&this.y===e.y},dist(e){return Math.sqrt(this.distSqr(e))},distSqr(e){const t=e.x-this.x,o=e.y-this.y;return t*t+o*o},angle(){return Math.atan2(this.y,this.x)},angleTo(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith(e){return this.angleWithSep(e.x,e.y)},angleWithSep(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult(e){const t=e[0]*this.x+e[1]*this.y,o=e[2]*this.x+e[3]*this.y;return this.x=t,this.y=o,this},_add(e){return this.x+=e.x,this.y+=e.y,this},_sub(e){return this.x-=e.x,this.y-=e.y,this},_mult(e){return this.x*=e,this.y*=e,this},_div(e){return this.x/=e,this.y/=e,this},_multByPoint(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint(e){return this.x/=e.x,this.y/=e.y,this},_unit(){return this._div(this.mag()),this},_perp(){const e=this.y;return this.y=this.x,this.x=-e,this},_rotate(e){const t=Math.cos(e),o=Math.sin(e),r=t*this.x-o*this.y,n=o*this.x+t*this.y;return this.x=r,this.y=n,this},_rotateAround(e,t){const o=Math.cos(e),r=Math.sin(e),n=t.x+o*(this.x-t.x)-r*(this.y-t.y),i=t.y+r*(this.x-t.x)+o*(this.y-t.y);return this.x=n,this.y=i,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Oe};Oe.convert=function(e){if(e instanceof Oe)return e;if(Array.isArray(e))return new Oe(+e[0],+e[1]);if(e.x!==void 0&&e.y!==void 0)return new Oe(+e.x,+e.y);throw new Error("Expected [x, y] or {x, y} point format")};function kt(e,t){const o=t.getBoundingClientRect();return new Oe(e.clientX-o.left-(t.clientLeft||0),e.clientY-o.top-(t.clientTop||0))}function $e(e,t,o,r){return{type:E.FEATURE,properties:{meta:H.VERTEX,parent:e,coord_path:o,active:r?q.ACTIVE:q.INACTIVE},geometry:{type:E.POINT,coordinates:t}}}function _o(e,t,o){const r=t.geometry.coordinates,n=o.geometry.coordinates;if(r[1]>wt||r[1]<Lt||n[1]>wt||n[1]<Lt)return null;const i={lng:(r[0]+n[0])/2,lat:(r[1]+n[1])/2};return{type:E.FEATURE,properties:{meta:H.MIDPOINT,parent:e,lng:i.lng,lat:i.lat,coord_path:o.properties.coord_path},geometry:{type:E.POINT,coordinates:[i.lng,i.lat]}}}function gt(e,t={},o=null){const{type:r,coordinates:n}=e.geometry,i=e.properties&&e.properties.id;let s=[];r===E.POINT?s.push($e(i,n,o,a(o))):r===E.POLYGON?n.forEach((y,m)=>{c(y,o!==null?`${o}.${m}`:String(m))}):r===E.LINE_STRING?c(n,o):r.indexOf(E.MULTI_PREFIX)===0&&u();function c(y,m){let l="",d=null;y.forEach((f,C)=>{const S=m!=null?`${m}.${C}`:String(C),D=$e(i,f,S,a(S));if(t.midpoints&&d){const $=_o(i,d,D);$&&s.push($)}d=D;const V=JSON.stringify(f);l!==V&&s.push(D),C===0&&(l=V)})}function a(y){return t.selectedPaths?t.selectedPaths.indexOf(y)!==-1:!1}function u(){const y=r.replace(E.MULTI_PREFIX,"");n.forEach((m,l)=>{const d={type:E.FEATURE,properties:e.properties,geometry:{type:y,coordinates:m}};s=s.concat(gt(d,t,l))})}return s}const me={enable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||!e._ctx||!e._ctx.store||!e._ctx.store.getInitialConfigValue||e._ctx.store.getInitialConfigValue("doubleClickZoom")&&e.map.doubleClickZoom.enable()},0)},disable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||e.map.doubleClickZoom.disable()},0)}},{LAT_MIN:tt,LAT_MAX:ot,LAT_RENDERED_MIN:Qt,LAT_RENDERED_MAX:eo,LNG_MIN:to,LNG_MAX:oo}=go;function rn(e){const t={Point:0,LineString:1,Polygon:2,MultiPoint:1,MultiLineString:2,MultiPolygon:3}[e.geometry.type],o=[e.geometry.coordinates].flat(t),r=o.map(c=>c[0]),n=o.map(c=>c[1]),i=c=>Math.min.apply(null,c),s=c=>Math.max.apply(null,c);return[i(r),i(n),s(r),s(n)]}function Ut(e,t){let o=tt,r=ot,n=tt,i=ot,s=oo,c=to;e.forEach(u=>{const y=rn(u),m=y[1],l=y[3],d=y[0],f=y[2];m>o&&(o=m),l<r&&(r=l),l>n&&(n=l),m<i&&(i=m),d<s&&(s=d),f>c&&(c=f)});const a=t;return o+a.lat>eo&&(a.lat=eo-o),n+a.lat>ot&&(a.lat=ot-n),r+a.lat<Qt&&(a.lat=Qt-r),i+a.lat<tt&&(a.lat=tt-i),s+a.lng<=to&&(a.lng+=Math.ceil(Math.abs(a.lng)/360)*360),c+a.lng>=oo&&(a.lng-=Math.ceil(Math.abs(a.lng)/360)*360),a}function Bt(e,t){const o=Ut(e.map(r=>r.toGeoJSON()),t);e.forEach(r=>{const n=r.getCoordinates(),i=u=>{const y={lng:u[0]+o.lng,lat:u[1]+o.lat};return[y.lng,y.lat]},s=u=>u.map(y=>i(y)),c=u=>u.map(y=>s(y));let a;r.type===E.POINT?a=i(n):r.type===E.LINE_STRING||r.type===E.MULTI_POINT?a=n.map(i):r.type===E.POLYGON||r.type===E.MULTI_LINE_STRING?a=n.map(s):r.type===E.MULTI_POLYGON&&(a=n.map(c)),r.incomingCoords(a)})}const k={};k.onSetup=function(e){const t={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initialDragPanState:this.map.dragPan.isEnabled(),initiallySelectedFeatureIds:e.featureIds||[]};return this.setSelected(t.initiallySelectedFeatureIds.filter(o=>this.getFeature(o)!==void 0)),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),t};k.fireUpdate=function(){this.fire(Z.UPDATE,{action:Xe.MOVE,features:this.getSelected().map(e=>e.toGeoJSON())})};k.fireActionable=function(){const e=this.getSelected(),t=e.filter(i=>this.isInstanceOf("MultiFeature",i));let o=!1;if(e.length>1){o=!0;const i=e[0].type.replace("Multi","");e.forEach(s=>{s.type.replace("Multi","")!==i&&(o=!1)})}const r=t.length>0,n=e.length>0;this.setActionableState({combineFeatures:o,uncombineFeatures:r,trash:n})};k.getUniqueIds=function(e){return e.length?e.map(o=>o.properties.id).filter(o=>o!==void 0).reduce((o,r)=>(o.add(r),o),new he).values():[]};k.stopExtendedInteractions=function(e){e.boxSelectElement&&(e.boxSelectElement.parentNode&&e.boxSelectElement.parentNode.removeChild(e.boxSelectElement),e.boxSelectElement=null),(e.canDragMove||e.canBoxSelect)&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.boxSelecting=!1,e.canBoxSelect=!1,e.dragMoving=!1,e.canDragMove=!1};k.onStop=function(){me.enable(this)};k.onMouseMove=function(e,t){return Rt(t)&&e.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(e),!0};k.onMouseOut=function(e){return e.dragMoving?this.fireUpdate():!0};k.onTap=k.onClick=function(e,t){if(pt(t))return this.clickAnywhere(e,t);if(dt(H.VERTEX)(t))return this.clickOnVertex(e,t);if(Rt(t))return this.clickOnFeature(e,t)};k.clickAnywhere=function(e){const t=this.getSelectedIds();t.length&&(this.clearSelectedFeatures(),t.forEach(o=>this.doRender(o))),me.enable(this),this.stopExtendedInteractions(e)};k.clickOnVertex=function(e,t){this.changeMode(M.DIRECT_SELECT,{featureId:t.featureTarget.properties.parent,coordPath:t.featureTarget.properties.coord_path,startPos:t.lngLat}),this.updateUIClasses({mouse:G.MOVE})};k.startOnActiveFeature=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),this.doRender(t.featureTarget.properties.id),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};k.clickOnFeature=function(e,t){me.disable(this),this.stopExtendedInteractions(e);const o=at(t),r=this.getSelectedIds(),n=t.featureTarget.properties.id,i=this.isSelected(n);if(!o&&i&&this.getFeature(n).type!==E.POINT)return this.changeMode(M.DIRECT_SELECT,{featureId:n});i&&o?(this.deselect(n),this.updateUIClasses({mouse:G.POINTER}),r.length===1&&me.enable(this)):!i&&o?(this.select(n),this.updateUIClasses({mouse:G.MOVE})):!i&&!o&&(r.forEach(s=>this.doRender(s)),this.setSelected(n),this.updateUIClasses({mouse:G.MOVE})),this.doRender(n)};k.onMouseDown=function(e,t){if(e.initialDragPanState=this.map.dragPan.isEnabled(),Fe(t))return this.startOnActiveFeature(e,t);if(this.drawConfig.boxSelect&&To(t))return this.startBoxSelect(e,t)};k.startBoxSelect=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),e.boxSelectStartLocation=kt(t.originalEvent,this.map.getContainer()),e.canBoxSelect=!0};k.onTouchStart=function(e,t){if(Fe(t))return this.startOnActiveFeature(e,t)};k.onDrag=function(e,t){if(e.canDragMove)return this.dragMove(e,t);if(this.drawConfig.boxSelect&&e.canBoxSelect)return this.whileBoxSelect(e,t)};k.whileBoxSelect=function(e,t){e.boxSelecting=!0,this.updateUIClasses({mouse:G.ADD}),e.boxSelectElement||(e.boxSelectElement=document.createElement("div"),e.boxSelectElement.classList.add(oe.BOX_SELECT),this.map.getContainer().appendChild(e.boxSelectElement));const o=kt(t.originalEvent,this.map.getContainer()),r=Math.min(e.boxSelectStartLocation.x,o.x),n=Math.max(e.boxSelectStartLocation.x,o.x),i=Math.min(e.boxSelectStartLocation.y,o.y),s=Math.max(e.boxSelectStartLocation.y,o.y),c=`translate(${r}px, ${i}px)`;e.boxSelectElement.style.transform=c,e.boxSelectElement.style.WebkitTransform=c,e.boxSelectElement.style.width=`${n-r}px`,e.boxSelectElement.style.height=`${s-i}px`};k.dragMove=function(e,t){e.dragMoving=!0,t.originalEvent.stopPropagation();const o={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};Bt(this.getSelected(),o),e.dragMoveLocation=t.lngLat};k.onTouchEnd=k.onMouseUp=function(e,t){if(e.dragMoving)this.fireUpdate();else if(e.boxSelecting){const o=[e.boxSelectStartLocation,kt(t.originalEvent,this.map.getContainer())],r=this.featuresAt(null,o,"click"),n=this.getUniqueIds(r).filter(i=>!this.isSelected(i));n.length&&(this.select(n),n.forEach(i=>this.doRender(i)),this.updateUIClasses({mouse:G.MOVE}))}this.stopExtendedInteractions(e)};k.toDisplayFeatures=function(e,t,o){t.properties.active=this.isSelected(t.properties.id)?q.ACTIVE:q.INACTIVE,o(t),this.fireActionable(),!(t.properties.active!==q.ACTIVE||t.geometry.type===E.POINT)&&gt(t).forEach(o)};k.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()};k.onCombineFeatures=function(){const e=this.getSelected();if(e.length===0||e.length<2)return;const t=[],o=[],r=e[0].type.replace("Multi","");for(let n=0;n<e.length;n++){const i=e[n];if(i.type.replace("Multi","")!==r)return;i.type.includes("Multi")?i.getCoordinates().forEach(s=>{t.push(s)}):t.push(i.getCoordinates()),o.push(i.toGeoJSON())}if(o.length>1){const n=this.newFeature({type:E.FEATURE,properties:o[0].properties,geometry:{type:`Multi${r}`,coordinates:t}});this.addFeature(n),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([n.id]),this.fire(Z.COMBINE_FEATURES,{createdFeatures:[n.toGeoJSON()],deletedFeatures:o})}this.fireActionable()};k.onUncombineFeatures=function(){const e=this.getSelected();if(e.length===0)return;const t=[],o=[];for(let r=0;r<e.length;r++){const n=e[r];this.isInstanceOf("MultiFeature",n)&&(n.getFeatures().forEach(i=>{this.addFeature(i),i.properties=n.properties,t.push(i.toGeoJSON()),this.select([i.id])}),this.deleteFeature(n.id,{silent:!0}),o.push(n.toGeoJSON()))}t.length>1&&this.fire(Z.UNCOMBINE_FEATURES,{createdFeatures:t,deletedFeatures:o}),this.fireActionable()};const Io=dt(H.VERTEX),Mo=dt(H.MIDPOINT),U={};U.fireUpdate=function(){this.fire(Z.UPDATE,{action:Xe.CHANGE_COORDINATES,features:this.getSelected().map(e=>e.toGeoJSON())})};U.fireActionable=function(e){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:e.selectedCoordPaths.length>0})};U.startDragging=function(e,t){e.initialDragPanState=this.map.dragPan.isEnabled(),this.map.dragPan.disable(),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};U.stopDragging=function(e){e.canDragMove&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.dragMoving=!1,e.canDragMove=!1,e.dragMoveLocation=null};U.onVertex=function(e,t){this.startDragging(e,t);const o=t.featureTarget.properties,r=e.selectedCoordPaths.indexOf(o.coord_path);!at(t)&&r===-1?e.selectedCoordPaths=[o.coord_path]:at(t)&&r===-1&&e.selectedCoordPaths.push(o.coord_path);const n=this.pathsToCoordinates(e.featureId,e.selectedCoordPaths);this.setSelectedCoordinates(n)};U.onMidpoint=function(e,t){this.startDragging(e,t);const o=t.featureTarget.properties;e.feature.addCoordinate(o.coord_path,o.lng,o.lat),this.fireUpdate(),e.selectedCoordPaths=[o.coord_path]};U.pathsToCoordinates=function(e,t){return t.map(o=>({feature_id:e,coord_path:o}))};U.onFeature=function(e,t){e.selectedCoordPaths.length===0?this.startDragging(e,t):this.stopDragging(e)};U.dragFeature=function(e,t,o){Bt(this.getSelected(),o),e.dragMoveLocation=t.lngLat};U.dragVertex=function(e,t,o){const r=e.selectedCoordPaths.map(s=>e.feature.getCoordinate(s)),n=r.map(s=>({type:E.FEATURE,properties:{},geometry:{type:E.POINT,coordinates:s}})),i=Ut(n,o);for(let s=0;s<r.length;s++){const c=r[s];e.feature.updateCoordinate(e.selectedCoordPaths[s],c[0]+i.lng,c[1]+i.lat)}};U.clickNoTarget=function(){this.changeMode(M.SIMPLE_SELECT)};U.clickInactive=function(){this.changeMode(M.SIMPLE_SELECT)};U.clickActiveFeature=function(e){e.selectedCoordPaths=[],this.clearSelectedCoordinates(),e.feature.changed()};U.onSetup=function(e){const t=e.featureId,o=this.getFeature(t);if(!o)throw new Error("You must provide a featureId to enter direct_select mode");if(o.type===E.POINT)throw new TypeError("direct_select mode doesn't handle point features");const r={featureId:t,feature:o,dragMoveLocation:e.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:e.coordPath?[e.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(t,r.selectedCoordPaths)),this.setSelected(t),me.disable(this),this.setActionableState({trash:!0}),r};U.onStop=function(){me.enable(this),this.clearSelectedCoordinates()};U.toDisplayFeatures=function(e,t,o){e.featureId===t.properties.id?(t.properties.active=q.ACTIVE,o(t),gt(t,{map:this.map,midpoints:!0,selectedPaths:e.selectedCoordPaths}).forEach(o)):(t.properties.active=q.INACTIVE,o(t)),this.fireActionable(e)};U.onTrash=function(e){e.selectedCoordPaths.sort((t,o)=>o.localeCompare(t,"en",{numeric:!0})).forEach(t=>e.feature.removeCoordinate(t)),this.fireUpdate(),e.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(e),e.feature.isValid()===!1&&(this.deleteFeature([e.featureId]),this.changeMode(M.SIMPLE_SELECT,{}))};U.onMouseMove=function(e,t){const o=Fe(t),r=Io(t),n=Mo(t),i=e.selectedCoordPaths.length===0;return o&&i?this.updateUIClasses({mouse:G.MOVE}):r&&!i?this.updateUIClasses({mouse:G.MOVE}):this.updateUIClasses({mouse:G.NONE}),(r||o||n)&&e.dragMoving&&this.fireUpdate(),this.stopDragging(e),!0};U.onMouseOut=function(e){return e.dragMoving&&this.fireUpdate(),!0};U.onTouchStart=U.onMouseDown=function(e,t){if(Io(t))return this.onVertex(e,t);if(Fe(t))return this.onFeature(e,t);if(Mo(t))return this.onMidpoint(e,t)};U.onDrag=function(e,t){if(e.canDragMove!==!0)return;e.dragMoving=!0,t.originalEvent.stopPropagation();const o={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};e.selectedCoordPaths.length>0?this.dragVertex(e,t,o):this.dragFeature(e,t,o),e.dragMoveLocation=t.lngLat};U.onClick=function(e,t){if(pt(t))return this.clickNoTarget(e,t);if(Fe(t))return this.clickActiveFeature(e,t);if(Dt(t))return this.clickInactive(e,t);this.stopDragging(e)};U.onTap=function(e,t){if(pt(t))return this.clickNoTarget(e,t);if(Fe(t))return this.clickActiveFeature(e,t);if(Dt(t))return this.clickInactive(e,t)};U.onTouchEnd=U.onMouseUp=function(e){e.dragMoving&&this.fireUpdate(),this.stopDragging(e)};const Te={};Te.onSetup=function(){const e=this.newFeature({type:E.FEATURE,properties:{},geometry:{type:E.POINT,coordinates:[]}});return this.addFeature(e),this.clearSelectedFeatures(),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.POINT),this.setActionableState({trash:!0}),{point:e}};Te.stopDrawingAndRemove=function(e){this.deleteFeature([e.point.id],{silent:!0}),this.changeMode(M.SIMPLE_SELECT)};Te.onTap=Te.onClick=function(e,t){this.updateUIClasses({mouse:G.MOVE}),e.point.updateCoordinate("",t.lngLat.lng,t.lngLat.lat),this.fire(Z.CREATE,{features:[e.point.toGeoJSON()]}),this.changeMode(M.SIMPLE_SELECT,{featureIds:[e.point.id]})};Te.onStop=function(e){this.activateUIButton(),e.point.getCoordinate().length||this.deleteFeature([e.point.id],{silent:!0})};Te.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.point.id;if(t.properties.active=r?q.ACTIVE:q.INACTIVE,!r)return o(t)};Te.onTrash=Te.stopDrawingAndRemove;Te.onKeyUp=function(e,t){if(ft(t)||ht(t))return this.stopDrawingAndRemove(e,t)};function lt(e,t){return e.lngLat?e.lngLat.lng===t[0]&&e.lngLat.lat===t[1]:!1}const Ee={};Ee.onSetup=function(){const e=this.newFeature({type:E.FEATURE,properties:{},geometry:{type:E.POLYGON,coordinates:[[]]}});return this.addFeature(e),this.clearSelectedFeatures(),me.disable(this),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.POLYGON),this.setActionableState({trash:!0}),{polygon:e,currentVertexPosition:0}};Ee.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&lt(t,e.polygon.coordinates[0][e.currentVertexPosition-1]))return this.changeMode(M.SIMPLE_SELECT,{featureIds:[e.polygon.id]});this.updateUIClasses({mouse:G.ADD}),e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),e.currentVertexPosition++,e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat)};Ee.clickOnVertex=function(e){return this.changeMode(M.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};Ee.onMouseMove=function(e,t){e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),Ke(t)&&this.updateUIClasses({mouse:G.POINTER})};Ee.onTap=Ee.onClick=function(e,t){return Ke(t)?this.clickOnVertex(e,t):this.clickAnywhere(e,t)};Ee.onKeyUp=function(e,t){ft(t)?(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(M.SIMPLE_SELECT)):ht(t)&&this.changeMode(M.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};Ee.onStop=function(e){this.updateUIClasses({mouse:G.NONE}),me.enable(this),this.activateUIButton(),this.getFeature(e.polygon.id)!==void 0&&(e.polygon.removeCoordinate(`0.${e.currentVertexPosition}`),e.polygon.isValid()?this.fire(Z.CREATE,{features:[e.polygon.toGeoJSON()]}):(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(M.SIMPLE_SELECT,{},{silent:!0})))};Ee.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.polygon.id;if(t.properties.active=r?q.ACTIVE:q.INACTIVE,!r)return o(t);if(t.geometry.coordinates.length===0)return;const n=t.geometry.coordinates[0].length;if(!(n<3)){if(t.properties.meta=H.FEATURE,o($e(e.polygon.id,t.geometry.coordinates[0][0],"0.0",!1)),n>3){const i=t.geometry.coordinates[0].length-3;o($e(e.polygon.id,t.geometry.coordinates[0][i],`0.${i}`,!1))}if(n<=4){const i=[[t.geometry.coordinates[0][0][0],t.geometry.coordinates[0][0][1]],[t.geometry.coordinates[0][1][0],t.geometry.coordinates[0][1][1]]];if(o({type:E.FEATURE,properties:t.properties,geometry:{coordinates:i,type:E.LINE_STRING}}),n===3)return}return o(t)}};Ee.onTrash=function(e){this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(M.SIMPLE_SELECT)};const ve={};ve.onSetup=function(e){e=e||{};const t=e.featureId;let o,r,n="forward";if(t){if(o=this.getFeature(t),!o)throw new Error("Could not find a feature with the provided featureId");let i=e.from;if(i&&i.type==="Feature"&&i.geometry&&i.geometry.type==="Point"&&(i=i.geometry),i&&i.type==="Point"&&i.coordinates&&i.coordinates.length===2&&(i=i.coordinates),!i||!Array.isArray(i))throw new Error("Please use the `from` property to indicate which point to continue the line from");const s=o.coordinates.length-1;if(o.coordinates[s][0]===i[0]&&o.coordinates[s][1]===i[1])r=s+1,o.addCoordinate(r,...o.coordinates[s]);else if(o.coordinates[0][0]===i[0]&&o.coordinates[0][1]===i[1])n="backwards",r=0,o.addCoordinate(r,...o.coordinates[0]);else throw new Error("`from` should match the point at either the start or the end of the provided LineString")}else o=this.newFeature({type:E.FEATURE,properties:{},geometry:{type:E.LINE_STRING,coordinates:[]}}),r=0,this.addFeature(o);return this.clearSelectedFeatures(),me.disable(this),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.LINE),this.setActionableState({trash:!0}),{line:o,currentVertexPosition:r,direction:n}};ve.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&lt(t,e.line.coordinates[e.currentVertexPosition-1])||e.direction==="backwards"&&lt(t,e.line.coordinates[e.currentVertexPosition+1]))return this.changeMode(M.SIMPLE_SELECT,{featureIds:[e.line.id]});this.updateUIClasses({mouse:G.ADD}),e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),e.direction==="forward"?(e.currentVertexPosition++,e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat)):e.line.addCoordinate(0,t.lngLat.lng,t.lngLat.lat)};ve.clickOnVertex=function(e){return this.changeMode(M.SIMPLE_SELECT,{featureIds:[e.line.id]})};ve.onMouseMove=function(e,t){e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),Ke(t)&&this.updateUIClasses({mouse:G.POINTER})};ve.onTap=ve.onClick=function(e,t){if(Ke(t))return this.clickOnVertex(e,t);this.clickAnywhere(e,t)};ve.onKeyUp=function(e,t){ht(t)?this.changeMode(M.SIMPLE_SELECT,{featureIds:[e.line.id]}):ft(t)&&(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(M.SIMPLE_SELECT))};ve.onStop=function(e){me.enable(this),this.activateUIButton(),this.getFeature(e.line.id)!==void 0&&(e.line.removeCoordinate(`${e.currentVertexPosition}`),e.line.isValid()?this.fire(Z.CREATE,{features:[e.line.toGeoJSON()]}):(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(M.SIMPLE_SELECT,{},{silent:!0})))};ve.onTrash=function(e){this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(M.SIMPLE_SELECT)};ve.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.line.id;if(t.properties.active=r?q.ACTIVE:q.INACTIVE,!r)return o(t);t.geometry.coordinates.length<2||(t.properties.meta=H.FEATURE,o($e(e.line.id,t.geometry.coordinates[e.direction==="forward"?t.geometry.coordinates.length-2:1],`${e.direction==="forward"?t.geometry.coordinates.length-2:1}`,!1)),o(t))};const bo={simple_select:k,direct_select:U,draw_point:Te,draw_polygon:Ee,draw_line_string:ve},nn={defaultMode:M.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:So,modes:bo,controls:{},userProperties:!1,suppressAPIEvents:!0},sn={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},an={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function ro(e,t){return e.map(o=>o.source?o:Object.assign({},o,{id:`${o.id}.${t}`,source:t==="hot"?pe.HOT:pe.COLD}))}function ln(e={}){let t=Object.assign({},e);return e.controls||(t.controls={}),e.displayControlsDefault===!1?t.controls=Object.assign({},an,e.controls):t.controls=Object.assign({},sn,e.controls),t=Object.assign({},nn,t),t.styles=ro(t.styles,"cold").concat(ro(t.styles,"hot")),t}var _t,no;function cn(){if(no)return _t;no=1,_t=t;var e={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function t(o){if(!o||!o.type)return null;var r=e[o.type];if(!r)return null;if(r==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:o}]};if(r==="feature")return{type:"FeatureCollection",features:[o]};if(r==="featurecollection")return o}return _t}var un=cn();const dn=At(un);function Lo(e,t){return e.length!==t.length?!1:JSON.stringify(e.map(o=>o).sort())===JSON.stringify(t.map(o=>o).sort())}const pn={Polygon:le,LineString:_e,Point:Ae,MultiPolygon:X,MultiLineString:X,MultiPoint:X};function fn(e,t){t.modes=M;const o=e.options.suppressAPIEvents!==void 0?!!e.options.suppressAPIEvents:!0;return t.getFeatureIdsAt=function(r){return Be.click({point:r},null,e).map(i=>i.properties.id)},t.getSelectedIds=function(){return e.store.getSelectedIds()},t.getSelected=function(){return{type:E.FEATURE_COLLECTION,features:e.store.getSelectedIds().map(r=>e.store.get(r)).map(r=>r.toGeoJSON())}},t.getSelectedPoints=function(){return{type:E.FEATURE_COLLECTION,features:e.store.getSelectedCoordinates().map(r=>({type:E.FEATURE,properties:{},geometry:{type:E.POINT,coordinates:r.coordinates}}))}},t.set=function(r){if(r.type===void 0||r.type!==E.FEATURE_COLLECTION||!Array.isArray(r.features))throw new Error("Invalid FeatureCollection");const n=e.store.createRenderBatch();let i=e.store.getAllIds().slice();const s=t.add(r),c=new he(s);return i=i.filter(a=>!c.has(a)),i.length&&t.delete(i),n(),s},t.add=function(r){const i=JSON.parse(JSON.stringify(dn(r))).features.map(s=>{if(s.id=s.id||Ft(),s.geometry===null)throw new Error("Invalid geometry: null");if(e.store.get(s.id)===void 0||e.store.get(s.id).type!==s.geometry.type){const c=pn[s.geometry.type];if(c===void 0)throw new Error(`Invalid geometry type: ${s.geometry.type}.`);const a=new c(e,s);e.store.add(a,{silent:o})}else{const c=e.store.get(s.id),a=c.properties;c.properties=s.properties,Xt(a,s.properties)||e.store.featureChanged(c.id,{silent:o}),Xt(c.getCoordinates(),s.geometry.coordinates)||c.incomingCoords(s.geometry.coordinates)}return s.id});return e.store.render(),i},t.get=function(r){const n=e.store.get(r);if(n)return n.toGeoJSON()},t.getAll=function(){return{type:E.FEATURE_COLLECTION,features:e.store.getAll().map(r=>r.toGeoJSON())}},t.delete=function(r){return e.store.delete(r,{silent:o}),t.getMode()===M.DIRECT_SELECT&&!e.store.getSelectedIds().length?e.events.changeMode(M.SIMPLE_SELECT,void 0,{silent:o}):e.store.render(),t},t.deleteAll=function(){return e.store.delete(e.store.getAllIds(),{silent:o}),t.getMode()===M.DIRECT_SELECT?e.events.changeMode(M.SIMPLE_SELECT,void 0,{silent:o}):e.store.render(),t},t.changeMode=function(r,n={}){return r===M.SIMPLE_SELECT&&t.getMode()===M.SIMPLE_SELECT?(Lo(n.featureIds||[],e.store.getSelectedIds())||(e.store.setSelected(n.featureIds,{silent:o}),e.store.render()),t):(r===M.DIRECT_SELECT&&t.getMode()===M.DIRECT_SELECT&&n.featureId===e.store.getSelectedIds()[0]||e.events.changeMode(r,n,{silent:o}),t)},t.getMode=function(){return e.events.getMode()},t.trash=function(){return e.events.trash({silent:o}),t},t.combineFeatures=function(){return e.events.combineFeatures({silent:o}),t},t.uncombineFeatures=function(){return e.events.uncombineFeatures({silent:o}),t},t.setFeatureProperty=function(r,n,i){return e.store.setFeatureProperty(r,n,i,{silent:o}),t},t}const hn=Object.freeze(Object.defineProperty({__proto__:null,CommonSelectors:on,ModeHandler:bt,StringSet:he,constrainFeatureMovement:Ut,createMidPoint:_o,createSupplementaryPoints:gt,createVertex:$e,doubleClickZoom:me,euclideanDistance:Nt,featuresAt:Be,getFeatureAtAndSetCursors:nt,isClick:Pt,isEventAtCoordinates:lt,isTap:Ot,mapEventToBoundingBox:mo,moveFeatures:Bt,sortFeatures:yo,stringSetsAreEqual:Lo,theme:So,toDenseArray:Ze},Symbol.toStringTag,{value:"Module"})),gn=function(e,t){e=ln(e);const o={options:e};t=fn(o,t),o.api=t;const r=en(o);return t.onAdd=r.onAdd,t.onRemove=r.onRemove,t.types=re,t.options=e,t};function yt(e){gn(e,this)}yt.modes=bo;yt.constants=go;yt.lib=hn;const yn=({commentInput:e,setCommentInput:t,addCommentLayer:o,setCommentFeatures:r,commentFeatures:n,handleDeleteComment:i,workDay:s,drawRef:c})=>{var m,l,d,f,C;const a=Ne(S=>S.auth.user),u=Ne(S=>S.auth.token),y=async(S,D)=>{try{const V=`comment-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,$={...e.feature},I={...$,type:"Feature",geometry:D||$.geometry,properties:{...$.properties,id:V,workDayId:s.id,comment:S,type:"comment",createdAt:new Date().toISOString(),createdBy:a}},R={geometry:I.geometry,properties:I.properties,featureType:I.properties.type,workDayId:s.id};(await ae.post("/mapFeature",R,{headers:{Authorization:u}})).status===201&&ge("Successfully Added Comment",{variant:"success"}),r(W=>[...W,I]),console.log(I,"<=== yeets"),c.add(I),t({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}})}catch(V){console.error(V)}};return h.jsx(jo,{in:e.open,children:h.jsxs(so,{elevation:4,sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,p:1.5,width:250,backgroundColor:"#ffffff",border:"1px solid #e0e0e0",borderRadius:1.5},children:[h.jsxs(fe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[h.jsx(Pe,{variant:"subtitle2",sx:{fontSize:"0.875rem"},children:e.isEdit?"Edit Comment":"Add Comment"}),h.jsx(io,{size:"small",onClick:()=>t({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),sx:{p:.5},children:h.jsx(gr,{size:14})})]}),h.jsx(lo,{autoFocus:!0,size:"small",fullWidth:!0,variant:"outlined",multiline:!0,rows:2,placeholder:"Enter comment...",value:((l=(m=e.feature)==null?void 0:m.properties)==null?void 0:l.comment)||"",onChange:S=>{if(e.feature){const D={...e.feature,properties:{...e.feature.properties,comment:S.target.value}};t({...e,feature:D})}},sx:{mb:1}}),h.jsxs(fe,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[e.isEdit&&e.feature&&h.jsx(Ue,{size:"small",variant:"contained",color:"error",startIcon:h.jsx(hr,{size:14}),onClick:()=>{i(e.feature)},sx:{fontSize:"0.75rem",py:.5},children:"Delete"}),h.jsx(Ue,{size:"small",variant:"contained",onClick:()=>{var S,D;return y(((D=(S=e.feature)==null?void 0:S.properties)==null?void 0:D.comment)||"")},disabled:!((C=(f=(d=e.feature)==null?void 0:d.properties)==null?void 0:f.comment)!=null&&C.trim()),sx:{fontSize:"0.75rem",py:.5},children:e.isEdit?"Update":"Add"})]})]})})};class mn{constructor(t){if(typeof t=="function")this.onChange=t,this.initialColor="#3bb2d0",this.initialOpacity=.2;else{const{onChange:o,initialColor:r="#3bb2d0",initialOpacity:n=.2}=t||{};this.onChange=o,this.initialColor=r,this.initialOpacity=n}this._map=null,this._container=null,this._isOpen=!1,this._color=this.initialColor,this._opacity=this.initialOpacity}onAdd(t){this._map=t;const o=document.createElement("div");o.className="mapboxgl-ctrl mapboxgl-ctrl-group",o.style.position="relative";const r=document.createElement("button");r.type="button",r.className="mapboxgl-ctrl-icon",r.setAttribute("aria-label","Color & Opacity"),r.style.width="30px",r.style.height="30px",r.style.display="inline-flex",r.style.alignItems="center",r.style.justifyContent="center";const n=document.createElement("span");n.style.width="14px",n.style.height="14px",n.style.borderRadius="50%",n.style.background=this._color,n.style.opacity=this._opacity,n.style.boxShadow="0 0 0 1px rgba(0,0,0,0.2) inset",r.appendChild(n),this._dot=n;const i=document.createElement("div");i.style.position="absolute",i.style.top="0",i.style.right="100%",i.style.marginRight="8px",i.style.display="none",i.style.flexDirection="column",i.style.gap="8px",i.style.padding="8px",i.style.background="#fff",i.style.border="1px solid rgba(0,0,0,0.15)",i.style.borderRadius="8px",i.style.boxShadow="0 2px 8px rgba(0,0,0,0.12)",i.style.zIndex="2",i.style.width="140px";const s=document.createElement("input");s.type="color",s.value=this._color,s.style.width="100%",s.addEventListener("input",y=>{this._color=y.target.value,this._update()});const c=document.createElement("div");c.style.display="flex",c.style.flexDirection="column",c.style.fontSize="12px",c.style.gap="4px";const a=document.createElement("span");a.textContent=`Opacity: ${Math.round(this._opacity*100)}%`;const u=document.createElement("input");return u.type="range",u.min="0.1",u.max="1",u.step="0.05",u.value=this._opacity,u.addEventListener("input",y=>{this._opacity=parseFloat(y.target.value),a.textContent=`Opacity: ${Math.round(this._opacity*100)}%`,this._update()}),c.appendChild(a),c.appendChild(u),i.appendChild(s),i.appendChild(c),r.addEventListener("click",y=>{y.stopPropagation(),this._isOpen=!this._isOpen,i.style.display=this._isOpen?"flex":"none"}),document.addEventListener("click",y=>{o.contains(y.target)||(this._isOpen=!1,i.style.display="none")}),o.appendChild(r),o.appendChild(i),this._container=o,o}onRemove(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._map=null}_update(){this._dot&&(this._dot.style.background=this._color,this._dot.style.opacity=this._opacity),typeof this.onChange=="function"&&this.onChange(this._color,this._opacity)}}se.accessToken="pk.eyJ1IjoiaGlyYWtyYWoiLCJhIjoiY21icXd5eHRnMDNtaTJxczcxd2RmbTZwOCJ9.P6kpsuLMDdeK2DIMJZMrmw";const En=[{title:"Projects",to:"/project",icon:qo},{title:"Project Name",icon:Jo},{title:"Exterior(Map View)",icon:Ho}],Re=({label:e,createdBy:t,createdAt:o})=>`
    <div style="
      font-family: 'Arial', sans-serif;
      background-color: #fff;
      border: 1px solid #B3D3F0; /* secondary200 */
      border-radius: 8px;
      overflow: hidden;
      width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    ">
      <!-- Header -->
      <div style="
        background-color: #2563EB; /* primaryMain */
        color: #fff;
        font-weight: 600;
        font-size: 13px;
        padding: 8px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        ${e}
      </div>
      
      <!-- Body -->
      <div style="
        padding: 6px 8px;
        background-color: #D6E6F5; /* secondaryLight */
        display: flex;
        justify-content: space-between;
        font-size: 8px;
        color: #1F3F66; /* secondary800 */
      ">
        <span>${t}</span>
        <span style="color: #666;">
          ${new Date(o).toLocaleDateString()} ${new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}
        </span>
      </div>
    </div>
  `,ke=(e,t)=>{let o,r;return e.createdBy?o=e.createdBy:o=JSON.parse(e.user_createdBy),e.createdAt?r=e.createdAt:r=e.user_createdAt,{createdBy:`${o.firstName} ${o.lastName}`,createdAt:new Date(r),label:t}};function _n(){const e=F.useRef(null),t=F.useRef(null),o=F.useRef(null),r=Ne(g=>g.auth.user),[n,i]=F.useState(!1),[s,c]=F.useState(""),[a,u]=F.useState({orthomosaic:!0,annotations:!0,showComments:!0,showPolygons:!0,showLineString:!0,builtinOverlay:!1}),[y,m]=F.useState(!1),[l,d]=F.useState([]),[f,C]=F.useState([]),[S,D]=F.useState(!1),[V,$]=F.useState({}),[I,R]=F.useState(null),[ne,W]=F.useState(!1),[Q,Y]=F.useState([]),[Ie,Ge]=F.useState("#2563EB"),[Ve,xe]=F.useState(.5),[Me,Le]=F.useState({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),[J,be]=F.useState([]),we=Ne(g=>g.project.id),Ce=Ne(g=>g.auth.token);F.useEffect(()=>{if(!we)return;(async()=>{var v,_,L,j,ee,N,b,w;try{D(!0),R(null);const P=((_=(v=(await ae.get("/work-day",{params:{projectId:we,status:"completed"},headers:{Authorization:Ce}})).data)==null?void 0:v.data)==null?void 0:_.results)||[];if(d(P.map(p=>p.name)),$(P[0]),C(P),P.length>0){c(P[0].name);const p=await ae.get("/mapFeature",{params:{workDayId:P[0].id},headers:{Authorization:Ce}});((j=(L=p.data)==null?void 0:L.data)==null?void 0:j.results.length)!==0&&Y((N=(ee=p.data)==null?void 0:ee.data)==null?void 0:N.results)}else R("No completed work days found for this project.")}catch(O){R(((w=(b=O.response)==null?void 0:b.data)==null?void 0:w.message)||"Failed to load project data. Please try again."),d([]),C([])}finally{D(!1)}})()},[we,Ce]),F.useEffect(()=>{if(!e.current||t.current)return;if(!se.accessToken){R("Mapbox API key is not configured.");return}const g=new se.Map({container:e.current,style:"mapbox://styles/mapbox/satellite-streets-v12",center:[72.5714,23.0225],zoom:15,attributionControl:!1,preserveDrawingBuffer:!0,minZoom:0,maxZoom:23}),v=Ie,_=Ve;var L=Ie,j=_;const ee=(N,b)=>{const w=["coalesce",["get","user_color"],["get","color"],N],O=["coalesce",["get","user_opacity"],["get","opacity"],b];return[{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":w,"fill-outline-color":w,"fill-opacity":O}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":w,"line-width":1}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],paint:{"line-color":w,"line-width":1}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":w,"fill-outline-color":w,"fill-opacity":O}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":w,"line-width":1}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],paint:{"line-color":w,"line-width":2}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","false"]],paint:{"circle-radius":4,"circle-color":w}},{id:"gl-draw-point-comment",type:"circle",filter:["all",["==","active","false"],["==","meta","feature"],["==","user_type","comment"]],paint:{"circle-radius":4,"circle-color":w,"circle-stroke-color":"#fff","circle-stroke-width":2}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":6,"circle-color":w,"circle-stroke-color":w,"circle-stroke-width":2}},{id:"gl-draw-point-comment-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["==","meta","feature"],["==","user_type","comment"]],paint:{"circle-radius":6,"circle-color":w,"circle-stroke-color":"#fff","circle-stroke-width":3}}]};return g.on("load",()=>{t.current=g,i(!0),R(null),g.addControl(new se.FullscreenControl,"top-right"),g.addControl(new se.NavigationControl({visualizePitch:!0}),"top-right");const N=new se.ScaleControl({unit:"metric",maxWidth:100});g.addControl(N,"bottom-left"),setTimeout(()=>{const O=g.getContainer().querySelector(".mapboxgl-ctrl-scale");O&&(O.style.display="block",O.style.visibility="visible",O.style.opacity="1")},1e3);const b=new mn((O,P)=>{console.log(O,P,"<==== picked"),L=O||v,j=P||_,console.log(L,"<==== current"),Ge(O),xe(P)});g.addControl(b,"top-right");const w=new yt({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!0,line_string:!0,point:!0,trash:!0},styles:ee(L,j)});g.addControl(w,"top-right"),o.current=w,g.on("draw.create",async O=>{var te;const P=V.id;O.features.forEach(A=>{w.setFeatureProperty(A.id,"color",L)});const p=(te=O.features)==null?void 0:te[0];if(p){if(t.current.__activePopup&&t.current.__activePopup.remove(),p.geometry.type==="LineString"){if(!p||p.geometry.type!=="LineString")return;const ce=`${et(p,{units:"meters"}).toFixed(2)} m`,ue=`polygon-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;p.properties.createdBy=r,p.properties.createdAt=new Date,p.createdAt=new Date().toISOString,p.properties.comment=ce,p.properties.color=L,p.properties.id=ue;try{const x={featureType:"line",geometry:p.geometry,properties:p.properties,workDayId:P};(await ae.post("/mapFeature",x,{headers:{Authorization:Ce}})).status===201&&ge("Line created ",{variant:"success"}),w.add(p)}catch(x){console.error(x)}ge(ce,{variant:"success"})}if(p.geometry.type==="Polygon"){const A=rt.geometry(p.geometry).toFixed(2),ce=`${A} m²`,ue=`polygon-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,x=St(p).geometry.coordinates;w.setFeatureProperty(p.id,"id",ue),p.properties.color=L,p.properties.createdAt=new Date,p.properties.createdBy=r,p.properties.areaM2=A,p.properties.id=ue,p.properties.opacity=j;try{const z={featureType:"polygon",geometry:p.geometry,properties:p.properties,workDayId:P};(await ae.post("/mapFeature",z,{headers:{Authorization:Ce}})).status===201&&ge("Polygon created ",{variant:"success"}),setTimeout(()=>{const Se=new se.Popup({closeButton:!0,offset:15}).setLngLat(x).setHTML(Re(ke(p.properties,ce))).addTo(t.current);t.current.__activePopup=Se,w.add(p)},0)}catch(z){console.error(z)}}if(p.geometry.type==="Point"){const A=g.getCanvas().getBoundingClientRect();Le({open:!0,feature:{feature:p,geometry:p.geometry,color:L,properties:{color:L}},isEdit:!1,position:{x:A.width/2,y:A.height/2}})}}}),g.on("draw.update",async O=>{var te,A,ce,ue;t.current.__activePopup&&t.current.__activePopup.remove(),console.log("updating something");const P=V.id,p=(te=O.features)==null?void 0:te[0];if(p){if(O.features.forEach(x=>{w.setFeatureProperty(x.id,"color",L)}),((A=p==null?void 0:p.geometry)==null?void 0:A.type)==="Polygon"){const x=rt.geometry(p.geometry),z=(x/1e6).toFixed(2),de=x.toFixed(2);St(p).geometry.coordinates,t.current.__activePopup=popup,p.properties.color=L,p.properties.areaKm2=z,p.properties.areaM2=de,p.properties.opacity=j;try{const Se={featureType:"polygon",geometry:p.geometry,properties:p.properties,workDayId:P};(await ae.patch(`/mapFeature/propertyId/${p==null?void 0:p.properties.id}`,Se,{headers:{Authorization:Ce}})).status===200&&ge("Polygon Updated ",{variant:"success"})}catch(Se){console.error(Se)}}if(((ce=p==null?void 0:p.geometry)==null?void 0:ce.type)==="LineString")try{const x=et(p,{units:"kilometers"}),z=(x*1e3).toFixed(2),de=vt(p,x/2,{units:"kilometers"}).geometry.coordinates;p.properties.color=L,p.properties.lengthKm=x.toFixed(2),p.properties.lengthM=z;const Se={featureType:"line",geometry:p.geometry,properties:p.properties,workDayId:P};(await ae.patch(`/mapFeature/propertyId/${p==null?void 0:p.properties.id}`,Se,{headers:{Authorization:Ce}})).status===200&&ge("Line Updated",{variant:"success"})}catch(x){console.error("Error updating line:",x)}if(((ue=p==null?void 0:p.geometry)==null?void 0:ue.type)==="Point")try{const[x,z]=p.geometry.coordinates;p.properties.color=L,p.properties.coordinates=`${z.toFixed(6)}, ${x.toFixed(6)}`;const de={featureType:"comment",geometry:p.geometry,properties:p.properties,workDayId:P};(await ae.patch(`/mapFeature/propertyId/${p==null?void 0:p.properties.id}`,de,{headers:{Authorization:Ce}})).status===200&&ge("Point Updated",{variant:"success"})}catch(x){console.error("Error updating point:",x)}}}),g.on("draw.delete",async O=>{be(p=>p.filter(te=>te.properties.id!==P.properties.id)),console.log("on delete"),t.current.__activePopup&&t.current.__activePopup.remove();const P=O.features[0];console.log("Deleted features:",O.features);try{(await ae.delete(`/mapfeature/propertyId/${P.properties.id}`)).status===200&&ge("Successfully removed feature",{variant:"success"})}catch(p){console.error("error removing feature",p)}}),g.on("click",O=>{var ce,ue;console.log("on click"),t.current.__activePopup&&t.current.__activePopup.remove();const P=["gl-draw-line-inactive","gl-draw-line-inactive.hot","gl-draw-line-active","gl-draw-line-active.hot","gl-draw-line-static","gl-draw-point-inactive","gl-draw-point-inactive.hot","gl-draw-point-active","gl-draw-point-active.hot","gl-draw-point-static","gl-draw-polygon-fill-inactive","gl-draw-polygon-fill-inactive.cold","gl-draw-polygon-fill-inactive.hot","gl-draw-polygon-fill-active","gl-draw-polygon-fill-static","gl-draw-polygon-stroke-inactive","gl-draw-polygon-stroke-inactive.cold","gl-draw-polygon-stroke-active","gl-draw-polygon-stroke-static"],p=g.getStyle().layers.map(x=>x.id).filter(x=>P.includes(x)),te=g.queryRenderedFeatures(O.point,{layers:p});if(!te.length)return;const A=te[0];if(A.geometry.type==="Point"&&A.properties.user_type==="comment"){console.log(A,"<==== yeeter");const x=A.geometry.coordinates.slice(),z=((ce=A.properties)==null?void 0:ce.comment)||((ue=A.properties)==null?void 0:ue.user_comment)||"",de=new se.Popup().setLngLat(x).setHTML(Re(ke(A.properties,z))).addTo(g);t.current.__activePopup=de}if(A.geometry.type==="Polygon"){console.log(A,"<=== featuer agae ");const z=`${rt.geometry(A.geometry).toFixed(2)} m²`,de=St(A).geometry.coordinates;new se.Popup().setLngLat(de).setHTML(Re(ke(A.properties,z))).addTo(g)}if(A.geometry.type==="LineString"){console.log(A,"<==== feature line string selection");const x=et(A,{units:"kilometers"}),z=vt(A,x/2,{units:"kilometers"}).geometry.coordinates,de=x*1e3,Se=`${de.toFixed(2)} m`;if(z&&!z.some(Number.isNaN)){const mt=new se.Popup().setLngLat(z).setHTML(Re(ke(A.properties,Se))).addTo(g);t.current.__activePopup=mt}ge(`Length: ${de.toFixed(2)} m`,{variant:"success"})}}),g.on("draw.selectionchange",O=>{if(O.features.length>0){const P=O.features[0];if(P.geometry.type==="LineString"&&P.properties.mode!=="draw_polygon"){console.log(P,"<==== feature line string selection");const p=et(P,{units:"kilometers"}),te=vt(P,p/2,{units:"kilometers"}).geometry.coordinates,A=p*1e3,ce=`${A.toFixed(2)} m`;if(te&&!te.some(Number.isNaN)){const ue=new se.Popup().setLngLat(te).setHTML(Re(ke(P.properties,ce))).addTo(g);t.current.__activePopup=ue}ge(`Length: ${A.toFixed(2)} m`,{variant:"success"})}if(P.geometry.type==="Point"){console.log(P,"<============wew");const p=new se.Popup().setLngLat(P.geometry.coordinates).setHTML(Re(ke(P.properties,P.properties.comment))).addTo(g);t.current.__activePopup=p}}})}),g.on("sourcedata",N=>{var b;(b=N.sourceId)!=null&&b.includes("ortho-")&&N.isSourceLoaded&&(console.log("on source data remove"),W(!1))}),()=>{g&&g.remove&&g.remove(),t.current=null,i(!1)}},[V]),F.useEffect(()=>{if(!s||!t.current||!n||!f.length)return;(async()=>{var _;const v=f.find(L=>L.name===s);if(v){o.current.deleteAll();try{const{data:L}=await ae.get("/mapFeature",{params:{workDayId:v.id,limit:100},headers:{Authorization:Ce}}),ee={type:"FeatureCollection",features:(((_=L==null?void 0:L.data)==null?void 0:_.results)||[]).map(({geometry:N,properties:b,createdBy:w,createdAt:O})=>({type:"Feature",geometry:N,properties:{...b,createdBy:w,createdAt:O,comment:(b==null?void 0:b.comment)||"",color:(b==null?void 0:b.color)||Ie,message:(b==null?void 0:b.message)||"No message set"}}))};console.log(ee.features,"<======== yeeeter"),be(ee.features)}catch(L){console.error("Error loading map features:",L)}}})()},[s,n,f]),F.useEffect(()=>{const g=f.find(N=>N.name===s);if(!t.current||!n||!g)return;const v=t.current,_=`overlay-${g.id}`,L={fill:`overlay-fill-${g.id}`,line:`overlay-line-${g.id}`,point:`overlay-point-${g.id}`};Object.values(L).forEach(N=>{v.getLayer(N)&&v.removeLayer(N)}),v.getSource(_)&&v.removeSource(_),o.current&&o.current.deleteAll();const j=J.filter(N=>{var b;return(b=N.properties)==null?void 0:b.overlay}),ee=J.filter(N=>{var b;return!((b=N.properties)!=null&&b.overlay)});if(o.current&&ee.length){const N=ee.filter(b=>{var O;const w=(O=b.geometry)==null?void 0:O.type;return w==="Polygon"&&a.showPolygons||w==="LineString"&&a.showLineString||w==="Point"&&a.showComments});N.length&&a.annotations&&(o.current.add({type:"FeatureCollection",features:N}),o.current.changeMode("simple_select"))}if(a.builtinOverlay&&j.length&&(v.addSource(_,{type:"geojson",data:{type:"FeatureCollection",features:j}}),a.showPolygons&&v.addLayer({id:L.fill,type:"fill",source:_,filter:["==",["geometry-type"],"Polygon"],paint:{"fill-color":["coalesce",["get","color_hex"],"#2563EB"],"fill-opacity":.3}}),a.showLineString&&v.addLayer({id:L.line,type:"line",source:_,filter:["==",["geometry-type"],"LineString"],paint:{"line-color":["coalesce",["get","color_hex"],"#2563EB"],"line-width":1,"line-join":"round","line-cap":"round"}}),a.showComments&&v.addLayer({id:L.point,type:"circle",source:_,filter:["==",["geometry-type"],"Point"],paint:{"circle-radius":3,"circle-color":["coalesce",["get","color_hex"],"#2563EB"]}})),a.orthomosaic&&g.tileBaseUrl&&(W(!0),wo(g)),g.tileBounds)Po(g.tileBounds);else if(j.length){const N=new se.LngLatBounds;j.forEach(b=>{b.geometry.type==="Point"?N.extend(b.geometry.coordinates):b.geometry.type==="LineString"?b.geometry.coordinates.forEach(w=>N.extend(w)):b.geometry.type==="Polygon"&&b.geometry.coordinates.flat().forEach(w=>N.extend(w))}),N.isEmpty()||v.fitBounds(N,{padding:40})}},[J,a,n,s,f]);const wo=g=>{const v=t.current;if(!v||!g.tileBaseUrl)return;const _=`ortho-${g.id}`;try{v.getLayer(_)&&v.removeLayer(_),v.getSource(_)&&v.removeSource(_),v.addSource(_,{type:"raster",tiles:[`${g.tileBaseUrl}/{z}/{x}/{y}.png`],tileSize:256,minzoom:10,maxzoom:23});const L=v.getStyle().layers.find(j=>j.id.startsWith("gl-draw-")).id;v.addLayer({id:_,type:"raster",source:_,paint:{"raster-opacity":a.orthomosaic?1:0,"raster-brightness-min":0,"raster-brightness-max":1}},L),console.log("Raster layer added:",_,"URL:",g.tileBaseUrl),setTimeout(()=>{const j=v.getLayer(_),ee=v.getSource(_);console.log("Layer check:",{layerExists:!!j,sourceExists:!!ee,layerVisible:v.getLayoutProperty(_,"visibility")!=="none",paintOpacity:v.getPaintProperty(_,"raster-opacity")})},1e3),W(!1)}catch(L){console.error("Error adding tile layer:",L),R("Failed to load orthomosaic tiles."),W(!1)}},Po=g=>{const v=t.current;if(!v)return;const{north:_,south:L,east:j,west:ee}=g;v.fitBounds([[ee,L],[j,_]],{padding:50,maxZoom:18})},je=g=>{u(v=>({...v,[g.target.name]:g.target.checked}))},Oo=g=>{c(g.target.value);const v=f.find(_=>_.name===g.target.value);$(v)},Ao=g=>{const v=t.current;if(!(!v||!n)){if(console.log("Updating comment layer with features:",g),v.getLayer("comment-points")&&(console.log("Removing existing comment layer"),v.removeLayer("comment-points")),v.getSource("comments")&&(console.log("Removing existing comment source"),v.removeSource("comments")),console.log("checking features ",g),g&&g.length>0&&a.showComments){console.log("Adding new comment layer with",g.length,"features"),v.addSource("comments",{type:"geojson",data:{type:"FeatureCollection",features:g}}),v.addLayer({id:"comment-points",type:"symbol",source:"comments",layout:{"icon-image":"marker-15","icon-size":1.5,"text-field":["get","comment"],"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-size":.5,"text-color":"#000","text-halo-color":"#fff","text-halo-width":2}});const _=v.getLayer("comment-points");_&&console.log("Comment layer added successfully with ID:",_.id)}else console.log("No features to display, comment layer removed");v.isStyleLoaded()&&v.triggerRepaint(),console.log("Comment layer update complete")}},xo=async g=>{console.log("=== COMMENT DELETION DEBUG ==="),console.log("Attempting to delete comment",g),console.log("Current commentFeatures:",Q),console.log(Q[0].properties.comment),console.log(g.properties.comment);const v=Q.filter(_=>_.properties.id!==g.properties.id);try{await ae.delete(`/mapFeature/propertyId/${g.properties.id}`,{headers:{Authorization:Ce}})}catch(_){console.error(_)}console.log("Updated commentFeatures after deletion:",v),ge("Successfully Removed Comment",{variant:"success"}),Y(v),refreshCommentLayer(),Le({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),console.log("=== END DELETION DEBUG ===")};return we?h.jsxs(Vt,{children:[h.jsxs(fe,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[h.jsx(Pe,{variant:"h1",gutterBottom:!0,children:"Exterior (Map View)"}),h.jsx(Ue,{variant:"contained",onClick:()=>m(!0),disabled:S,children:"Upload New"})]}),h.jsx(Ar,{open:y,onClose:()=>m(!1)}),h.jsx(zo,{links:En,card:!0,custom:!0,rightAlign:!1}),h.jsx(Wo,{sx:{my:2}}),h.jsxs(fe,{display:"flex",height:"calc(100vh - 320px)",gap:1,children:[h.jsxs(fe,{sx:{width:"250px",pr:2,height:"100%"},children:[h.jsx(Pe,{onClick:()=>{const g=t.current.queryRenderedFeatures();console.log("Total Rendered Features:",g.length);const v=t.current.queryRenderedFeatures({layers:["overlay-fill-68ad75d9366cff02d631be9f","overlay-line-68ad75d9366cff02d631be9f","overlay-point-68ad75d9366cff02d631be9f"]});console.log("Overlay Rendered Features:",v.length)},variant:"h3",gutterBottom:!0,children:"Layers"}),h.jsxs(or,{children:[h.jsx(ze,{control:h.jsx(qe,{checked:a.orthomosaic,onChange:je,name:"orthomosaic",disabled:S}),label:"Orthomosaic"}),h.jsx(ze,{control:h.jsx(qe,{checked:a.showLineString,onChange:je,name:"showLineString",disabled:S}),label:"Lines"}),h.jsx(ze,{control:h.jsx(qe,{checked:a.showPolygons,onChange:je,name:"showPolygons",disabled:S}),label:"Polygons"}),h.jsx(ze,{control:h.jsx(qe,{checked:a.showComments,onChange:je,name:"showComments",disabled:S}),label:"Comments"}),h.jsx(ze,{control:h.jsx(qe,{checked:a.builtinOverlay,onChange:je,name:"builtinOverlay",disabled:S}),label:"CAD Overlay"})]}),h.jsxs(Yo,{fullWidth:!0,sx:{mt:3},children:[h.jsx(Xo,{children:"Historical Data"}),h.jsx(Zo,{value:s||"",onChange:Oo,label:"Historical Data",disabled:S||l.length===0,children:l.map(g=>h.jsx(Ko,{value:g,children:Qo(g).format("DD-MM-YYYY")},g))})]}),S&&h.jsx(fe,{sx:{display:"flex",justifyContent:"center",mt:2},children:h.jsx(co,{size:24})}),!S&&l.length===0&&h.jsx(qt,{severity:"info",sx:{mt:2},children:"No historical data available for this project."})]}),h.jsx(fe,{ref:e,sx:{flex:1,borderRadius:2,overflow:"hidden",height:"100%",position:"relative",border:"1px solid #e0e0e0","& .mapboxgl-ctrl-scale":{border:"2px solid #333",borderTop:"none",color:"#333",backgroundColor:"rgba(255, 255, 255, 0.8)",padding:"2px 6px",fontSize:"12px",fontWeight:"bold"}}}),h.jsx(yn,{addCommentLayer:Ao,setCommentFeatures:Y,commentInput:Me,setCommentInput:Le,commentFeatures:Q,handleDeleteComment:xo,workDay:V,drawRef:o.current})]})]}):h.jsx(Vt,{children:h.jsx(qt,{severity:"warning",children:"No project selected. Please select a project first."})})}export{_n as default};
