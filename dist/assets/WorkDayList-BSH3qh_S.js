import{aw as ke,t as ie,j as e,u as ze,b as Ie,r as c,d as We,M as Pe,B as h,T as g,S as se,af as Me,b3 as _e,h as j}from"./index-B-97Stnr.js";import{d as $}from"./dayjs.min-DRQ0Xc4u.js";import{T as Ae}from"./TextField-DXokT3Uj.js";import{B as b,I as De}from"./InputLabel-bN84oSwy.js";import{F as re}from"./OutlinedInput-DUxvNYun.js";import{S as oe}from"./Select-BkNAhdrO.js";import{M as ne}from"./MenuItem-BECs5rgy.js";import{a as Le,b as Fe,c as Ne,d as U,T as d,e as $e}from"./TableRow--i2-rbqA.js";import{P as Ue}from"./Pagination-CuDXA7Jh.js";import{a as Re,b as Ee,D as Ye}from"./DialogContent-CPcTjVzo.js";import{D as Be}from"./DialogTitle-BbVf2Zsi.js";import"./FormHelperText-iHdAZMns.js";import"./LastPage-DRO19mFv.js";/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var R=ke("outline","photo-edit","IconPhotoEdit",[["path",{d:"M15 8h.01",key:"svg-0"}],["path",{d:"M11 20h-4a3 3 0 0 1 -3 -3v-10a3 3 0 0 1 3 -3h10a3 3 0 0 1 3 3v4",key:"svg-1"}],["path",{d:"M4 15l4 -4c.928 -.893 2.072 -.893 3 0l3 3",key:"svg-2"}],["path",{d:"M14 14l1 -1c.31 -.298 .644 -.497 .987 -.596",key:"svg-3"}],["path",{d:"M18.42 15.61a2.1 2.1 0 0 1 2.97 2.97l-3.39 3.42h-3v-3l3.42 -3.39z",key:"svg-4"}]]);const Ge=ie(e.jsx("path",{d:"M5 20h14v-2H5zM19 9h-4V3H9v6H5l7 7z"})),He=ie(e.jsx("path",{d:"M5 20h14v-2H5zm0-10h4v6h6v-6h4l-7-7z"})),Oe=[{value:"processing",label:"Processing"},{value:"completed",label:"Completed"},{value:"failed",label:"Failed"}],Ke=[{value:"createdAt:desc",label:"Newest"},{value:"createdAt:asc",label:"Oldest"},{value:"name:asc",label:"Name (A-Z)"},{value:"name:desc",label:"Name (Z-A)"}],ct=()=>{const m=ze(),{enqueueSnackbar:i}=Ie(),[z,E]=c.useState([]),[le,Y]=c.useState(!0),[B,G]=c.useState(null),[I,W]=c.useState(1),[P]=c.useState(10),[ce,de]=c.useState(0),[H,he]=c.useState(""),[M,pe]=c.useState("createdAt:desc"),[_,ue]=c.useState(""),f=We(t=>t.auth.token),[me,O]=c.useState({}),v=c.useRef(null),[A,K]=c.useState({type:"",workDay:null}),[X,S]=c.useState({}),[C,q]=c.useState({}),[V,D]=c.useState({open:!1,workDayId:null}),[w,Z]=c.useState(!1);c.useEffect(()=>{(async()=>{var a,r,s,o,n,p;Y(!0),G(null);try{const l={page:I,limit:P,sortBy:M};_&&(l.name=_);const T=await j.get("/work-day",{params:l,headers:{Authorization:f}});E(((a=T.data.data)==null?void 0:a.results)||[]),de(((r=T.data.data)==null?void 0:r.totalResults)||0)}catch(l){console.log(l,"<===== error fetching workdays"),G(((o=(s=l.response)==null?void 0:s.data)==null?void 0:o.message)||l.message),i(((p=(n=l.response)==null?void 0:n.data)==null?void 0:p.message)||l.message||"Failed to fetch work days",{variant:"error"})}finally{Y(!1)}})()},[f,I,P,M,_,i]);const xe=t=>t?t.url?t.url:t.Location?t.Location:null:null,ge=async t=>{var r,s,o;const a=t.rawFile;if(!a){i("No file found to download",{variant:"warning"});return}try{const p=(r=(await j.get(`/work-day/get-download-url/${a}`,{headers:{Authorization:f}})).data)==null?void 0:r.data;p?(window.open(p,"_blank"),i("Download started",{variant:"success"})):i("No download link available.",{variant:"warning"})}catch(n){i(((o=(s=n.response)==null?void 0:s.data)==null?void 0:o.message)||n.message||"Download failed",{variant:"error"})}},fe=async(t,a)=>{var r,s;O(o=>({...o,[t._id||t.id]:!0}));try{await j.patch(`/work-day/${t._id||t.id}`,{status:a},{headers:{Authorization:f}}),E(o=>o.map(n=>(n._id||n.id)===(t._id||t.id)?{...n,status:a}:n)),i("Status updated!",{variant:"success"})}catch(o){i(((s=(r=o.response)==null?void 0:r.data)==null?void 0:s.message)||o.message||"Failed to update status",{variant:"error"})}finally{O(o=>({...o,[t._id||t.id]:!1}))}},J=()=>{W(1),ue(H)},ye=(t,a)=>{K({workDay:t,type:a}),v.current&&v.current.click()},je=async t=>{var p,l,T,ee;const a=(p=t.target.files)==null?void 0:p[0];if(!a||!A.type||!A.workDay)return;const{type:r,workDay:s}=A,o=a.name.split(".").pop().toLowerCase(),n=`${s.id||s._id}_${r}`;if(r==="tiff"&&o!=="tiff"&&o!=="tiff"){i(`Only .${r.toUpperCase()} files are allowed`,{variant:"error"});return}q(u=>({...u,[n]:!0})),S(u=>({...u,[n]:0}));try{const L=(await j.post("/work-day/upload-resultFile",{workDayId:s.id||s._id,type:r,filename:a.name,contentType:a.type,size:a.size},{headers:{Authorization:f}})).data.data;if(r==="kml"||r==="jpg"&&a.size<=52428800)await j.put(L.url,a,{headers:{"Content-Type":a.type},onUploadProgress:y=>{const F=Math.round(y.loaded*100/y.total);S(N=>({...N,[n]:F}))}}),i(`${r.toUpperCase()} uploaded successfully`,{variant:"success"});else if(r==="jpg"&&a.size>52428800){console.log(r,a.size,"<==="),console.log(L,"<==== wow owowowo");const{parts:y,uploadId:F,key:N,partSize:we}=L,te=[];let k=0;for(;k<a.size;){const x=Math.min(k+we,a.size);te.push(a.slice(k,x)),k=x}const ae=[];for(let x=0;x<y.length;x++){const Te=(l=(await fetch(y[x].url,{method:"PUT",body:te[x]})).headers.get("ETag"))==null?void 0:l.replace(/"/g,"");ae.push({PartNumber:y[x].partNumber,ETag:Te});const Se=Math.round((x+1)/y.length*100);S(Ce=>({...Ce,[n]:Se}))}await j.post("/work-day/complete-upload",{workDayId:s.id||s._id,type:r,key:N,uploadId:F,parts:ae},{headers:{Authorization:f}}),i("JPG uploaded successfully (multipart)",{variant:"success"})}}catch(u){i(((ee=(T=u.response)==null?void 0:T.data)==null?void 0:ee.message)||u.message||"Upload failed",{variant:"error"})}finally{q(u=>({...u,[n]:!1})),setTimeout(()=>{S(u=>({...u,[n]:0}))},2e3),v.current&&(v.current.value=""),K({type:"",workDay:null})}},be=t=>{const a=z.find(s=>(s._id||s.id)===t);if(!a){i("Work day not found",{variant:"error"});return}if(!(a.tiffFile&&a.tiffFile.trim()!=="")){i("Please upload .tiff first before generating tiles.",{variant:"warning"});return}D({open:!0,workDayId:t})},ve=async()=>{var a,r,s;const{workDayId:t}=V;Z(!0);try{(a=(await j.get(`/work-day/generate-tiles/${t}`,{headers:{Authorization:f}})).data)!=null&&a.success?(i("Tile generation started successfully! This process will take at least 10 minutes to complete.",{variant:"success"}),D({open:!1,workDayId:null})):i("Failed to start tile generation",{variant:"error"})}catch(o){i(((s=(r=o.response)==null?void 0:r.data)==null?void 0:s.message)||o.message||"Failed to generate tiles",{variant:"error"})}finally{Z(!1)}},Q=()=>{D({open:!1,workDayId:null})};return e.jsxs(Pe,{children:[e.jsx(h,{children:e.jsx(g,{variant:"h2",mb:2,gutterBottom:!0,children:"Historical Work Days"})}),e.jsxs(se,{direction:{xs:"column",sm:"row"},spacing:2,mb:2,alignItems:"center",children:[e.jsx(Ae,{label:"Search by Project",size:"small",value:H,onChange:t=>he(t.target.value),onKeyDown:t=>{t.key==="Enter"&&J()}}),e.jsx(b,{variant:"contained",onClick:J,sx:{minWidth:100},children:"Search"}),e.jsxs(re,{size:"small",sx:{minWidth:150},children:[e.jsx(De,{children:"Sort By"}),e.jsx(oe,{value:M,label:"Sort By",onChange:t=>{pe(t.target.value),W(1)},children:Ke.map(t=>e.jsx(ne,{value:t.value,children:t.label},t.value))})]})]}),le?e.jsx(g,{variant:"body1",children:"Loading work days..."}):B?e.jsx(g,{color:"error",children:B}):e.jsx(e.Fragment,{children:e.jsxs(Me,{sx:{p:3,mx:"auto",mt:3},children:[e.jsx(Le,{children:e.jsxs(Fe,{size:"small",children:[e.jsx(Ne,{children:e.jsxs(U,{sx:{bgcolor:m.palette.primary.light},children:[e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Time Stamp"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Historical Date"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Project Name"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Project"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Owner"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Status"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Tiff"}),e.jsx(d,{sx:{color:m.palette.primary.contrastText},children:"Action"})]})}),e.jsx($e,{children:z.length===0?e.jsx(U,{children:e.jsx(d,{colSpan:7,align:"center",children:"No work days found."})}):z.map(t=>{var p;const a=(p=t.resultFiles)==null?void 0:p[0],r=!!xe(a),s=t._id||t.id,o=t.projectId||{},n=o.owner||{};return e.jsxs(U,{children:[e.jsx(d,{children:t.createdAt?$(t.createdAt).format("DD/MM/YYYY"):t.name}),e.jsx(d,{children:$(t.name,"YYYY-MM-DD",!0).isValid()?$(t.name).format("DD/MM/YYYY"):t.name||"-"}),e.jsx(d,{children:o.name||"-"}),e.jsx(d,{children:o.location||"-"}),e.jsx(d,{children:n.firstName||n.lastName?`${n.firstName||""} ${n.lastName||""}`.trim():n.email||"-"}),e.jsx(d,{children:e.jsx(re,{size:"small",sx:{minWidth:120},children:e.jsx(oe,{value:t.status||"",onChange:l=>fe(t,l.target.value),disabled:me[s],children:Oe.map(l=>e.jsx(ne,{value:l.value,children:l.label},l.value))})})}),e.jsx(d,{children:t.tiffFile?t.tiffFile.split("-")[5]:"-"}),e.jsx(d,{children:e.jsxs(se,{spacing:1,sx:{minWidth:200},children:[e.jsx(b,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(Ge,{}),onClick:()=>ge(t),disabled:!r&&!t.rawFile,fullWidth:!0,sx:{height:36,fontSize:"0.75rem",fontWeight:500,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:2}},children:"Download"}),e.jsxs(h,{children:[e.jsx(b,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(He,{}),onClick:()=>ye(t,"jpg"),disabled:C[`${s}_jpg`],fullWidth:!0,sx:{height:36,fontSize:"0.75rem",fontWeight:500,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:2}},children:"Upload Tiff"}),C[`${s}_jpg`]&&e.jsxs(h,{sx:{mt:.5},children:[e.jsxs(g,{variant:"caption",color:"text.secondary",children:["Uploading..."," ",X[`${s}_jpg`]||0,"%"]}),e.jsx(h,{sx:{width:"100%",mt:.5},children:e.jsx(h,{sx:{height:3,bgcolor:"grey.200",borderRadius:1.5,overflow:"hidden"},children:e.jsx(h,{sx:{width:`${X[`${s}_jpg`]||0}%`,height:"100%",bgcolor:"secondary.main",transition:"width 0.3s ease"}})})})]})]}),e.jsx(b,{variant:"outlined",color:"primary",size:"small",startIcon:e.jsx(R,{}),onClick:()=>be(s),disabled:C[`${s}_jpg`]||C[`${s}_kml`],fullWidth:!0,sx:{height:36,fontSize:"0.75rem",fontWeight:500,textTransform:"none",borderWidth:1.5,"&:hover":{borderWidth:2}},children:"Generate Tiles"})]})})]},s)})})]})}),e.jsx(h,{display:"flex",justifyContent:"center",mt:2,children:e.jsx(Ue,{count:Math.ceil(ce/P),page:I,onChange:(t,a)=>W(a),color:"primary"})})]})}),e.jsx("input",{type:"file",ref:v,style:{display:"none"},onChange:je}),e.jsxs(Re,{open:V.open,onClose:w?void 0:Q,"aria-labelledby":"generate-tiles-dialog-title","aria-describedby":"generate-tiles-dialog-description",PaperProps:{sx:{borderRadius:2,minWidth:400,boxShadow:"0 8px 32px rgba(0, 0, 0, 0.12)"}},children:[e.jsx(Be,{id:"generate-tiles-dialog-title",sx:{bgcolor:"primary.light",color:"warning.contrastText",fontWeight:600,fontSize:"1.1rem"},children:"⚠️ Confirmation"}),e.jsx(Ee,{sx:{pt:3,pb:2},children:w?e.jsxs(h,{sx:{textAlign:"center",py:4},children:[e.jsx(h,{sx:{width:64,height:64,borderRadius:"50%",bgcolor:"primary.light",display:"flex",alignItems:"center",justifyContent:"center",mx:"auto",mb:2},children:e.jsx(R,{sx:{color:"primary.light",fontSize:32}})}),e.jsx(g,{variant:"h6",sx:{fontWeight:600,mb:2,color:"text.primary"},children:"Generating Tiles..."}),e.jsx(g,{variant:"body1",sx:{color:"text.secondary",lineHeight:1.6,mb:3},children:"Please wait while we process your request. This may take several minutes."}),e.jsx(h,{sx:{width:"100%",maxWidth:300,mx:"auto"},children:e.jsx(_e,{})})]}):e.jsxs(h,{sx:{display:"flex",alignItems:"flex-start",gap:2,mt:2},children:[e.jsx(h,{sx:{width:48,height:48,borderRadius:"50%",bgcolor:"primary.light",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,mt:.5},children:e.jsx(R,{sx:{color:"primary.light",fontSize:24}})}),e.jsxs(h,{children:[e.jsx(g,{variant:"h6",sx:{fontWeight:600,mb:1,color:"text.primary"},children:"Time-Intensive Operation"}),e.jsxs(g,{variant:"body1",id:"generate-tiles-dialog-description",sx:{color:"text.secondary",lineHeight:1.6},children:["This tile generation process will take at least"," ",e.jsx("strong",{children:"10 minutes"})," to complete. The system will process your data in the background."]})]})]})}),e.jsxs(Ye,{sx:{p:3,pt:1,gap:1},children:[e.jsx(b,{onClick:Q,variant:"outlined",disabled:w,sx:{color:"error.main",borderColor:"error.main",fontWeight:500,px:3,py:1,"&:hover":{bgcolor:"error.50",borderColor:"error.dark"},"&:disabled":{color:"grey.400",borderColor:"grey.300"}},children:"Cancel"}),e.jsx(b,{onClick:ve,variant:"contained",disabled:w,sx:{bgcolor:"primary.main",color:"white",fontWeight:500,px:3,py:1,"&:hover":{bgcolor:"secondary.light",color:"black"},"&:focus":{bgcolor:"primary.main"},"&:disabled":{bgcolor:"grey.300",color:"grey.500"}},children:w?"Processing...":"Proceed"})]})]})]})};export{ct as default};
