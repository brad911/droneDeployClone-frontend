import{ao as Ao,an as No,E as Ye,j as g,r as F,ap as Fo,as as Re,N as ct,aq as Do,i as eo,at as Ct,ar as Ro,a5 as to,au as ko,av as mt,aw as oo,ak as ro,b as Uo,d as Ne,ax as Bo,B as fe,T as Pe,a1 as no,l as Ge,ay as $o,a0 as io,m as le,ac as Go,az as Vo,a4 as ge,Q as Rt,aA as jo,aB as zo,aC as Jo,aD as Ho,D as Wo,k as ke,C as Ue,F as qo,I as Yo,y as Xo,M as Zo,aE as Ko}from"./index-C6WstQVI.js";import{m as ae}from"./mapbox-gl-CoVnSP41.js";import{u as Qo,I as er}from"./index-Cym0xsMb.js";import{$ as kt}from"./index-BXubdvFC.js";import{F as tr}from"./FormGroup-Ccr1VVk9.js";import"./tslib.es6-CTYbIaVE.js";function or(e){return No("MuiAlert",e)}const Ut=Ao("MuiAlert",["root","action","icon","message","filled","colorSuccess","colorInfo","colorWarning","colorError","filledSuccess","filledInfo","filledWarning","filledError","outlined","outlinedSuccess","outlinedInfo","outlinedWarning","outlinedError","standard","standardSuccess","standardInfo","standardWarning","standardError"]),rr=Ye(g.jsx("path",{d:"M20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4C12.76,4 13.5,4.11 14.2, 4.31L15.77,2.74C14.61,2.26 13.34,2 12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0, 0 22,12M7.91,10.08L6.5,11.5L11,16L21,6L19.59,4.58L11,13.17L7.91,10.08Z"})),nr=Ye(g.jsx("path",{d:"M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"})),ir=Ye(g.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"})),sr=Ye(g.jsx("path",{d:"M11,9H13V7H11M12,20C7.59,20 4,16.41 4,12C4,7.59 7.59,4 12,4C16.41,4 20,7.59 20, 12C20,16.41 16.41,20 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10, 10 0 0,0 12,2M11,17H13V11H11V17Z"})),ar=Ye(g.jsx("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"})),lr=e=>{const{variant:t,color:o,severity:r,classes:n}=e,i={root:["root",`color${Ct(o||r)}`,`${t}${Ct(o||r)}`,`${t}`],icon:["icon"],message:["message"],action:["action"]};return Ro(i,or,n)},cr=ct(to,{name:"MuiAlert",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:o}=e;return[t.root,t[o.variant],t[`${o.variant}${Ct(o.color||o.severity)}`]]}})(ko(({theme:e})=>{const t=e.palette.mode==="light"?e.darken:e.lighten,o=e.palette.mode==="light"?e.lighten:e.darken;return{...e.typography.body2,backgroundColor:"transparent",display:"flex",padding:"6px 16px",variants:[...Object.entries(e.palette).filter(mt(["light"])).map(([r])=>({props:{colorSeverity:r,variant:"standard"},style:{color:e.vars?e.vars.palette.Alert[`${r}Color`]:t(e.palette[r].light,.6),backgroundColor:e.vars?e.vars.palette.Alert[`${r}StandardBg`]:o(e.palette[r].light,.9),[`& .${Ut.icon}`]:e.vars?{color:e.vars.palette.Alert[`${r}IconColor`]}:{color:e.palette[r].main}}})),...Object.entries(e.palette).filter(mt(["light"])).map(([r])=>({props:{colorSeverity:r,variant:"outlined"},style:{color:e.vars?e.vars.palette.Alert[`${r}Color`]:t(e.palette[r].light,.6),border:`1px solid ${(e.vars||e).palette[r].light}`,[`& .${Ut.icon}`]:e.vars?{color:e.vars.palette.Alert[`${r}IconColor`]}:{color:e.palette[r].main}}})),...Object.entries(e.palette).filter(mt(["dark"])).map(([r])=>({props:{colorSeverity:r,variant:"filled"},style:{fontWeight:e.typography.fontWeightMedium,...e.vars?{color:e.vars.palette.Alert[`${r}FilledColor`],backgroundColor:e.vars.palette.Alert[`${r}FilledBg`]}:{backgroundColor:e.palette.mode==="dark"?e.palette[r].dark:e.palette[r].main,color:e.palette.getContrastText(e.palette[r].main)}}}))]}})),ur=ct("div",{name:"MuiAlert",slot:"Icon"})({marginRight:12,padding:"7px 0",display:"flex",fontSize:22,opacity:.9}),dr=ct("div",{name:"MuiAlert",slot:"Message"})({padding:"8px 0",minWidth:0,overflow:"auto"}),pr=ct("div",{name:"MuiAlert",slot:"Action"})({display:"flex",alignItems:"flex-start",padding:"4px 0 0 16px",marginLeft:"auto",marginRight:-8}),Bt={success:g.jsx(rr,{fontSize:"inherit"}),warning:g.jsx(nr,{fontSize:"inherit"}),error:g.jsx(ir,{fontSize:"inherit"}),info:g.jsx(sr,{fontSize:"inherit"})},$t=F.forwardRef(function(t,o){const r=Fo({props:t,name:"MuiAlert"}),{action:n,children:i,className:s,closeText:c="Close",color:a,components:u={},componentsProps:y={},icon:E,iconMapping:l=Bt,onClose:d,role:h="alert",severity:_="success",slotProps:b={},slots:D={},variant:V="standard",...$}=r,M={...r,color:a,severity:_,variant:V,colorSeverity:a||_},R=lr(M),ne={slots:{closeButton:u.CloseButton,closeIcon:u.CloseIcon,...D},slotProps:{...y,...b}},[q,ee]=Re("root",{ref:o,shouldForwardComponentProp:!0,className:Do(R.root,s),elementType:cr,externalForwardedProps:{...ne,...$},ownerState:M,additionalProps:{role:h,elevation:0}}),[Y,_e]=Re("icon",{className:R.icon,elementType:ur,externalForwardedProps:ne,ownerState:M}),[ze,Je]=Re("message",{className:R.message,elementType:dr,externalForwardedProps:ne,ownerState:M}),[Ae,be]=Re("action",{className:R.action,elementType:pr,externalForwardedProps:ne,ownerState:M}),[we,J]=Re("closeButton",{elementType:eo,externalForwardedProps:ne,ownerState:M}),[Ie,Me]=Re("closeIcon",{elementType:ar,externalForwardedProps:ne,ownerState:M});return g.jsxs(q,{...ee,children:[E!==!1?g.jsx(Y,{..._e,children:E||l[_]||Bt[_]}):null,g.jsx(ze,{...Je,children:i}),n!=null?g.jsx(Ae,{...be,children:n}):null,n==null&&d?g.jsx(Ae,{...be,children:g.jsx(we,{size:"small","aria-label":c,title:c,color:"inherit",onClick:d,...J,children:g.jsx(Ie,{fontSize:"small",...Me})})}):null]})});/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var fr=oo("outline","trash","IconTrash",[["path",{d:"M4 7l16 0",key:"svg-0"}],["path",{d:"M10 11l0 6",key:"svg-1"}],["path",{d:"M14 11l0 6",key:"svg-2"}],["path",{d:"M5 7l1 12a2 2 0 0 0 2 2h8a2 2 0 0 0 2 -2l1 -12",key:"svg-3"}],["path",{d:"M9 7v-3a1 1 0 0 1 1 -1h4a1 1 0 0 1 1 1v3",key:"svg-4"}]]);/**
 * @license @tabler/icons-react v3.31.0 - MIT
 *
 * This source code is licensed under the MIT license.
 * See the LICENSE file in the root directory of this source tree.
 */var hr=oo("outline","x","IconX",[["path",{d:"M18 6l-12 12",key:"svg-0"}],["path",{d:"M6 6l12 12",key:"svg-1"}]]),Qe={},He={},Gt;function gr(){return Gt||(Gt=1,He.RADIUS=6378137,He.FLATTENING=1/298.257223563,He.POLAR_RADIUS=63567523142e-4),He}var Vt;function yr(){if(Vt)return Qe;Vt=1;var e=gr();Qe.geometry=t,Qe.ring=r;function t(i){var s=0,c;switch(i.type){case"Polygon":return o(i.coordinates);case"MultiPolygon":for(c=0;c<i.coordinates.length;c++)s+=o(i.coordinates[c]);return s;case"Point":case"MultiPoint":case"LineString":case"MultiLineString":return 0;case"GeometryCollection":for(c=0;c<i.geometries.length;c++)s+=t(i.geometries[c]);return s}}function o(i){var s=0;if(i&&i.length>0){s+=Math.abs(r(i[0]));for(var c=1;c<i.length;c++)s-=Math.abs(r(i[c]))}return s}function r(i){var s,c,a,u,y,E,l,d=0,h=i.length;if(h>2){for(l=0;l<h;l++)l===h-2?(u=h-2,y=h-1,E=0):l===h-1?(u=h-1,y=0,E=1):(u=l,y=l+1,E=l+2),s=i[u],c=i[y],a=i[E],d+=(n(a[0])-n(s[0]))*Math.sin(n(c[1]));d=d*e.RADIUS*e.RADIUS/2}return d}function n(i){return i*Math.PI/180}return Qe}var mr=yr();const rt=ro(mr);var se=63710088e-1,so={centimeters:se*100,centimetres:se*100,degrees:360/(2*Math.PI),feet:se*3.28084,inches:se*39.37,kilometers:se/1e3,kilometres:se/1e3,meters:se,metres:se,miles:se/1609.344,millimeters:se*1e3,millimetres:se*1e3,nauticalmiles:se/1852,radians:1,yards:se*1.0936};function it(e,t,o={}){const r={type:"Feature"};return(o.id===0||o.id)&&(r.id=o.id),o.bbox&&(r.bbox=o.bbox),r.properties=t||{},r.geometry=e,r}function st(e,t,o={}){if(!e)throw new Error("coordinates is required");if(!Array.isArray(e))throw new Error("coordinates must be an Array");if(e.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!jt(e[0])||!jt(e[1]))throw new Error("coordinates must contain numbers");return it({type:"Point",coordinates:e},t,o)}function Er(e,t,o={}){if(e.length<2)throw new Error("coordinates must be an array of two or more positions");return it({type:"LineString",coordinates:e},t,o)}function vr(e,t="kilometers"){const o=so[t];if(!o)throw new Error(t+" units is invalid");return e*o}function Cr(e,t="kilometers"){const o=so[t];if(!o)throw new Error(t+" units is invalid");return e/o}function St(e){return e%(2*Math.PI)*180/Math.PI}function ye(e){return e%360*Math.PI/180}function jt(e){return!isNaN(e)&&e!==null&&!Array.isArray(e)}function qe(e){if(!e)throw new Error("coord is required");if(!Array.isArray(e)){if(e.type==="Feature"&&e.geometry!==null&&e.geometry.type==="Point")return[...e.geometry.coordinates];if(e.type==="Point")return[...e.coordinates]}if(Array.isArray(e)&&e.length>=2&&!Array.isArray(e[0])&&!Array.isArray(e[1]))return[...e];throw new Error("coord must be GeoJSON Point or an Array of numbers")}function Sr(e){return e.type==="Feature"?e.geometry:e}function ao(e,t,o={}){if(o.final===!0)return Tr(e,t);const r=qe(e),n=qe(t),i=ye(r[0]),s=ye(n[0]),c=ye(r[1]),a=ye(n[1]),u=Math.sin(s-i)*Math.cos(a),y=Math.cos(c)*Math.sin(a)-Math.sin(c)*Math.cos(a)*Math.cos(s-i);return St(Math.atan2(u,y))}function Tr(e,t){let o=ao(t,e);return o=(o+180)%360,o}function _r(e,t,o,r={}){const n=qe(e),i=ye(n[0]),s=ye(n[1]),c=ye(o),a=Cr(t,r.units),u=Math.asin(Math.sin(s)*Math.cos(a)+Math.cos(s)*Math.sin(a)*Math.cos(c)),y=i+Math.atan2(Math.sin(c)*Math.sin(a)*Math.cos(s),Math.cos(a)-Math.sin(s)*Math.sin(u)),E=St(y),l=St(u);return st([E,l],r.properties)}function lo(e,t,o={}){var r=qe(e),n=qe(t),i=ye(n[1]-r[1]),s=ye(n[0]-r[0]),c=ye(r[1]),a=ye(n[1]),u=Math.pow(Math.sin(i/2),2)+Math.pow(Math.sin(s/2),2)*Math.cos(c)*Math.cos(a);return vr(2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u)),o.units)}function zt(e,t,o={}){const n=Sr(e).coordinates;let i=0;for(let s=0;s<n.length&&!(t>=i&&s===n.length-1);s++)if(i>=t){const c=t-i;if(c){const a=ao(n[s],n[s-1])-180;return _r(n[s],c,a,o)}else return st(n[s])}else i+=lo(n[s],n[s+1],o);return st(n[n.length-1])}function Lt(e,t,o){if(e!==null)for(var r,n,i,s,c,a,u,y=0,E=0,l,d=e.type,h=d==="FeatureCollection",_=d==="Feature",b=h?e.features.length:1,D=0;D<b;D++){u=h?e.features[D].geometry:_?e.geometry:e,l=u?u.type==="GeometryCollection":!1,c=l?u.geometries.length:1;for(var V=0;V<c;V++){var $=0,M=0;if(s=l?u.geometries[V]:u,s!==null){a=s.coordinates;var R=s.type;switch(y=o&&(R==="Polygon"||R==="MultiPolygon")?1:0,R){case null:break;case"Point":if(t(a,E,D,$,M)===!1)return!1;E++,$++;break;case"LineString":case"MultiPoint":for(r=0;r<a.length;r++){if(t(a[r],E,D,$,M)===!1)return!1;E++,R==="MultiPoint"&&$++}R==="LineString"&&$++;break;case"Polygon":case"MultiLineString":for(r=0;r<a.length;r++){for(n=0;n<a[r].length-y;n++){if(t(a[r][n],E,D,$,M)===!1)return!1;E++}R==="MultiLineString"&&$++,R==="Polygon"&&M++}R==="Polygon"&&$++;break;case"MultiPolygon":for(r=0;r<a.length;r++){for(M=0,n=0;n<a[r].length;n++){for(i=0;i<a[r][n].length-y;i++){if(t(a[r][n][i],E,D,$,M)===!1)return!1;E++}M++}$++}break;case"GeometryCollection":for(r=0;r<s.geometries.length;r++)if(Lt(s.geometries[r],t,o)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function br(e,t){var o,r,n,i,s,c,a,u,y,E,l=0,d=e.type==="FeatureCollection",h=e.type==="Feature",_=d?e.features.length:1;for(o=0;o<_;o++){for(c=d?e.features[o].geometry:h?e.geometry:e,u=d?e.features[o].properties:h?e.properties:{},y=d?e.features[o].bbox:h?e.bbox:void 0,E=d?e.features[o].id:h?e.id:void 0,a=c?c.type==="GeometryCollection":!1,s=a?c.geometries.length:1,n=0;n<s;n++){if(i=a?c.geometries[n]:c,i===null){if(t(null,l,u,y,E)===!1)return!1;continue}switch(i.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":{if(t(i,l,u,y,E)===!1)return!1;break}case"GeometryCollection":{for(r=0;r<i.geometries.length;r++)if(t(i.geometries[r],l,u,y,E)===!1)return!1;break}default:throw new Error("Unknown Geometry Type")}}l++}}function Ir(e,t){br(e,function(o,r,n,i,s){var c=o===null?null:o.type;switch(c){case null:case"Point":case"LineString":case"Polygon":return t(it(o,n,{bbox:i,id:s}),r,0)===!1?!1:void 0}var a;switch(c){case"MultiPoint":a="Point";break;case"MultiLineString":a="LineString";break;case"MultiPolygon":a="Polygon";break}for(var u=0;u<o.coordinates.length;u++){var y=o.coordinates[u],E={type:a,coordinates:y};if(t(it(E,n),r,u)===!1)return!1}})}function Mr(e,t){Ir(e,function(o,r,n){var i=0;if(o.geometry){var s=o.geometry.type;if(!(s==="Point"||s==="MultiPoint")){var c,a=0,u=0,y=0;if(Lt(o,function(E,l,d,h,_){if(c===void 0||r>a||h>u||_>y){c=E,a=r,u=h,y=_,i=0;return}var b=Er([c,E],o.properties);if(t(b,r,n,_,i)===!1)return!1;i++,c=E})===!1)return!1}}})}function Lr(e,t,o){var r=o,n=!1;return Mr(e,function(i,s,c,a,u){n===!1&&o===void 0?r=i:r=t(r,i,s,c,a,u),n=!0}),r}function Jt(e,t={}){let o=0,r=0,n=0;return Lt(e,function(i){o+=i[0],r+=i[1],n++},!0),st([o/n,r/n],t.properties)}function et(e,t={}){return Lr(e,(o,r)=>{const n=r.geometry.coordinates;return o+lo(n[0],n[1],t)},0)}const wr=({open:e=!1,onClose:t,onSave:o})=>{const[r,n]=F.useState(null),[i,s]=F.useState(!1),[c,a]=F.useState(0),[u,y]=F.useState({date:new Date().toISOString().split("T")[0],file:null}),{enqueueSnackbar:E}=Uo(),l=Ne(M=>M.auth.token),d=Ne(M=>M.project.id);F.useEffect(()=>{e||(n(null),s(!1),a(0),y({date:new Date().toISOString().split("T")[0],file:null}))},[e]);const h=(M,R)=>{y(ne=>({...ne,[M]:R}))},_=M=>{M.length&&(n(M[0]),h("file",M[0]))},{getRootProps:b,getInputProps:D,isDragActive:V}=Qo({onDrop:_,multiple:!1,accept:{"application/zip":[".zip"]}}),$=async()=>{var M,R,ne;if(!u.file){E("Please select a file to upload.",{variant:"warning"});return}s(!0),a(0);try{const ee=(await le.post("/work-day/get-url",{projectId:d,name:u.date,filename:u.file.name,contentType:u.file.type,size:u.file.size},{headers:{Authorization:l}})).data.data;if(console.log(ee,"<===== upload response"),!ee)throw new Error("Invalid upload response from server");if(ee.uploadType==="single"){if(!ee.url)throw new Error("Missing upload URL");try{await Go.put(ee.url,u.file,{headers:{"Content-Type":u.file.type},onUploadProgress:Y=>{const _e=Math.round(Y.loaded*100/Y.total);a(_e)}})}catch(Y){throw console.error("❌ Single upload failed:",Y),new Error("Single upload failed")}}else if(ee.uploadType==="multipart"){const{parts:Y,uploadId:_e,key:ze,partSize:Je}=ee,Ae=[];let be=0;for(;be<u.file.size;){const J=Math.min(be+Je,u.file.size);Ae.push(u.file.slice(be,J)),be=J}const we=[];for(let J=0;J<Y.length;J++)try{const Ie=await fetch(Y[J].url,{method:"PUT",body:Ae[J]});if(!Ie.ok)throw new Error(`Chunk ${J+1} upload failed`);const Me=(M=Ie.headers.get("ETag"))==null?void 0:M.replace(/"/g,"");we.push({PartNumber:Y[J].partNumber,ETag:Me}),a(Math.round((J+1)/Y.length*100))}catch(Ie){throw console.error("❌ Chunk upload failed:",Ie),new Error("Multipart upload failed")}await le.post("/work-day/complete-upload",{projectId:d,name:u.date,key:ze,uploadId:_e,parts:we},{headers:{Authorization:l}})}E("Upload successful!",{variant:"success"}),E("Successfully Created Historical Data",{variant:"success"}),o&&o(),t()}catch(q){console.error(q),E(((ne=(R=q==null?void 0:q.response)==null?void 0:R.data)==null?void 0:ne.message)||q.message||"Upload failed.",{variant:"error"})}finally{s(!1),a(0)}};return g.jsx(Bo,{open:e,onClose:t,children:g.jsxs(fe,{sx:{outline:"none",width:400,maxWidth:"90vw",bgcolor:"background.paper",borderRadius:2,boxShadow:24,mx:"auto",mt:"10vh",p:3},children:[g.jsx(Pe,{variant:"h5",sx:{mb:2},children:"Upload New Capture Into Historical Data"}),g.jsxs(fe,{sx:{display:"flex",flexDirection:"column",gap:2},children:[g.jsx(no,{label:"Date of Capture",type:"date",value:u.date,onChange:M=>h("date",M.target.value),fullWidth:!0,size:"small",disabled:i,InputLabelProps:{shrink:!0}}),g.jsxs(fe,{...b(),sx:{border:"2px dashed #ccc",borderRadius:"8px",padding:4,textAlign:"center",cursor:i?"not-allowed":"pointer",backgroundColor:V?"#f0f0f0":"transparent",mb:2,opacity:i?.5:1,pointerEvents:i?"none":"auto"},children:[g.jsx("input",{...D()}),g.jsx(er,{size:32}),g.jsx(Pe,{variant:"h6",gutterBottom:!0,children:"Upload Zip File"}),g.jsx(Pe,{variant:"body2",sx:{mb:2},children:"Drag & drop your .zip file or click below to browse"}),g.jsx(Ge,{variant:"outlined",disabled:i,children:"Browse Files"}),r&&g.jsxs(Pe,{variant:"subtitle1",sx:{mt:1},children:["Selected: ",r.name]})]}),i&&g.jsxs(fe,{children:[g.jsxs(Pe,{variant:"body2",gutterBottom:!0,children:["Uploading... ",c,"%"]}),g.jsx($o,{variant:"determinate",value:c})]}),g.jsxs(fe,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[g.jsx(Ge,{onClick:t,disabled:i,children:"Cancel"}),g.jsx(Ge,{variant:"contained",onClick:$,disabled:!u.file||i,startIcon:i&&g.jsx(io,{size:16}),children:i?"Uploading...":"Upload"})]})]})]})})},Tt=function(e,t){const o={drag:[],click:[],mousemove:[],mousedown:[],mouseup:[],mouseout:[],keydown:[],keyup:[],touchstart:[],touchmove:[],touchend:[],tap:[]},r={on(i,s,c){if(o[i]===void 0)throw new Error(`Invalid event type: ${i}`);o[i].push({selector:s,fn:c})},render(i){t.store.featureChanged(i)}},n=function(i,s){const c=o[i];let a=c.length;for(;a--;){const u=c[a];if(u.selector(s)){u.fn.call(r,s)||t.store.render(),t.ui.updateMapClasses();break}}};return e.start.call(r),{render:e.render,stop(){e.stop&&e.stop()},trash(){e.trash&&(e.trash(),t.store.render())},combineFeatures(){e.combineFeatures&&e.combineFeatures()},uncombineFeatures(){e.uncombineFeatures&&e.uncombineFeatures()},drag(i){n("drag",i)},click(i){n("click",i)},mousemove(i){n("mousemove",i)},mousedown(i){n("mousedown",i)},mouseup(i){n("mouseup",i)},mouseout(i){n("mouseout",i)},keydown(i){n("keydown",i)},keyup(i){n("keyup",i)},touchstart(i){n("touchstart",i)},touchmove(i){n("touchmove",i)},touchend(i){n("touchend",i)},tap(i){n("tap",i)}}},oe={CANVAS:"mapboxgl-canvas",CONTROL_BASE:"mapboxgl-ctrl",CONTROL_PREFIX:"mapboxgl-ctrl-",CONTROL_BUTTON:"mapbox-gl-draw_ctrl-draw-btn",CONTROL_BUTTON_LINE:"mapbox-gl-draw_line",CONTROL_BUTTON_POLYGON:"mapbox-gl-draw_polygon",CONTROL_BUTTON_POINT:"mapbox-gl-draw_point",CONTROL_BUTTON_TRASH:"mapbox-gl-draw_trash",CONTROL_BUTTON_COMBINE_FEATURES:"mapbox-gl-draw_combine",CONTROL_BUTTON_UNCOMBINE_FEATURES:"mapbox-gl-draw_uncombine",CONTROL_GROUP:"mapboxgl-ctrl-group",ATTRIBUTION:"mapboxgl-ctrl-attrib",ACTIVE_BUTTON:"active",BOX_SELECT:"mapbox-gl-draw_boxselect"},pe={HOT:"mapbox-gl-draw-hot",COLD:"mapbox-gl-draw-cold"},G={ADD:"add",MOVE:"move",DRAG:"drag",POINTER:"pointer",NONE:"none"},re={POLYGON:"polygon",LINE:"line_string",POINT:"point"},C={FEATURE:"Feature",POLYGON:"Polygon",LINE_STRING:"LineString",POINT:"Point",FEATURE_COLLECTION:"FeatureCollection",MULTI_PREFIX:"Multi",MULTI_POINT:"MultiPoint",MULTI_LINE_STRING:"MultiLineString",MULTI_POLYGON:"MultiPolygon"},L={DRAW_LINE_STRING:"draw_line_string",DRAW_POLYGON:"draw_polygon",DRAW_POINT:"draw_point",SIMPLE_SELECT:"simple_select",DIRECT_SELECT:"direct_select"},K={CREATE:"draw.create",DELETE:"draw.delete",UPDATE:"draw.update",SELECTION_CHANGE:"draw.selectionchange",MODE_CHANGE:"draw.modechange",ACTIONABLE:"draw.actionable",RENDER:"draw.render",COMBINE_FEATURES:"draw.combine",UNCOMBINE_FEATURES:"draw.uncombine"},Xe={MOVE:"move",CHANGE_PROPERTIES:"change_properties",CHANGE_COORDINATES:"change_coordinates"},W={FEATURE:"feature",MIDPOINT:"midpoint",VERTEX:"vertex"},z={ACTIVE:"true",INACTIVE:"false"},co=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate"],Pr=-90,_t=-85,Or=90,bt=85,xr=-270,Ar=270,uo=Object.freeze(Object.defineProperty({__proto__:null,LAT_MAX:Or,LAT_MIN:Pr,LAT_RENDERED_MAX:bt,LAT_RENDERED_MIN:_t,LNG_MAX:Ar,LNG_MIN:xr,activeStates:z,classes:oe,cursors:G,events:K,geojsonTypes:C,interactions:co,meta:W,modes:L,sources:pe,types:re,updateActions:Xe},Symbol.toStringTag,{value:"Module"})),Ht={Point:0,LineString:1,MultiLineString:1,Polygon:2};function Nr(e,t){const o=Ht[e.geometry.type]-Ht[t.geometry.type];return o===0&&e.geometry.type===C.POLYGON?e.area-t.area:o}function po(e){return e.map(t=>(t.geometry.type===C.POLYGON&&(t.area=rt.geometry({type:C.FEATURE,property:{},geometry:t.geometry})),t)).sort(Nr).map(t=>(delete t.area,t))}function fo(e,t=0){return[[e.point.x-t,e.point.y-t],[e.point.x+t,e.point.y+t]]}function he(e){if(this._items={},this._nums={},this._length=e?e.length:0,!!e)for(let t=0,o=e.length;t<o;t++)this.add(e[t]),e[t]!==void 0&&(typeof e[t]=="string"?this._items[e[t]]=t:this._nums[e[t]]=t)}he.prototype.add=function(e){return this.has(e)?this:(this._length++,typeof e=="string"?this._items[e]=this._length:this._nums[e]=this._length,this)};he.prototype.delete=function(e){return this.has(e)===!1?this:(this._length--,delete this._items[e],delete this._nums[e],this)};he.prototype.has=function(e){return typeof e!="string"&&typeof e!="number"?!1:this._items[e]!==void 0||this._nums[e]!==void 0};he.prototype.values=function(){const e=[];return Object.keys(this._items).forEach(t=>{e.push({k:t,v:this._items[t]})}),Object.keys(this._nums).forEach(t=>{e.push({k:JSON.parse(t),v:this._nums[t]})}),e.sort((t,o)=>t.v-o.v).map(t=>t.k)};he.prototype.clear=function(){return this._length=0,this._items={},this._nums={},this};const Fr=[W.FEATURE,W.MIDPOINT,W.VERTEX],Ve={click:Dr,touch:Rr};function Dr(e,t,o){return ho(e,t,o,o.options.clickBuffer)}function Rr(e,t,o){return ho(e,t,o,o.options.touchBuffer)}function ho(e,t,o,r){if(o.map===null)return[];const n=e?fo(e,r):t,i={};o.options.styles&&(i.layers=o.options.styles.map(u=>u.id).filter(u=>o.map.getLayer(u)!=null));const s=o.map.queryRenderedFeatures(n,i).filter(u=>Fr.indexOf(u.properties.meta)!==-1),c=new he,a=[];return s.forEach(u=>{const y=u.properties.id;c.has(y)||(c.add(y),a.push(u))}),po(a)}function nt(e,t){const o=Ve.click(e,null,t),r={mouse:G.NONE};return o[0]&&(r.mouse=o[0].properties.active===z.ACTIVE?G.MOVE:G.POINTER,r.feature=o[0].properties.meta),t.events.currentModeName().indexOf("draw")!==-1&&(r.mouse=G.ADD),t.ui.queueMapClasses(r),t.ui.updateMapClasses(),o[0]}function wt(e,t){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)}const kr=4,Ur=12,Br=500;function It(e,t,o={}){const r=o.fineTolerance!=null?o.fineTolerance:kr,n=o.grossTolerance!=null?o.grossTolerance:Ur,i=o.interval!=null?o.interval:Br;e.point=e.point||t.point,e.time=e.time||t.time;const s=wt(e.point,t.point);return s<r||s<n&&t.time-e.time<i}const $r=25,Gr=250;function Mt(e,t,o={}){const r=o.tolerance!=null?o.tolerance:$r,n=o.interval!=null?o.interval:Gr;return e.point=e.point||t.point,e.time=e.time||t.time,wt(e.point,t.point)<r&&t.time-e.time<n}let Vr=(e,t=21)=>(o=t)=>{let r="",n=o|0;for(;n--;)r+=e[Math.random()*e.length|0];return r};const jr=Vr("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz",32);function Pt(){return jr()}const Q=function(e,t){this.ctx=e,this.properties=t.properties||{},this.coordinates=t.geometry.coordinates,this.id=t.id||Pt(),this.type=t.geometry.type};Q.prototype.changed=function(){this.ctx.store.featureChanged(this.id)};Q.prototype.incomingCoords=function(e){this.setCoordinates(e)};Q.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};Q.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.coordinates))};Q.prototype.setProperty=function(e,t){this.properties[e]=t};Q.prototype.toGeoJSON=function(){return JSON.parse(JSON.stringify({id:this.id,type:C.FEATURE,properties:this.properties,geometry:{coordinates:this.getCoordinates(),type:this.type}}))};Q.prototype.internal=function(e){const t={id:this.id,meta:W.FEATURE,"meta:type":this.type,active:z.INACTIVE,mode:e};if(this.ctx.options.userProperties)for(const o in this.properties)t[`user_${o}`]=this.properties[o];return{type:C.FEATURE,properties:t,geometry:{coordinates:this.getCoordinates(),type:this.type}}};const xe=function(e,t){Q.call(this,e,t)};xe.prototype=Object.create(Q.prototype);xe.prototype.isValid=function(){return typeof this.coordinates[0]=="number"&&typeof this.coordinates[1]=="number"};xe.prototype.updateCoordinate=function(e,t,o){arguments.length===3?this.coordinates=[t,o]:this.coordinates=[e,t],this.changed()};xe.prototype.getCoordinate=function(){return this.getCoordinates()};const Te=function(e,t){Q.call(this,e,t)};Te.prototype=Object.create(Q.prototype);Te.prototype.isValid=function(){return this.coordinates.length>1};Te.prototype.addCoordinate=function(e,t,o){this.changed();const r=parseInt(e,10);this.coordinates.splice(r,0,[t,o])};Te.prototype.getCoordinate=function(e){const t=parseInt(e,10);return JSON.parse(JSON.stringify(this.coordinates[t]))};Te.prototype.removeCoordinate=function(e){this.changed(),this.coordinates.splice(parseInt(e,10),1)};Te.prototype.updateCoordinate=function(e,t,o){const r=parseInt(e,10);this.coordinates[r]=[t,o],this.changed()};const ce=function(e,t){Q.call(this,e,t),this.coordinates=this.coordinates.map(o=>o.slice(0,-1))};ce.prototype=Object.create(Q.prototype);ce.prototype.isValid=function(){return this.coordinates.length===0?!1:this.coordinates.every(e=>e.length>2)};ce.prototype.incomingCoords=function(e){this.coordinates=e.map(t=>t.slice(0,-1)),this.changed()};ce.prototype.setCoordinates=function(e){this.coordinates=e,this.changed()};ce.prototype.addCoordinate=function(e,t,o){this.changed();const r=e.split(".").map(i=>parseInt(i,10));this.coordinates[r[0]].splice(r[1],0,[t,o])};ce.prototype.removeCoordinate=function(e){this.changed();const t=e.split(".").map(r=>parseInt(r,10)),o=this.coordinates[t[0]];o&&(o.splice(t[1],1),o.length<3&&this.coordinates.splice(t[0],1))};ce.prototype.getCoordinate=function(e){const t=e.split(".").map(r=>parseInt(r,10)),o=this.coordinates[t[0]];return JSON.parse(JSON.stringify(o[t[1]]))};ce.prototype.getCoordinates=function(){return this.coordinates.map(e=>e.concat([e[0]]))};ce.prototype.updateCoordinate=function(e,t,o){this.changed();const r=e.split("."),n=parseInt(r[0],10),i=parseInt(r[1],10);this.coordinates[n]===void 0&&(this.coordinates[n]=[]),this.coordinates[n][i]=[t,o]};const zr={MultiPoint:xe,MultiLineString:Te,MultiPolygon:ce},ut=(e,t,o,r,n)=>{const i=o.split("."),s=parseInt(i[0],10),c=i[1]?i.slice(1).join("."):null;return e[s][t](c,r,n)},Z=function(e,t){if(Q.call(this,e,t),delete this.coordinates,this.model=zr[t.geometry.type],this.model===void 0)throw new TypeError(`${t.geometry.type} is not a valid type`);this.features=this._coordinatesToFeatures(t.geometry.coordinates)};Z.prototype=Object.create(Q.prototype);Z.prototype._coordinatesToFeatures=function(e){const t=this.model.bind(this);return e.map(o=>new t(this.ctx,{id:Pt(),type:C.FEATURE,properties:{},geometry:{coordinates:o,type:this.type.replace("Multi","")}}))};Z.prototype.isValid=function(){return this.features.every(e=>e.isValid())};Z.prototype.setCoordinates=function(e){this.features=this._coordinatesToFeatures(e),this.changed()};Z.prototype.getCoordinate=function(e){return ut(this.features,"getCoordinate",e)};Z.prototype.getCoordinates=function(){return JSON.parse(JSON.stringify(this.features.map(e=>e.type===C.POLYGON?e.getCoordinates():e.coordinates)))};Z.prototype.updateCoordinate=function(e,t,o){ut(this.features,"updateCoordinate",e,t,o),this.changed()};Z.prototype.addCoordinate=function(e,t,o){ut(this.features,"addCoordinate",e,t,o),this.changed()};Z.prototype.removeCoordinate=function(e){ut(this.features,"removeCoordinate",e),this.changed()};Z.prototype.getFeatures=function(){return this.features};function I(e){this.map=e.map,this.drawConfig=JSON.parse(JSON.stringify(e.options||{})),this._ctx=e}I.prototype.setSelected=function(e){return this._ctx.store.setSelected(e)};I.prototype.setSelectedCoordinates=function(e){this._ctx.store.setSelectedCoordinates(e),e.reduce((t,o)=>(t[o.feature_id]===void 0&&(t[o.feature_id]=!0,this._ctx.store.get(o.feature_id).changed()),t),{})};I.prototype.getSelected=function(){return this._ctx.store.getSelected()};I.prototype.getSelectedIds=function(){return this._ctx.store.getSelectedIds()};I.prototype.isSelected=function(e){return this._ctx.store.isSelected(e)};I.prototype.getFeature=function(e){return this._ctx.store.get(e)};I.prototype.select=function(e){return this._ctx.store.select(e)};I.prototype.deselect=function(e){return this._ctx.store.deselect(e)};I.prototype.deleteFeature=function(e,t={}){return this._ctx.store.delete(e,t)};I.prototype.addFeature=function(e,t={}){return this._ctx.store.add(e,t)};I.prototype.clearSelectedFeatures=function(){return this._ctx.store.clearSelected()};I.prototype.clearSelectedCoordinates=function(){return this._ctx.store.clearSelectedCoordinates()};I.prototype.setActionableState=function(e={}){const t={trash:e.trash||!1,combineFeatures:e.combineFeatures||!1,uncombineFeatures:e.uncombineFeatures||!1};return this._ctx.events.actionable(t)};I.prototype.changeMode=function(e,t={},o={}){return this._ctx.events.changeMode(e,t,o)};I.prototype.fire=function(e,t){return this._ctx.events.fire(e,t)};I.prototype.updateUIClasses=function(e){return this._ctx.ui.queueMapClasses(e)};I.prototype.activateUIButton=function(e){return this._ctx.ui.setActiveButton(e)};I.prototype.featuresAt=function(e,t,o="click"){if(o!=="click"&&o!=="touch")throw new Error("invalid buffer type");return Ve[o](e,t,this._ctx)};I.prototype.newFeature=function(e){const t=e.geometry.type;return t===C.POINT?new xe(this._ctx,e):t===C.LINE_STRING?new Te(this._ctx,e):t===C.POLYGON?new ce(this._ctx,e):new Z(this._ctx,e)};I.prototype.isInstanceOf=function(e,t){if(e===C.POINT)return t instanceof xe;if(e===C.LINE_STRING)return t instanceof Te;if(e===C.POLYGON)return t instanceof ce;if(e==="MultiFeature")return t instanceof Z;throw new Error(`Unknown feature class: ${e}`)};I.prototype.doRender=function(e){return this._ctx.store.featureChanged(e)};I.prototype.onSetup=function(){};I.prototype.onDrag=function(){};I.prototype.onClick=function(){};I.prototype.onMouseMove=function(){};I.prototype.onMouseDown=function(){};I.prototype.onMouseUp=function(){};I.prototype.onMouseOut=function(){};I.prototype.onKeyUp=function(){};I.prototype.onKeyDown=function(){};I.prototype.onTouchStart=function(){};I.prototype.onTouchMove=function(){};I.prototype.onTouchEnd=function(){};I.prototype.onTap=function(){};I.prototype.onStop=function(){};I.prototype.onTrash=function(){};I.prototype.onCombineFeature=function(){};I.prototype.onUncombineFeature=function(){};I.prototype.toDisplayFeatures=function(){throw new Error("You must overwrite toDisplayFeatures")};const go={drag:"onDrag",click:"onClick",mousemove:"onMouseMove",mousedown:"onMouseDown",mouseup:"onMouseUp",mouseout:"onMouseOut",keyup:"onKeyUp",keydown:"onKeyDown",touchstart:"onTouchStart",touchmove:"onTouchMove",touchend:"onTouchEnd",tap:"onTap"},Jr=Object.keys(go);function Hr(e){const t=Object.keys(e);return function(o,r={}){let n={};const i=t.reduce((c,a)=>(c[a]=e[a],c),new I(o));function s(c){return a=>i[c](n,a)}return{start(){n=i.onSetup(r),Jr.forEach(c=>{const a=go[c];let u=()=>!1;e[a]&&(u=()=>!0),this.on(c,u,s(a))})},stop(){i.onStop(n)},trash(){i.onTrash(n)},combineFeatures(){i.onCombineFeatures(n)},uncombineFeatures(){i.onUncombineFeatures(n)},render(c,a){i.toDisplayFeatures(n,c,a)}}}}function Wr(e){const t=Object.keys(e.options.modes).reduce((l,d)=>(l[d]=Hr(e.options.modes[d]),l),{});let o={},r={};const n={};let i=null,s=null;n.drag=function(l,d){d({point:l.point,time:new Date().getTime()})?(e.ui.queueMapClasses({mouse:G.DRAG}),s.drag(l)):l.originalEvent.stopPropagation()},n.mousedrag=function(l){n.drag(l,d=>!It(o,d))},n.touchdrag=function(l){n.drag(l,d=>!Mt(r,d))},n.mousemove=function(l){if((l.originalEvent.buttons!==void 0?l.originalEvent.buttons:l.originalEvent.which)===1)return n.mousedrag(l);const h=nt(l,e);l.featureTarget=h,s.mousemove(l)},n.mousedown=function(l){o={time:new Date().getTime(),point:l.point};const d=nt(l,e);l.featureTarget=d,s.mousedown(l)},n.mouseup=function(l){const d=nt(l,e);l.featureTarget=d,It(o,{point:l.point,time:new Date().getTime()})?s.click(l):s.mouseup(l)},n.mouseout=function(l){s.mouseout(l)},n.touchstart=function(l){if(!e.options.touchEnabled)return;r={time:new Date().getTime(),point:l.point};const d=Ve.touch(l,null,e)[0];l.featureTarget=d,s.touchstart(l)},n.touchmove=function(l){if(e.options.touchEnabled)return s.touchmove(l),n.touchdrag(l)},n.touchend=function(l){if(l.originalEvent.preventDefault(),!e.options.touchEnabled)return;const d=Ve.touch(l,null,e)[0];l.featureTarget=d,Mt(r,{time:new Date().getTime(),point:l.point})?s.tap(l):s.touchend(l)};const c=l=>!(l===8||l===46||l>=48&&l<=57);n.keydown=function(l){(l.srcElement||l.target).classList.contains(oe.CANVAS)&&((l.keyCode===8||l.keyCode===46)&&e.options.controls.trash?(l.preventDefault(),s.trash()):c(l.keyCode)?s.keydown(l):l.keyCode===49&&e.options.controls.point?a(L.DRAW_POINT):l.keyCode===50&&e.options.controls.line_string?a(L.DRAW_LINE_STRING):l.keyCode===51&&e.options.controls.polygon&&a(L.DRAW_POLYGON))},n.keyup=function(l){c(l.keyCode)&&s.keyup(l)},n.zoomend=function(){e.store.changeZoom()},n.data=function(l){if(l.dataType==="style"){const{setup:d,map:h,options:_,store:b}=e;_.styles.some(V=>h.getLayer(V.id))||(d.addLayers(),b.setDirty(),b.render())}};function a(l,d,h={}){s.stop();const _=t[l];if(_===void 0)throw new Error(`${l} is not valid`);i=l;const b=_(e,d);s=Tt(b,e),h.silent||e.map.fire(K.MODE_CHANGE,{mode:l}),e.store.setDirty(),e.store.render()}const u={trash:!1,combineFeatures:!1,uncombineFeatures:!1};function y(l){let d=!1;Object.keys(l).forEach(h=>{if(u[h]===void 0)throw new Error("Invalid action type");u[h]!==l[h]&&(d=!0),u[h]=l[h]}),d&&e.map.fire(K.ACTIONABLE,{actions:u})}return{start(){i=e.options.defaultMode,s=Tt(t[i](e),e)},changeMode:a,actionable:y,currentModeName(){return i},currentModeRender(l,d){return s.render(l,d)},fire(l,d){e.map&&e.map.fire(l,d)},addEventListeners(){e.map.on("mousemove",n.mousemove),e.map.on("mousedown",n.mousedown),e.map.on("mouseup",n.mouseup),e.map.on("data",n.data),e.map.on("touchmove",n.touchmove),e.map.on("touchstart",n.touchstart),e.map.on("touchend",n.touchend),e.container.addEventListener("mouseout",n.mouseout),e.options.keybindings&&(e.container.addEventListener("keydown",n.keydown),e.container.addEventListener("keyup",n.keyup))},removeEventListeners(){e.map.off("mousemove",n.mousemove),e.map.off("mousedown",n.mousedown),e.map.off("mouseup",n.mouseup),e.map.off("data",n.data),e.map.off("touchmove",n.touchmove),e.map.off("touchstart",n.touchstart),e.map.off("touchend",n.touchend),e.container.removeEventListener("mouseout",n.mouseout),e.options.keybindings&&(e.container.removeEventListener("keydown",n.keydown),e.container.removeEventListener("keyup",n.keyup))},trash(l){s.trash(l)},combineFeatures(){s.combineFeatures()},uncombineFeatures(){s.uncombineFeatures()},getMode(){return i}}}function Ze(e){return[].concat(e).filter(t=>t!==void 0)}function qr(){const e=this;if(!(e.ctx.map&&e.ctx.map.getSource(pe.HOT)!==void 0))return a();const o=e.ctx.events.currentModeName();e.ctx.ui.queueMapClasses({mode:o});let r=[],n=[];e.isDirty?n=e.getAllIds():(r=e.getChangedIds().filter(u=>e.get(u)!==void 0),n=e.sources.hot.filter(u=>u.properties.id&&r.indexOf(u.properties.id)===-1&&e.get(u.properties.id)!==void 0).map(u=>u.properties.id)),e.sources.hot=[];const i=e.sources.cold.length;e.sources.cold=e.isDirty?[]:e.sources.cold.filter(u=>{const y=u.properties.id||u.properties.parent;return r.indexOf(y)===-1});const s=i!==e.sources.cold.length||n.length>0;r.forEach(u=>c(u,"hot")),n.forEach(u=>c(u,"cold"));function c(u,y){const l=e.get(u).internal(o);e.ctx.events.currentModeRender(l,d=>{d.properties.mode=o,e.sources[y].push(d)})}s&&e.ctx.map.getSource(pe.COLD).setData({type:C.FEATURE_COLLECTION,features:e.sources.cold}),e.ctx.map.getSource(pe.HOT).setData({type:C.FEATURE_COLLECTION,features:e.sources.hot}),a();function a(){e.isDirty=!1,e.clearChangedIds()}}function B(e){this._features={},this._featureIds=new he,this._selectedFeatureIds=new he,this._selectedCoordinates=[],this._changedFeatureIds=new he,this._emitSelectionChange=!1,this._mapInitialConfig={},this.ctx=e,this.sources={hot:[],cold:[]};let t;this.render=()=>{t||(t=requestAnimationFrame(()=>{t=null,qr.call(this),this._emitSelectionChange&&(this.ctx.events.fire(K.SELECTION_CHANGE,{features:this.getSelected().map(o=>o.toGeoJSON()),points:this.getSelectedCoordinates().map(o=>({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:o.coordinates}}))}),this._emitSelectionChange=!1),this.ctx.events.fire(K.RENDER,{})}))},this.isDirty=!1}B.prototype.createRenderBatch=function(){const e=this.render;let t=0;return this.render=function(){t++},()=>{this.render=e,t>0&&this.render()}};B.prototype.setDirty=function(){return this.isDirty=!0,this};B.prototype.featureCreated=function(e,t={}){if(this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0){const r=this.get(e);this.ctx.events.fire(K.CREATE,{features:[r.toGeoJSON()]})}return this};B.prototype.featureChanged=function(e,t={}){return this._changedFeatureIds.add(e),(t.silent!=null?t.silent:this.ctx.options.suppressAPIEvents)!==!0&&this.ctx.events.fire(K.UPDATE,{action:t.action?t.action:Xe.CHANGE_COORDINATES,features:[this.get(e).toGeoJSON()]}),this};B.prototype.getChangedIds=function(){return this._changedFeatureIds.values()};B.prototype.clearChangedIds=function(){return this._changedFeatureIds.clear(),this};B.prototype.getAllIds=function(){return this._featureIds.values()};B.prototype.add=function(e,t={}){return this._features[e.id]=e,this._featureIds.add(e.id),this.featureCreated(e.id,{silent:t.silent}),this};B.prototype.delete=function(e,t={}){const o=[];return Ze(e).forEach(r=>{this._featureIds.has(r)&&(this._featureIds.delete(r),this._selectedFeatureIds.delete(r),t.silent||o.indexOf(this._features[r])===-1&&o.push(this._features[r].toGeoJSON()),delete this._features[r],this.isDirty=!0)}),o.length&&this.ctx.events.fire(K.DELETE,{features:o}),yo(this,t),this};B.prototype.get=function(e){return this._features[e]};B.prototype.getAll=function(){return Object.keys(this._features).map(e=>this._features[e])};B.prototype.select=function(e,t={}){return Ze(e).forEach(o=>{this._selectedFeatureIds.has(o)||(this._selectedFeatureIds.add(o),this._changedFeatureIds.add(o),t.silent||(this._emitSelectionChange=!0))}),this};B.prototype.deselect=function(e,t={}){return Ze(e).forEach(o=>{this._selectedFeatureIds.has(o)&&(this._selectedFeatureIds.delete(o),this._changedFeatureIds.add(o),t.silent||(this._emitSelectionChange=!0))}),yo(this,t),this};B.prototype.clearSelected=function(e={}){return this.deselect(this._selectedFeatureIds.values(),{silent:e.silent}),this};B.prototype.setSelected=function(e,t={}){return e=Ze(e),this.deselect(this._selectedFeatureIds.values().filter(o=>e.indexOf(o)===-1),{silent:t.silent}),this.select(e.filter(o=>!this._selectedFeatureIds.has(o)),{silent:t.silent}),this};B.prototype.setSelectedCoordinates=function(e){return this._selectedCoordinates=e,this._emitSelectionChange=!0,this};B.prototype.clearSelectedCoordinates=function(){return this._selectedCoordinates=[],this._emitSelectionChange=!0,this};B.prototype.getSelectedIds=function(){return this._selectedFeatureIds.values()};B.prototype.getSelected=function(){return this.getSelectedIds().map(e=>this.get(e))};B.prototype.getSelectedCoordinates=function(){return this._selectedCoordinates.map(t=>({coordinates:this.get(t.feature_id).getCoordinate(t.coord_path)}))};B.prototype.isSelected=function(e){return this._selectedFeatureIds.has(e)};B.prototype.setFeatureProperty=function(e,t,o,r={}){this.get(e).setProperty(t,o),this.featureChanged(e,{silent:r.silent,action:Xe.CHANGE_PROPERTIES})};function yo(e,t={}){const o=e._selectedCoordinates.filter(r=>e._selectedFeatureIds.has(r.feature_id));e._selectedCoordinates.length!==o.length&&!t.silent&&(e._emitSelectionChange=!0),e._selectedCoordinates=o}B.prototype.storeMapConfig=function(){co.forEach(e=>{this.ctx.map[e]&&(this._mapInitialConfig[e]=this.ctx.map[e].isEnabled())})};B.prototype.restoreMapConfig=function(){Object.keys(this._mapInitialConfig).forEach(e=>{this._mapInitialConfig[e]?this.ctx.map[e].enable():this.ctx.map[e].disable()})};B.prototype.getInitialConfigValue=function(e){return this._mapInitialConfig[e]!==void 0?this._mapInitialConfig[e]:!0};const Yr=["mode","feature","mouse"];function Xr(e){const t={};let o=null,r={mode:null,feature:null,mouse:null},n={mode:null,feature:null,mouse:null};function i(){s({mode:null,feature:null,mouse:null}),c()}function s(d){n=Object.assign(n,d)}function c(){if(!e.container)return;const d=[],h=[];Yr.forEach(_=>{n[_]!==r[_]&&(d.push(`${_}-${r[_]}`),n[_]!==null&&h.push(`${_}-${n[_]}`))}),d.length>0&&e.container.classList.remove(...d),h.length>0&&e.container.classList.add(...h),r=Object.assign(r,n)}function a(d,h={}){const _=document.createElement("button");return _.className=`${oe.CONTROL_BUTTON} ${h.className}`,_.setAttribute("title",h.title),h.container.appendChild(_),_.addEventListener("click",b=>{if(b.preventDefault(),b.stopPropagation(),b.target===o){u(),h.onDeactivate();return}y(d),h.onActivate()},!0),_}function u(){o&&(o.classList.remove(oe.ACTIVE_BUTTON),o=null)}function y(d){u();const h=t[d];h&&h&&d!=="trash"&&(h.classList.add(oe.ACTIVE_BUTTON),o=h)}function E(){const d=e.options.controls,h=document.createElement("div");return h.className=`${oe.CONTROL_GROUP} ${oe.CONTROL_BASE}`,d&&(d[re.LINE]&&(t[re.LINE]=a(re.LINE,{container:h,className:oe.CONTROL_BUTTON_LINE,title:`LineString tool ${e.options.keybindings?"(l)":""}`,onActivate:()=>e.events.changeMode(L.DRAW_LINE_STRING),onDeactivate:()=>e.events.trash()})),d[re.POLYGON]&&(t[re.POLYGON]=a(re.POLYGON,{container:h,className:oe.CONTROL_BUTTON_POLYGON,title:`Polygon tool ${e.options.keybindings?"(p)":""}`,onActivate:()=>e.events.changeMode(L.DRAW_POLYGON),onDeactivate:()=>e.events.trash()})),d[re.POINT]&&(t[re.POINT]=a(re.POINT,{container:h,className:oe.CONTROL_BUTTON_POINT,title:`Marker tool ${e.options.keybindings?"(m)":""}`,onActivate:()=>e.events.changeMode(L.DRAW_POINT),onDeactivate:()=>e.events.trash()})),d.trash&&(t.trash=a("trash",{container:h,className:oe.CONTROL_BUTTON_TRASH,title:"Delete",onActivate:()=>{e.events.trash()}})),d.combine_features&&(t.combine_features=a("combineFeatures",{container:h,className:oe.CONTROL_BUTTON_COMBINE_FEATURES,title:"Combine",onActivate:()=>{e.events.combineFeatures()}})),d.uncombine_features&&(t.uncombine_features=a("uncombineFeatures",{container:h,className:oe.CONTROL_BUTTON_UNCOMBINE_FEATURES,title:"Uncombine",onActivate:()=>{e.events.uncombineFeatures()}}))),h}function l(){Object.keys(t).forEach(d=>{const h=t[d];h.parentNode&&h.parentNode.removeChild(h),delete t[d]})}return{setActiveButton:y,queueMapClasses:s,updateMapClasses:c,clearMapClasses:i,addButtons:E,removeButtons:l}}function Zr(e){let t=null,o=null;const r={onRemove(){return e.map.off("load",r.connect),clearInterval(o),r.removeLayers(),e.store.restoreMapConfig(),e.ui.removeButtons(),e.events.removeEventListeners(),e.ui.clearMapClasses(),e.boxZoomInitial&&e.map.boxZoom.enable(),e.map=null,e.container=null,e.store=null,t&&t.parentNode&&t.parentNode.removeChild(t),t=null,this},connect(){e.map.off("load",r.connect),clearInterval(o),r.addLayers(),e.store.storeMapConfig(),e.events.addEventListeners()},onAdd(n){if(e.map=n,e.events=Wr(e),e.ui=Xr(e),e.container=n.getContainer(),e.store=new B(e),t=e.ui.addButtons(),e.options.boxSelect){e.boxZoomInitial=n.boxZoom.isEnabled(),n.boxZoom.disable();const i=n.dragPan.isEnabled();n.dragPan.disable(),n.dragPan.enable(),i||n.dragPan.disable()}return n.loaded()?r.connect():(n.on("load",r.connect),o=setInterval(()=>{n.loaded()&&r.connect()},16)),e.events.start(),t},addLayers(){e.map.addSource(pe.COLD,{data:{type:C.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.map.addSource(pe.HOT,{data:{type:C.FEATURE_COLLECTION,features:[]},type:"geojson"}),e.options.styles.forEach(n=>{e.map.addLayer(n)}),e.store.setDirty(!0),e.store.render()},removeLayers(){e.options.styles.forEach(n=>{e.map.getLayer(n.id)&&e.map.removeLayer(n.id)}),e.map.getSource(pe.COLD)&&e.map.removeSource(pe.COLD),e.map.getSource(pe.HOT)&&e.map.removeSource(pe.HOT)}};return e.setup=r,r}const Et="#3bb2d0",We="#fbb03b",Wt="#fff",mo=[{id:"gl-draw-polygon-fill",type:"fill",filter:["all",["==","$type","Polygon"]],paint:{"fill-color":["case",["==",["get","active"],"true"],We,Et],"fill-opacity":.1}},{id:"gl-draw-lines",type:"line",filter:["any",["==","$type","LineString"],["==","$type","Polygon"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":["case",["==",["get","active"],"true"],We,Et],"line-dasharray":["case",["==",["get","active"],"true"],[.2,2],[2,0]],"line-width":2}},{id:"gl-draw-point-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Wt}},{id:"gl-draw-point-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","feature"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":["case",["==",["get","active"],"true"],We,Et]}},{id:"gl-draw-vertex-outer",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],7,5],"circle-color":Wt}},{id:"gl-draw-vertex-inner",type:"circle",filter:["all",["==","$type","Point"],["==","meta","vertex"],["!=","mode","simple_select"]],paint:{"circle-radius":["case",["==",["get","active"],"true"],5,3],"circle-color":We}},{id:"gl-draw-midpoint",type:"circle",filter:["all",["==","meta","midpoint"]],paint:{"circle-radius":3,"circle-color":We}}];function dt(e){return function(t){const o=t.featureTarget;return!o||!o.properties?!1:o.properties.meta===e}}function Eo(e){return!e.originalEvent||!e.originalEvent.shiftKey?!1:e.originalEvent.button===0}function Fe(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===z.ACTIVE&&e.featureTarget.properties.meta===W.FEATURE}function Ot(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.active===z.INACTIVE&&e.featureTarget.properties.meta===W.FEATURE}function pt(e){return e.featureTarget===void 0}function xt(e){return!e.featureTarget||!e.featureTarget.properties?!1:e.featureTarget.properties.meta===W.FEATURE}function Ke(e){const t=e.featureTarget;return!t||!t.properties?!1:t.properties.meta===W.VERTEX}function at(e){return e.originalEvent?e.originalEvent.shiftKey===!0:!1}function ft(e){return e.keyCode===27}function ht(e){return e.keyCode===13}function Kr(){return!0}const Qr=Object.freeze(Object.defineProperty({__proto__:null,isActiveFeature:Fe,isEnterKey:ht,isEscapeKey:ft,isFeature:xt,isInactiveFeature:Ot,isOfMetaType:dt,isShiftDown:at,isShiftMousedown:Eo,isTrue:Kr,isVertex:Ke,noTarget:pt},Symbol.toStringTag,{value:"Module"}));function Oe(e,t){this.x=e,this.y=t}Oe.prototype={clone(){return new Oe(this.x,this.y)},add(e){return this.clone()._add(e)},sub(e){return this.clone()._sub(e)},multByPoint(e){return this.clone()._multByPoint(e)},divByPoint(e){return this.clone()._divByPoint(e)},mult(e){return this.clone()._mult(e)},div(e){return this.clone()._div(e)},rotate(e){return this.clone()._rotate(e)},rotateAround(e,t){return this.clone()._rotateAround(e,t)},matMult(e){return this.clone()._matMult(e)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(e){return this.x===e.x&&this.y===e.y},dist(e){return Math.sqrt(this.distSqr(e))},distSqr(e){const t=e.x-this.x,o=e.y-this.y;return t*t+o*o},angle(){return Math.atan2(this.y,this.x)},angleTo(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith(e){return this.angleWithSep(e.x,e.y)},angleWithSep(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult(e){const t=e[0]*this.x+e[1]*this.y,o=e[2]*this.x+e[3]*this.y;return this.x=t,this.y=o,this},_add(e){return this.x+=e.x,this.y+=e.y,this},_sub(e){return this.x-=e.x,this.y-=e.y,this},_mult(e){return this.x*=e,this.y*=e,this},_div(e){return this.x/=e,this.y/=e,this},_multByPoint(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint(e){return this.x/=e.x,this.y/=e.y,this},_unit(){return this._div(this.mag()),this},_perp(){const e=this.y;return this.y=this.x,this.x=-e,this},_rotate(e){const t=Math.cos(e),o=Math.sin(e),r=t*this.x-o*this.y,n=o*this.x+t*this.y;return this.x=r,this.y=n,this},_rotateAround(e,t){const o=Math.cos(e),r=Math.sin(e),n=t.x+o*(this.x-t.x)-r*(this.y-t.y),i=t.y+r*(this.x-t.x)+o*(this.y-t.y);return this.x=n,this.y=i,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:Oe};Oe.convert=function(e){if(e instanceof Oe)return e;if(Array.isArray(e))return new Oe(+e[0],+e[1]);if(e.x!==void 0&&e.y!==void 0)return new Oe(+e.x,+e.y);throw new Error("Expected [x, y] or {x, y} point format")};function At(e,t){const o=t.getBoundingClientRect();return new Oe(e.clientX-o.left-(t.clientLeft||0),e.clientY-o.top-(t.clientTop||0))}function je(e,t,o,r){return{type:C.FEATURE,properties:{meta:W.VERTEX,parent:e,coord_path:o,active:r?z.ACTIVE:z.INACTIVE},geometry:{type:C.POINT,coordinates:t}}}function vo(e,t,o){const r=t.geometry.coordinates,n=o.geometry.coordinates;if(r[1]>bt||r[1]<_t||n[1]>bt||n[1]<_t)return null;const i={lng:(r[0]+n[0])/2,lat:(r[1]+n[1])/2};return{type:C.FEATURE,properties:{meta:W.MIDPOINT,parent:e,lng:i.lng,lat:i.lat,coord_path:o.properties.coord_path},geometry:{type:C.POINT,coordinates:[i.lng,i.lat]}}}function gt(e,t={},o=null){const{type:r,coordinates:n}=e.geometry,i=e.properties&&e.properties.id;let s=[];r===C.POINT?s.push(je(i,n,o,a(o))):r===C.POLYGON?n.forEach((y,E)=>{c(y,o!==null?`${o}.${E}`:String(E))}):r===C.LINE_STRING?c(n,o):r.indexOf(C.MULTI_PREFIX)===0&&u();function c(y,E){let l="",d=null;y.forEach((h,_)=>{const b=E!=null?`${E}.${_}`:String(_),D=je(i,h,b,a(b));if(t.midpoints&&d){const $=vo(i,d,D);$&&s.push($)}d=D;const V=JSON.stringify(h);l!==V&&s.push(D),_===0&&(l=V)})}function a(y){return t.selectedPaths?t.selectedPaths.indexOf(y)!==-1:!1}function u(){const y=r.replace(C.MULTI_PREFIX,"");n.forEach((E,l)=>{const d={type:C.FEATURE,properties:e.properties,geometry:{type:y,coordinates:E}};s=s.concat(gt(d,t,l))})}return s}const me={enable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||!e._ctx||!e._ctx.store||!e._ctx.store.getInitialConfigValue||e._ctx.store.getInitialConfigValue("doubleClickZoom")&&e.map.doubleClickZoom.enable()},0)},disable(e){setTimeout(()=>{!e.map||!e.map.doubleClickZoom||e.map.doubleClickZoom.disable()},0)}},{LAT_MIN:tt,LAT_MAX:ot,LAT_RENDERED_MIN:qt,LAT_RENDERED_MAX:Yt,LNG_MIN:Xt,LNG_MAX:Zt}=uo;function en(e){const t={Point:0,LineString:1,Polygon:2,MultiPoint:1,MultiLineString:2,MultiPolygon:3}[e.geometry.type],o=[e.geometry.coordinates].flat(t),r=o.map(c=>c[0]),n=o.map(c=>c[1]),i=c=>Math.min.apply(null,c),s=c=>Math.max.apply(null,c);return[i(r),i(n),s(r),s(n)]}function Nt(e,t){let o=tt,r=ot,n=tt,i=ot,s=Zt,c=Xt;e.forEach(u=>{const y=en(u),E=y[1],l=y[3],d=y[0],h=y[2];E>o&&(o=E),l<r&&(r=l),l>n&&(n=l),E<i&&(i=E),d<s&&(s=d),h>c&&(c=h)});const a=t;return o+a.lat>Yt&&(a.lat=Yt-o),n+a.lat>ot&&(a.lat=ot-n),r+a.lat<qt&&(a.lat=qt-r),i+a.lat<tt&&(a.lat=tt-i),s+a.lng<=Xt&&(a.lng+=Math.ceil(Math.abs(a.lng)/360)*360),c+a.lng>=Zt&&(a.lng-=Math.ceil(Math.abs(a.lng)/360)*360),a}function Ft(e,t){const o=Nt(e.map(r=>r.toGeoJSON()),t);e.forEach(r=>{const n=r.getCoordinates(),i=u=>{const y={lng:u[0]+o.lng,lat:u[1]+o.lat};return[y.lng,y.lat]},s=u=>u.map(y=>i(y)),c=u=>u.map(y=>s(y));let a;r.type===C.POINT?a=i(n):r.type===C.LINE_STRING||r.type===C.MULTI_POINT?a=n.map(i):r.type===C.POLYGON||r.type===C.MULTI_LINE_STRING?a=n.map(s):r.type===C.MULTI_POLYGON&&(a=n.map(c)),r.incomingCoords(a)})}const k={};k.onSetup=function(e){const t={dragMoveLocation:null,boxSelectStartLocation:null,boxSelectElement:void 0,boxSelecting:!1,canBoxSelect:!1,dragMoving:!1,canDragMove:!1,initialDragPanState:this.map.dragPan.isEnabled(),initiallySelectedFeatureIds:e.featureIds||[]};return this.setSelected(t.initiallySelectedFeatureIds.filter(o=>this.getFeature(o)!==void 0)),this.fireActionable(),this.setActionableState({combineFeatures:!0,uncombineFeatures:!0,trash:!0}),t};k.fireUpdate=function(){this.fire(K.UPDATE,{action:Xe.MOVE,features:this.getSelected().map(e=>e.toGeoJSON())})};k.fireActionable=function(){const e=this.getSelected(),t=e.filter(i=>this.isInstanceOf("MultiFeature",i));let o=!1;if(e.length>1){o=!0;const i=e[0].type.replace("Multi","");e.forEach(s=>{s.type.replace("Multi","")!==i&&(o=!1)})}const r=t.length>0,n=e.length>0;this.setActionableState({combineFeatures:o,uncombineFeatures:r,trash:n})};k.getUniqueIds=function(e){return e.length?e.map(o=>o.properties.id).filter(o=>o!==void 0).reduce((o,r)=>(o.add(r),o),new he).values():[]};k.stopExtendedInteractions=function(e){e.boxSelectElement&&(e.boxSelectElement.parentNode&&e.boxSelectElement.parentNode.removeChild(e.boxSelectElement),e.boxSelectElement=null),(e.canDragMove||e.canBoxSelect)&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.boxSelecting=!1,e.canBoxSelect=!1,e.dragMoving=!1,e.canDragMove=!1};k.onStop=function(){me.enable(this)};k.onMouseMove=function(e,t){return xt(t)&&e.dragMoving&&this.fireUpdate(),this.stopExtendedInteractions(e),!0};k.onMouseOut=function(e){return e.dragMoving?this.fireUpdate():!0};k.onTap=k.onClick=function(e,t){if(pt(t))return this.clickAnywhere(e,t);if(dt(W.VERTEX)(t))return this.clickOnVertex(e,t);if(xt(t))return this.clickOnFeature(e,t)};k.clickAnywhere=function(e){const t=this.getSelectedIds();t.length&&(this.clearSelectedFeatures(),t.forEach(o=>this.doRender(o))),me.enable(this),this.stopExtendedInteractions(e)};k.clickOnVertex=function(e,t){this.changeMode(L.DIRECT_SELECT,{featureId:t.featureTarget.properties.parent,coordPath:t.featureTarget.properties.coord_path,startPos:t.lngLat}),this.updateUIClasses({mouse:G.MOVE})};k.startOnActiveFeature=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),this.doRender(t.featureTarget.properties.id),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};k.clickOnFeature=function(e,t){me.disable(this),this.stopExtendedInteractions(e);const o=at(t),r=this.getSelectedIds(),n=t.featureTarget.properties.id,i=this.isSelected(n);if(!o&&i&&this.getFeature(n).type!==C.POINT)return this.changeMode(L.DIRECT_SELECT,{featureId:n});i&&o?(this.deselect(n),this.updateUIClasses({mouse:G.POINTER}),r.length===1&&me.enable(this)):!i&&o?(this.select(n),this.updateUIClasses({mouse:G.MOVE})):!i&&!o&&(r.forEach(s=>this.doRender(s)),this.setSelected(n),this.updateUIClasses({mouse:G.MOVE})),this.doRender(n)};k.onMouseDown=function(e,t){if(e.initialDragPanState=this.map.dragPan.isEnabled(),Fe(t))return this.startOnActiveFeature(e,t);if(this.drawConfig.boxSelect&&Eo(t))return this.startBoxSelect(e,t)};k.startBoxSelect=function(e,t){this.stopExtendedInteractions(e),this.map.dragPan.disable(),e.boxSelectStartLocation=At(t.originalEvent,this.map.getContainer()),e.canBoxSelect=!0};k.onTouchStart=function(e,t){if(Fe(t))return this.startOnActiveFeature(e,t)};k.onDrag=function(e,t){if(e.canDragMove)return this.dragMove(e,t);if(this.drawConfig.boxSelect&&e.canBoxSelect)return this.whileBoxSelect(e,t)};k.whileBoxSelect=function(e,t){e.boxSelecting=!0,this.updateUIClasses({mouse:G.ADD}),e.boxSelectElement||(e.boxSelectElement=document.createElement("div"),e.boxSelectElement.classList.add(oe.BOX_SELECT),this.map.getContainer().appendChild(e.boxSelectElement));const o=At(t.originalEvent,this.map.getContainer()),r=Math.min(e.boxSelectStartLocation.x,o.x),n=Math.max(e.boxSelectStartLocation.x,o.x),i=Math.min(e.boxSelectStartLocation.y,o.y),s=Math.max(e.boxSelectStartLocation.y,o.y),c=`translate(${r}px, ${i}px)`;e.boxSelectElement.style.transform=c,e.boxSelectElement.style.WebkitTransform=c,e.boxSelectElement.style.width=`${n-r}px`,e.boxSelectElement.style.height=`${s-i}px`};k.dragMove=function(e,t){e.dragMoving=!0,t.originalEvent.stopPropagation();const o={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};Ft(this.getSelected(),o),e.dragMoveLocation=t.lngLat};k.onTouchEnd=k.onMouseUp=function(e,t){if(e.dragMoving)this.fireUpdate();else if(e.boxSelecting){const o=[e.boxSelectStartLocation,At(t.originalEvent,this.map.getContainer())],r=this.featuresAt(null,o,"click"),n=this.getUniqueIds(r).filter(i=>!this.isSelected(i));n.length&&(this.select(n),n.forEach(i=>this.doRender(i)),this.updateUIClasses({mouse:G.MOVE}))}this.stopExtendedInteractions(e)};k.toDisplayFeatures=function(e,t,o){t.properties.active=this.isSelected(t.properties.id)?z.ACTIVE:z.INACTIVE,o(t),this.fireActionable(),!(t.properties.active!==z.ACTIVE||t.geometry.type===C.POINT)&&gt(t).forEach(o)};k.onTrash=function(){this.deleteFeature(this.getSelectedIds()),this.fireActionable()};k.onCombineFeatures=function(){const e=this.getSelected();if(e.length===0||e.length<2)return;const t=[],o=[],r=e[0].type.replace("Multi","");for(let n=0;n<e.length;n++){const i=e[n];if(i.type.replace("Multi","")!==r)return;i.type.includes("Multi")?i.getCoordinates().forEach(s=>{t.push(s)}):t.push(i.getCoordinates()),o.push(i.toGeoJSON())}if(o.length>1){const n=this.newFeature({type:C.FEATURE,properties:o[0].properties,geometry:{type:`Multi${r}`,coordinates:t}});this.addFeature(n),this.deleteFeature(this.getSelectedIds(),{silent:!0}),this.setSelected([n.id]),this.fire(K.COMBINE_FEATURES,{createdFeatures:[n.toGeoJSON()],deletedFeatures:o})}this.fireActionable()};k.onUncombineFeatures=function(){const e=this.getSelected();if(e.length===0)return;const t=[],o=[];for(let r=0;r<e.length;r++){const n=e[r];this.isInstanceOf("MultiFeature",n)&&(n.getFeatures().forEach(i=>{this.addFeature(i),i.properties=n.properties,t.push(i.toGeoJSON()),this.select([i.id])}),this.deleteFeature(n.id,{silent:!0}),o.push(n.toGeoJSON()))}t.length>1&&this.fire(K.UNCOMBINE_FEATURES,{createdFeatures:t,deletedFeatures:o}),this.fireActionable()};const Co=dt(W.VERTEX),So=dt(W.MIDPOINT),U={};U.fireUpdate=function(){this.fire(K.UPDATE,{action:Xe.CHANGE_COORDINATES,features:this.getSelected().map(e=>e.toGeoJSON())})};U.fireActionable=function(e){this.setActionableState({combineFeatures:!1,uncombineFeatures:!1,trash:e.selectedCoordPaths.length>0})};U.startDragging=function(e,t){e.initialDragPanState=this.map.dragPan.isEnabled(),this.map.dragPan.disable(),e.canDragMove=!0,e.dragMoveLocation=t.lngLat};U.stopDragging=function(e){e.canDragMove&&e.initialDragPanState===!0&&this.map.dragPan.enable(),e.dragMoving=!1,e.canDragMove=!1,e.dragMoveLocation=null};U.onVertex=function(e,t){this.startDragging(e,t);const o=t.featureTarget.properties,r=e.selectedCoordPaths.indexOf(o.coord_path);!at(t)&&r===-1?e.selectedCoordPaths=[o.coord_path]:at(t)&&r===-1&&e.selectedCoordPaths.push(o.coord_path);const n=this.pathsToCoordinates(e.featureId,e.selectedCoordPaths);this.setSelectedCoordinates(n)};U.onMidpoint=function(e,t){this.startDragging(e,t);const o=t.featureTarget.properties;e.feature.addCoordinate(o.coord_path,o.lng,o.lat),this.fireUpdate(),e.selectedCoordPaths=[o.coord_path]};U.pathsToCoordinates=function(e,t){return t.map(o=>({feature_id:e,coord_path:o}))};U.onFeature=function(e,t){e.selectedCoordPaths.length===0?this.startDragging(e,t):this.stopDragging(e)};U.dragFeature=function(e,t,o){Ft(this.getSelected(),o),e.dragMoveLocation=t.lngLat};U.dragVertex=function(e,t,o){const r=e.selectedCoordPaths.map(s=>e.feature.getCoordinate(s)),n=r.map(s=>({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:s}})),i=Nt(n,o);for(let s=0;s<r.length;s++){const c=r[s];e.feature.updateCoordinate(e.selectedCoordPaths[s],c[0]+i.lng,c[1]+i.lat)}};U.clickNoTarget=function(){this.changeMode(L.SIMPLE_SELECT)};U.clickInactive=function(){this.changeMode(L.SIMPLE_SELECT)};U.clickActiveFeature=function(e){e.selectedCoordPaths=[],this.clearSelectedCoordinates(),e.feature.changed()};U.onSetup=function(e){const t=e.featureId,o=this.getFeature(t);if(!o)throw new Error("You must provide a featureId to enter direct_select mode");if(o.type===C.POINT)throw new TypeError("direct_select mode doesn't handle point features");const r={featureId:t,feature:o,dragMoveLocation:e.startPos||null,dragMoving:!1,canDragMove:!1,selectedCoordPaths:e.coordPath?[e.coordPath]:[]};return this.setSelectedCoordinates(this.pathsToCoordinates(t,r.selectedCoordPaths)),this.setSelected(t),me.disable(this),this.setActionableState({trash:!0}),r};U.onStop=function(){me.enable(this),this.clearSelectedCoordinates()};U.toDisplayFeatures=function(e,t,o){e.featureId===t.properties.id?(t.properties.active=z.ACTIVE,o(t),gt(t,{map:this.map,midpoints:!0,selectedPaths:e.selectedCoordPaths}).forEach(o)):(t.properties.active=z.INACTIVE,o(t)),this.fireActionable(e)};U.onTrash=function(e){e.selectedCoordPaths.sort((t,o)=>o.localeCompare(t,"en",{numeric:!0})).forEach(t=>e.feature.removeCoordinate(t)),this.fireUpdate(),e.selectedCoordPaths=[],this.clearSelectedCoordinates(),this.fireActionable(e),e.feature.isValid()===!1&&(this.deleteFeature([e.featureId]),this.changeMode(L.SIMPLE_SELECT,{}))};U.onMouseMove=function(e,t){const o=Fe(t),r=Co(t),n=So(t),i=e.selectedCoordPaths.length===0;return o&&i?this.updateUIClasses({mouse:G.MOVE}):r&&!i?this.updateUIClasses({mouse:G.MOVE}):this.updateUIClasses({mouse:G.NONE}),(r||o||n)&&e.dragMoving&&this.fireUpdate(),this.stopDragging(e),!0};U.onMouseOut=function(e){return e.dragMoving&&this.fireUpdate(),!0};U.onTouchStart=U.onMouseDown=function(e,t){if(Co(t))return this.onVertex(e,t);if(Fe(t))return this.onFeature(e,t);if(So(t))return this.onMidpoint(e,t)};U.onDrag=function(e,t){if(e.canDragMove!==!0)return;e.dragMoving=!0,t.originalEvent.stopPropagation();const o={lng:t.lngLat.lng-e.dragMoveLocation.lng,lat:t.lngLat.lat-e.dragMoveLocation.lat};e.selectedCoordPaths.length>0?this.dragVertex(e,t,o):this.dragFeature(e,t,o),e.dragMoveLocation=t.lngLat};U.onClick=function(e,t){if(pt(t))return this.clickNoTarget(e,t);if(Fe(t))return this.clickActiveFeature(e,t);if(Ot(t))return this.clickInactive(e,t);this.stopDragging(e)};U.onTap=function(e,t){if(pt(t))return this.clickNoTarget(e,t);if(Fe(t))return this.clickActiveFeature(e,t);if(Ot(t))return this.clickInactive(e,t)};U.onTouchEnd=U.onMouseUp=function(e){e.dragMoving&&this.fireUpdate(),this.stopDragging(e)};const Se={};Se.onSetup=function(){const e=this.newFeature({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:[]}});return this.addFeature(e),this.clearSelectedFeatures(),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.POINT),this.setActionableState({trash:!0}),{point:e}};Se.stopDrawingAndRemove=function(e){this.deleteFeature([e.point.id],{silent:!0}),this.changeMode(L.SIMPLE_SELECT)};Se.onTap=Se.onClick=function(e,t){this.updateUIClasses({mouse:G.MOVE}),e.point.updateCoordinate("",t.lngLat.lng,t.lngLat.lat),this.fire(K.CREATE,{features:[e.point.toGeoJSON()]}),this.changeMode(L.SIMPLE_SELECT,{featureIds:[e.point.id]})};Se.onStop=function(e){this.activateUIButton(),e.point.getCoordinate().length||this.deleteFeature([e.point.id],{silent:!0})};Se.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.point.id;if(t.properties.active=r?z.ACTIVE:z.INACTIVE,!r)return o(t)};Se.onTrash=Se.stopDrawingAndRemove;Se.onKeyUp=function(e,t){if(ft(t)||ht(t))return this.stopDrawingAndRemove(e,t)};function lt(e,t){return e.lngLat?e.lngLat.lng===t[0]&&e.lngLat.lat===t[1]:!1}const Ee={};Ee.onSetup=function(){const e=this.newFeature({type:C.FEATURE,properties:{},geometry:{type:C.POLYGON,coordinates:[[]]}});return this.addFeature(e),this.clearSelectedFeatures(),me.disable(this),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.POLYGON),this.setActionableState({trash:!0}),{polygon:e,currentVertexPosition:0}};Ee.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&lt(t,e.polygon.coordinates[0][e.currentVertexPosition-1]))return this.changeMode(L.SIMPLE_SELECT,{featureIds:[e.polygon.id]});this.updateUIClasses({mouse:G.ADD}),e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),e.currentVertexPosition++,e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat)};Ee.clickOnVertex=function(e){return this.changeMode(L.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};Ee.onMouseMove=function(e,t){e.polygon.updateCoordinate(`0.${e.currentVertexPosition}`,t.lngLat.lng,t.lngLat.lat),Ke(t)&&this.updateUIClasses({mouse:G.POINTER})};Ee.onTap=Ee.onClick=function(e,t){return Ke(t)?this.clickOnVertex(e,t):this.clickAnywhere(e,t)};Ee.onKeyUp=function(e,t){ft(t)?(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(L.SIMPLE_SELECT)):ht(t)&&this.changeMode(L.SIMPLE_SELECT,{featureIds:[e.polygon.id]})};Ee.onStop=function(e){this.updateUIClasses({mouse:G.NONE}),me.enable(this),this.activateUIButton(),this.getFeature(e.polygon.id)!==void 0&&(e.polygon.removeCoordinate(`0.${e.currentVertexPosition}`),e.polygon.isValid()?this.fire(K.CREATE,{features:[e.polygon.toGeoJSON()]}):(this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(L.SIMPLE_SELECT,{},{silent:!0})))};Ee.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.polygon.id;if(t.properties.active=r?z.ACTIVE:z.INACTIVE,!r)return o(t);if(t.geometry.coordinates.length===0)return;const n=t.geometry.coordinates[0].length;if(!(n<3)){if(t.properties.meta=W.FEATURE,o(je(e.polygon.id,t.geometry.coordinates[0][0],"0.0",!1)),n>3){const i=t.geometry.coordinates[0].length-3;o(je(e.polygon.id,t.geometry.coordinates[0][i],`0.${i}`,!1))}if(n<=4){const i=[[t.geometry.coordinates[0][0][0],t.geometry.coordinates[0][0][1]],[t.geometry.coordinates[0][1][0],t.geometry.coordinates[0][1][1]]];if(o({type:C.FEATURE,properties:t.properties,geometry:{coordinates:i,type:C.LINE_STRING}}),n===3)return}return o(t)}};Ee.onTrash=function(e){this.deleteFeature([e.polygon.id],{silent:!0}),this.changeMode(L.SIMPLE_SELECT)};const ve={};ve.onSetup=function(e){e=e||{};const t=e.featureId;let o,r,n="forward";if(t){if(o=this.getFeature(t),!o)throw new Error("Could not find a feature with the provided featureId");let i=e.from;if(i&&i.type==="Feature"&&i.geometry&&i.geometry.type==="Point"&&(i=i.geometry),i&&i.type==="Point"&&i.coordinates&&i.coordinates.length===2&&(i=i.coordinates),!i||!Array.isArray(i))throw new Error("Please use the `from` property to indicate which point to continue the line from");const s=o.coordinates.length-1;if(o.coordinates[s][0]===i[0]&&o.coordinates[s][1]===i[1])r=s+1,o.addCoordinate(r,...o.coordinates[s]);else if(o.coordinates[0][0]===i[0]&&o.coordinates[0][1]===i[1])n="backwards",r=0,o.addCoordinate(r,...o.coordinates[0]);else throw new Error("`from` should match the point at either the start or the end of the provided LineString")}else o=this.newFeature({type:C.FEATURE,properties:{},geometry:{type:C.LINE_STRING,coordinates:[]}}),r=0,this.addFeature(o);return this.clearSelectedFeatures(),me.disable(this),this.updateUIClasses({mouse:G.ADD}),this.activateUIButton(re.LINE),this.setActionableState({trash:!0}),{line:o,currentVertexPosition:r,direction:n}};ve.clickAnywhere=function(e,t){if(e.currentVertexPosition>0&&lt(t,e.line.coordinates[e.currentVertexPosition-1])||e.direction==="backwards"&&lt(t,e.line.coordinates[e.currentVertexPosition+1]))return this.changeMode(L.SIMPLE_SELECT,{featureIds:[e.line.id]});this.updateUIClasses({mouse:G.ADD}),e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),e.direction==="forward"?(e.currentVertexPosition++,e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat)):e.line.addCoordinate(0,t.lngLat.lng,t.lngLat.lat)};ve.clickOnVertex=function(e){return this.changeMode(L.SIMPLE_SELECT,{featureIds:[e.line.id]})};ve.onMouseMove=function(e,t){e.line.updateCoordinate(e.currentVertexPosition,t.lngLat.lng,t.lngLat.lat),Ke(t)&&this.updateUIClasses({mouse:G.POINTER})};ve.onTap=ve.onClick=function(e,t){if(Ke(t))return this.clickOnVertex(e,t);this.clickAnywhere(e,t)};ve.onKeyUp=function(e,t){ht(t)?this.changeMode(L.SIMPLE_SELECT,{featureIds:[e.line.id]}):ft(t)&&(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(L.SIMPLE_SELECT))};ve.onStop=function(e){me.enable(this),this.activateUIButton(),this.getFeature(e.line.id)!==void 0&&(e.line.removeCoordinate(`${e.currentVertexPosition}`),e.line.isValid()?this.fire(K.CREATE,{features:[e.line.toGeoJSON()]}):(this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(L.SIMPLE_SELECT,{},{silent:!0})))};ve.onTrash=function(e){this.deleteFeature([e.line.id],{silent:!0}),this.changeMode(L.SIMPLE_SELECT)};ve.toDisplayFeatures=function(e,t,o){const r=t.properties.id===e.line.id;if(t.properties.active=r?z.ACTIVE:z.INACTIVE,!r)return o(t);t.geometry.coordinates.length<2||(t.properties.meta=W.FEATURE,o(je(e.line.id,t.geometry.coordinates[e.direction==="forward"?t.geometry.coordinates.length-2:1],`${e.direction==="forward"?t.geometry.coordinates.length-2:1}`,!1)),o(t))};const To={simple_select:k,direct_select:U,draw_point:Se,draw_polygon:Ee,draw_line_string:ve},tn={defaultMode:L.SIMPLE_SELECT,keybindings:!0,touchEnabled:!0,clickBuffer:2,touchBuffer:25,boxSelect:!0,displayControlsDefault:!0,styles:mo,modes:To,controls:{},userProperties:!1,suppressAPIEvents:!0},on={point:!0,line_string:!0,polygon:!0,trash:!0,combine_features:!0,uncombine_features:!0},rn={point:!1,line_string:!1,polygon:!1,trash:!1,combine_features:!1,uncombine_features:!1};function Kt(e,t){return e.map(o=>o.source?o:Object.assign({},o,{id:`${o.id}.${t}`,source:t==="hot"?pe.HOT:pe.COLD}))}function nn(e={}){let t=Object.assign({},e);return e.controls||(t.controls={}),e.displayControlsDefault===!1?t.controls=Object.assign({},rn,e.controls):t.controls=Object.assign({},on,e.controls),t=Object.assign({},tn,t),t.styles=Kt(t.styles,"cold").concat(Kt(t.styles,"hot")),t}var vt,Qt;function sn(){if(Qt)return vt;Qt=1,vt=t;var e={Point:"geometry",MultiPoint:"geometry",LineString:"geometry",MultiLineString:"geometry",Polygon:"geometry",MultiPolygon:"geometry",GeometryCollection:"geometry",Feature:"feature",FeatureCollection:"featurecollection"};function t(o){if(!o||!o.type)return null;var r=e[o.type];if(!r)return null;if(r==="geometry")return{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:o}]};if(r==="feature")return{type:"FeatureCollection",features:[o]};if(r==="featurecollection")return o}return vt}var an=sn();const ln=ro(an);function _o(e,t){return e.length!==t.length?!1:JSON.stringify(e.map(o=>o).sort())===JSON.stringify(t.map(o=>o).sort())}const cn={Polygon:ce,LineString:Te,Point:xe,MultiPolygon:Z,MultiLineString:Z,MultiPoint:Z};function un(e,t){t.modes=L;const o=e.options.suppressAPIEvents!==void 0?!!e.options.suppressAPIEvents:!0;return t.getFeatureIdsAt=function(r){return Ve.click({point:r},null,e).map(i=>i.properties.id)},t.getSelectedIds=function(){return e.store.getSelectedIds()},t.getSelected=function(){return{type:C.FEATURE_COLLECTION,features:e.store.getSelectedIds().map(r=>e.store.get(r)).map(r=>r.toGeoJSON())}},t.getSelectedPoints=function(){return{type:C.FEATURE_COLLECTION,features:e.store.getSelectedCoordinates().map(r=>({type:C.FEATURE,properties:{},geometry:{type:C.POINT,coordinates:r.coordinates}}))}},t.set=function(r){if(r.type===void 0||r.type!==C.FEATURE_COLLECTION||!Array.isArray(r.features))throw new Error("Invalid FeatureCollection");const n=e.store.createRenderBatch();let i=e.store.getAllIds().slice();const s=t.add(r),c=new he(s);return i=i.filter(a=>!c.has(a)),i.length&&t.delete(i),n(),s},t.add=function(r){const i=JSON.parse(JSON.stringify(ln(r))).features.map(s=>{if(s.id=s.id||Pt(),s.geometry===null)throw new Error("Invalid geometry: null");if(e.store.get(s.id)===void 0||e.store.get(s.id).type!==s.geometry.type){const c=cn[s.geometry.type];if(c===void 0)throw new Error(`Invalid geometry type: ${s.geometry.type}.`);const a=new c(e,s);e.store.add(a,{silent:o})}else{const c=e.store.get(s.id),a=c.properties;c.properties=s.properties,kt(a,s.properties)||e.store.featureChanged(c.id,{silent:o}),kt(c.getCoordinates(),s.geometry.coordinates)||c.incomingCoords(s.geometry.coordinates)}return s.id});return e.store.render(),i},t.get=function(r){const n=e.store.get(r);if(n)return n.toGeoJSON()},t.getAll=function(){return{type:C.FEATURE_COLLECTION,features:e.store.getAll().map(r=>r.toGeoJSON())}},t.delete=function(r){return e.store.delete(r,{silent:o}),t.getMode()===L.DIRECT_SELECT&&!e.store.getSelectedIds().length?e.events.changeMode(L.SIMPLE_SELECT,void 0,{silent:o}):e.store.render(),t},t.deleteAll=function(){return e.store.delete(e.store.getAllIds(),{silent:o}),t.getMode()===L.DIRECT_SELECT?e.events.changeMode(L.SIMPLE_SELECT,void 0,{silent:o}):e.store.render(),t},t.changeMode=function(r,n={}){return r===L.SIMPLE_SELECT&&t.getMode()===L.SIMPLE_SELECT?(_o(n.featureIds||[],e.store.getSelectedIds())||(e.store.setSelected(n.featureIds,{silent:o}),e.store.render()),t):(r===L.DIRECT_SELECT&&t.getMode()===L.DIRECT_SELECT&&n.featureId===e.store.getSelectedIds()[0]||e.events.changeMode(r,n,{silent:o}),t)},t.getMode=function(){return e.events.getMode()},t.trash=function(){return e.events.trash({silent:o}),t},t.combineFeatures=function(){return e.events.combineFeatures({silent:o}),t},t.uncombineFeatures=function(){return e.events.uncombineFeatures({silent:o}),t},t.setFeatureProperty=function(r,n,i){return e.store.setFeatureProperty(r,n,i,{silent:o}),t},t}const dn=Object.freeze(Object.defineProperty({__proto__:null,CommonSelectors:Qr,ModeHandler:Tt,StringSet:he,constrainFeatureMovement:Nt,createMidPoint:vo,createSupplementaryPoints:gt,createVertex:je,doubleClickZoom:me,euclideanDistance:wt,featuresAt:Ve,getFeatureAtAndSetCursors:nt,isClick:It,isEventAtCoordinates:lt,isTap:Mt,mapEventToBoundingBox:fo,moveFeatures:Ft,sortFeatures:po,stringSetsAreEqual:_o,theme:mo,toDenseArray:Ze},Symbol.toStringTag,{value:"Module"})),pn=function(e,t){e=nn(e);const o={options:e};t=un(o,t),o.api=t;const r=Zr(o);return t.onAdd=r.onAdd,t.onRemove=r.onRemove,t.types=re,t.options=e,t};function yt(e){pn(e,this)}yt.modes=To;yt.constants=uo;yt.lib=dn;const fn=({commentInput:e,setCommentInput:t,addCommentLayer:o,setCommentFeatures:r,commentFeatures:n,handleDeleteComment:i,workDay:s,drawRef:c})=>{var E,l,d,h,_;const a=Ne(b=>b.auth.user),u=Ne(b=>b.auth.token),y=async(b,D)=>{try{const V=`comment-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,$={...e.feature},M={...$,type:"Feature",geometry:D||$.geometry,properties:{...$.properties,id:V,workDayId:s.id,comment:b,type:"comment",createdAt:new Date().toISOString(),createdBy:a}},R={geometry:M.geometry,properties:M.properties,featureType:M.properties.type,workDayId:s.id};(await le.post("/mapFeature",R,{headers:{Authorization:u}})).status===201&&ge("Successfully Added Comment",{variant:"success"}),r(q=>[...q,M]),console.log(M,"<=== yeets"),c.add(M),t({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}})}catch(V){console.error(V)}};return g.jsx(Vo,{in:e.open,children:g.jsxs(to,{elevation:4,sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,p:1.5,width:250,backgroundColor:"#ffffff",border:"1px solid #e0e0e0",borderRadius:1.5},children:[g.jsxs(fe,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1},children:[g.jsx(Pe,{variant:"subtitle2",sx:{fontSize:"0.875rem"},children:e.isEdit?"Edit Comment":"Add Comment"}),g.jsx(eo,{size:"small",onClick:()=>t({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),sx:{p:.5},children:g.jsx(hr,{size:14})})]}),g.jsx(no,{autoFocus:!0,size:"small",fullWidth:!0,variant:"outlined",multiline:!0,rows:2,placeholder:"Enter comment...",value:((l=(E=e.feature)==null?void 0:E.properties)==null?void 0:l.comment)||"",onChange:b=>{if(e.feature){const D={...e.feature,properties:{...e.feature.properties,comment:b.target.value}};t({...e,feature:D})}},sx:{mb:1}}),g.jsxs(fe,{sx:{display:"flex",gap:1,justifyContent:"flex-end"},children:[e.isEdit&&e.feature&&g.jsx(Ge,{size:"small",variant:"contained",color:"error",startIcon:g.jsx(fr,{size:14}),onClick:()=>{i(e.feature)},sx:{fontSize:"0.75rem",py:.5},children:"Delete"}),g.jsx(Ge,{size:"small",variant:"contained",onClick:()=>{var b,D;return y(((D=(b=e.feature)==null?void 0:b.properties)==null?void 0:D.comment)||"")},disabled:!((_=(h=(d=e.feature)==null?void 0:d.properties)==null?void 0:h.comment)!=null&&_.trim()),sx:{fontSize:"0.75rem",py:.5},children:e.isEdit?"Update":"Add"})]})]})})};class hn{constructor(t){if(typeof t=="function")this.onChange=t,this.initialColor="#3bb2d0",this.initialOpacity=.2;else{const{onChange:o,initialColor:r="#3bb2d0",initialOpacity:n=.2}=t||{};this.onChange=o,this.initialColor=r,this.initialOpacity=n}this._map=null,this._container=null,this._isOpen=!1,this._color=this.initialColor,this._opacity=this.initialOpacity}onAdd(t){this._map=t;const o=document.createElement("div");o.className="mapboxgl-ctrl mapboxgl-ctrl-group",o.style.position="relative";const r=document.createElement("button");r.type="button",r.className="mapboxgl-ctrl-icon",r.setAttribute("aria-label","Color & Opacity"),r.style.width="30px",r.style.height="30px",r.style.display="inline-flex",r.style.alignItems="center",r.style.justifyContent="center";const n=document.createElement("span");n.style.width="14px",n.style.height="14px",n.style.borderRadius="50%",n.style.background=this._color,n.style.opacity=this._opacity,n.style.boxShadow="0 0 0 1px rgba(0,0,0,0.2) inset",r.appendChild(n),this._dot=n;const i=document.createElement("div");i.style.position="absolute",i.style.top="0",i.style.right="100%",i.style.marginRight="8px",i.style.display="none",i.style.flexDirection="column",i.style.gap="8px",i.style.padding="8px",i.style.background="#fff",i.style.border="1px solid rgba(0,0,0,0.15)",i.style.borderRadius="8px",i.style.boxShadow="0 2px 8px rgba(0,0,0,0.12)",i.style.zIndex="2",i.style.width="140px";const s=document.createElement("input");s.type="color",s.value=this._color,s.style.width="100%",s.addEventListener("input",y=>{this._color=y.target.value,this._update()});const c=document.createElement("div");c.style.display="flex",c.style.flexDirection="column",c.style.fontSize="12px",c.style.gap="4px";const a=document.createElement("span");a.textContent=`Opacity: ${Math.round(this._opacity*100)}%`;const u=document.createElement("input");return u.type="range",u.min="0.1",u.max="1",u.step="0.05",u.value=this._opacity,u.addEventListener("input",y=>{this._opacity=parseFloat(y.target.value),a.textContent=`Opacity: ${Math.round(this._opacity*100)}%`,this._update()}),c.appendChild(a),c.appendChild(u),i.appendChild(s),i.appendChild(c),r.addEventListener("click",y=>{y.stopPropagation(),this._isOpen=!this._isOpen,i.style.display=this._isOpen?"flex":"none"}),document.addEventListener("click",y=>{o.contains(y.target)||(this._isOpen=!1,i.style.display="none")}),o.appendChild(r),o.appendChild(i),this._container=o,o}onRemove(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._map=null}_update(){this._dot&&(this._dot.style.background=this._color,this._dot.style.opacity=this._opacity),typeof this.onChange=="function"&&this.onChange(this._color,this._opacity)}}ae.accessToken="pk.eyJ1IjoiaGlyYWtyYWoiLCJhIjoiY21icXd5eHRnMDNtaTJxczcxd2RmbTZwOCJ9.P6kpsuLMDdeK2DIMJZMrmw";const Be=({label:e,createdBy:t,createdAt:o})=>`
    <div style="
      font-family: 'Arial', sans-serif;
      background-color: #fff;
      border: 1px solid #B3D3F0; /* secondary200 */
      border-radius: 8px;
      overflow: hidden;
      width: 200px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    ">
      <!-- Header -->
      <div style="
        background-color: #2563EB; /* primaryMain */
        color: #fff;
        font-weight: 600;
        font-size: 13px;
        padding: 8px;
        text-align: center;
        display: flex;
        justify-content: center;
        align-items: center;
      ">
        ${e}
      </div>
      
      <!-- Body -->
      <div style="
        padding: 6px 8px;
        background-color: #D6E6F5; /* secondaryLight */
        display: flex;
        justify-content: space-between;
        font-size: 8px;
        color: #1F3F66; /* secondary800 */
      ">
        <span>${t}</span>
        <span style="color: #666;">
          ${new Date(o).toLocaleDateString()} ${new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}
        </span>
      </div>
    </div>
  `,$e=(e,t)=>{let o,r;return e.createdBy?o=e.createdBy:o=JSON.parse(e.user_createdBy),e.createdAt?r=e.createdAt:r=e.user_createdAt,{createdBy:`${o.firstName} ${o.lastName}`,createdAt:new Date(r),label:t}};function Sn(){const e=F.useRef(null),t=F.useRef(null),o=F.useRef(null),r=Ne(f=>f.auth.user),[n,i]=F.useState(!1),[s,c]=F.useState(""),[a,u]=F.useState({orthomosaic:!0,annotations:!0,showComments:!0,showPolygons:!0,showLineString:!0,builtinOverlay:!1,shapeOverlay:!1}),[y,E]=F.useState(!1),[l,d]=F.useState([]),[h,_]=F.useState([]),[b,D]=F.useState(!1),[V,$]=F.useState({}),[M,R]=F.useState(null),[ne,q]=F.useState(!1),[ee,Y]=F.useState([]),[_e,ze]=F.useState("#2563EB"),[Je,Ae]=F.useState(.5),[be,we]=F.useState({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),[J,Ie]=F.useState([]),{id:Me,name:bo}=Ne(f=>f.project),Io=[{title:"Projects",to:"/project",icon:zo},{title:bo,icon:Jo,to:`/project/${Me}/View`},{title:"Exterior(Map View)",icon:Ho}],Ce=Ne(f=>f.auth.token);F.useEffect(()=>{if(!Me)return;(async()=>{var m,T,P,O,X,A,te;try{D(!0),R(null);const v=((T=(m=(await le.get("/work-day",{params:{projectId:Me,status:"completed"},headers:{Authorization:Ce}})).data)==null?void 0:m.data)==null?void 0:T.results)||[];if(d(v.map(S=>S.name)),$(v[0]),_(v),console.log(v,"<==== completed work days"),v.length>0){c(v[0].name);const S=await le.get("/mapFeature",{params:{workDayId:v[0].id},headers:{Authorization:Ce}});((O=(P=S.data)==null?void 0:P.data)==null?void 0:O.length)!==0&&Y((X=S.data)==null?void 0:X.data)}else R("No completed work days found for this project.")}catch(x){R(((te=(A=x.response)==null?void 0:A.data)==null?void 0:te.message)||"Failed to load project data. Please try again."),d([]),_([])}finally{D(!1)}})()},[Me,Ce]),F.useEffect(()=>{if(!e.current||t.current)return;if(!ae.accessToken){R("Mapbox API key is not configured.");return}const f=new ae.Map({container:e.current,style:"mapbox://styles/mapbox/satellite-streets-v12",center:[72.5714,23.0225],zoom:15,attributionControl:!1,preserveDrawingBuffer:!0,minZoom:0,maxZoom:23}),m=_e,T=Je;var P=_e,O=T;const X=(A,te)=>{const x=["coalesce",["get","user_color"],["get","color_hex"],["get","color"],A],v=["coalesce",["get","user_opacity"],["get","opacity"],te];return[{id:"gl-draw-polygon-fill-active",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","true"]],paint:{"fill-color":x,"fill-outline-color":x,"fill-opacity":v}},{id:"gl-draw-polygon-stroke-active",type:"line",filter:["all",["==","$type","Polygon"],["==","active","true"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":x,"line-width":1}},{id:"gl-draw-line-active",type:"line",filter:["all",["==","$type","LineString"],["==","active","true"]],paint:{"line-color":x,"line-width":1}},{id:"gl-draw-polygon-fill-inactive",type:"fill",filter:["all",["==","$type","Polygon"],["==","active","false"]],paint:{"fill-color":x,"fill-outline-color":x,"fill-opacity":v}},{id:"gl-draw-polygon-stroke-inactive",type:"line",filter:["all",["==","$type","Polygon"],["==","active","false"]],layout:{"line-cap":"round","line-join":"round"},paint:{"line-color":x,"line-width":1}},{id:"gl-draw-line-inactive",type:"line",filter:["all",["==","$type","LineString"],["==","active","false"]],paint:{"line-color":x,"line-width":2}},{id:"gl-draw-point-inactive",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","false"]],paint:{"circle-radius":4,"circle-color":x}},{id:"gl-draw-point-comment",type:"circle",filter:["all",["==","active","false"],["==","meta","feature"],["==","user_type","comment"]],paint:{"circle-radius":4,"circle-color":x,"circle-stroke-color":"#fff","circle-stroke-width":2}},{id:"gl-draw-point-active",type:"circle",filter:["all",["==","$type","Point"],["!=","meta","midpoint"],["==","active","true"]],paint:{"circle-radius":6,"circle-color":x,"circle-stroke-color":x,"circle-stroke-width":2}},{id:"gl-draw-point-comment-active",type:"circle",filter:["all",["==","$type","Point"],["==","active","true"],["==","meta","feature"],["==","user_type","comment"]],paint:{"circle-radius":6,"circle-color":x,"circle-stroke-color":"#fff","circle-stroke-width":3}}]};return f.on("load",()=>{t.current=f,i(!0),R(null),f.addControl(new ae.FullscreenControl,"top-right"),f.addControl(new ae.NavigationControl({visualizePitch:!0}),"top-right");const A=new ae.ScaleControl({unit:"metric",maxWidth:100});f.addControl(A,"bottom-left"),setTimeout(()=>{const v=f.getContainer().querySelector(".mapboxgl-ctrl-scale");v&&(v.style.display="block",v.style.visibility="visible",v.style.opacity="1")},1e3);const te=new hn((v,S)=>{console.log(v,S,"<==== picked"),P=v||m,O=S||T,console.log(P,"<==== current"),ze(v),Ae(S)});f.addControl(te,"top-right");const x=new yt({userProperties:!0,displayControlsDefault:!1,controls:{polygon:!0,line_string:!0,point:!0,trash:!0},styles:X(P,O)});f.addControl(x,"top-right"),o.current=x,f.on("draw.create",async v=>{var H;const S=V.id;v.features.forEach(w=>{x.setFeatureProperty(w.id,"color",P)});const p=(H=v.features)==null?void 0:H[0];if(p){if(t.current.__activePopup&&t.current.__activePopup.remove(),p.geometry.type==="LineString"){if(!p||p.geometry.type!=="LineString")return;const ue=`${et(p,{units:"meters"}).toFixed(2)} m`,de=`polygon-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;p.properties.createdBy=r,p.properties.createdAt=new Date,p.createdAt=new Date().toISOString,p.properties.comment=ue,p.properties.color=P,p.properties.id=de;try{const N={featureType:"line",geometry:p.geometry,properties:p.properties,workDayId:S};(await le.post("/mapFeature",N,{headers:{Authorization:Ce}})).status===201&&ge("Line created ",{variant:"success"}),x.add(p)}catch(N){console.error(N)}ge(ue,{variant:"success"})}if(p.geometry.type==="Polygon"){const w=rt.geometry(p.geometry).toFixed(2),ue=`${w} m²`,de=`polygon-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,N=Jt(p).geometry.coordinates;x.setFeatureProperty(p.id,"id",de),p.properties.color=P,p.properties.createdAt=new Date,p.properties.createdBy=r,p.properties.areaM2=w,p.properties.id=de,p.properties.opacity=O;try{const j={featureType:"polygon",geometry:p.geometry,properties:p.properties,workDayId:S};(await le.post("/mapFeature",j,{headers:{Authorization:Ce}})).status===201&&ge("Polygon created ",{variant:"success"}),setTimeout(()=>{const Le=new ae.Popup({closeButton:!0,offset:15}).setLngLat(N).setHTML(Be($e(p.properties,ue))).addTo(t.current);t.current.__activePopup=Le,x.add(p)},0)}catch(j){console.error(j)}}if(p.geometry.type==="Point"){const w=f.getCanvas().getBoundingClientRect();we({open:!0,feature:{feature:p,geometry:p.geometry,color:P,properties:{color:P}},isEdit:!1,position:{x:w.width/2,y:w.height/2}})}}}),f.on("draw.update",async v=>{var H,w,ue,de;t.current.__activePopup&&t.current.__activePopup.remove(),console.log("updating something");const S=V.id,p=(H=v.features)==null?void 0:H[0];if(p){if(v.features.forEach(N=>{x.setFeatureProperty(N.id,"color",P)}),((w=p==null?void 0:p.geometry)==null?void 0:w.type)==="Polygon"){const N=rt.geometry(p.geometry),j=(N/1e6).toFixed(2),ie=N.toFixed(2);t.current.__activePopup=popup,p.properties.color=P,p.properties.areaKm2=j,p.properties.areaM2=ie,p.properties.opacity=O;try{const Le={featureType:"polygon",geometry:p.geometry,properties:p.properties,workDayId:S};(await le.patch(`/mapFeature/propertyId/${p==null?void 0:p.properties.id}`,Le,{headers:{Authorization:Ce}})).status===200&&ge("Polygon Updated ",{variant:"success"})}catch(Le){console.error(Le)}}if(((ue=p==null?void 0:p.geometry)==null?void 0:ue.type)==="LineString")try{const N=et(p,{units:"kilometers"}),j=(N*1e3).toFixed(2);p.properties.color=P,p.properties.lengthKm=N.toFixed(2),p.properties.lengthM=j;const ie={featureType:"line",geometry:p.geometry,properties:p.properties,workDayId:S};(await le.patch(`/mapFeature/propertyId/${p==null?void 0:p.properties.id}`,ie,{headers:{Authorization:Ce}})).status===200&&ge("Line Updated",{variant:"success"})}catch(N){console.error("Error updating line:",N)}if(((de=p==null?void 0:p.geometry)==null?void 0:de.type)==="Point")try{const[N,j]=p.geometry.coordinates;p.properties.color=P,p.properties.coordinates=`${j.toFixed(6)}, ${N.toFixed(6)}`;const ie={featureType:"comment",geometry:p.geometry,properties:p.properties,workDayId:S};(await le.patch(`/mapFeature/propertyId/${p==null?void 0:p.properties.id}`,ie,{headers:{Authorization:Ce}})).status===200&&ge("Point Updated",{variant:"success"})}catch(N){console.error("Error updating point:",N)}}}),f.on("draw.delete",async v=>{Ie(p=>p.filter(H=>H.properties.id!==S.properties.id)),console.log("on delete"),t.current.__activePopup&&t.current.__activePopup.remove();const S=v.features[0];console.log("Deleted features:",v.features);try{(await le.delete(`/mapfeature/propertyId/${S.properties.id}`)).status===200&&ge("Successfully removed feature",{variant:"success"})}catch(p){console.error("error removing feature",p)}}),f.on("click",v=>{var ue,de;console.log("on click"),t.current.__activePopup&&t.current.__activePopup.remove();const S=["gl-draw-line-inactive","gl-draw-line-inactive.hot","gl-draw-line-active","gl-draw-line-active.hot","gl-draw-line-static","gl-draw-point-inactive","gl-draw-point-inactive.hot","gl-draw-point-active","gl-draw-point-active.hot","gl-draw-point-static","gl-draw-polygon-fill-inactive","gl-draw-polygon-fill-inactive.cold","gl-draw-polygon-fill-inactive.hot","gl-draw-polygon-fill-active","gl-draw-polygon-fill-static","gl-draw-polygon-stroke-inactive","gl-draw-polygon-stroke-inactive.cold","gl-draw-polygon-stroke-active","gl-draw-polygon-stroke-static"],p=f.getStyle().layers.map(N=>N.id).filter(N=>S.includes(N)),H=f.queryRenderedFeatures(v.point,{layers:p});if(!H.length)return;const w=H[0];if(w.geometry.type==="Point"&&w.properties.user_type==="comment"){console.log(w,"<==== yeeter");const N=w.geometry.coordinates.slice(),j=((ue=w.properties)==null?void 0:ue.comment)||((de=w.properties)==null?void 0:de.user_comment)||"",ie=new ae.Popup().setLngLat(N).setHTML(Be($e(w.properties,j))).addTo(f);t.current.__activePopup=ie}if(w.geometry.type==="Polygon"){console.log(w,"<=== featuer agae ");const j=`${rt.geometry(w.geometry).toFixed(2)} m²`,ie=Jt(w).geometry.coordinates;new ae.Popup().setLngLat(ie).setHTML(Be($e(w.properties,j))).addTo(f)}if(w.geometry.type==="LineString"){console.log(w,"<==== feature line string selection");const N=et(w,{units:"kilometers"}),j=zt(w,N/2,{units:"kilometers"}).geometry.coordinates,ie=N*1e3,Le=`${ie.toFixed(2)} m`;if(j&&!j.some(Number.isNaN)){const Dt=new ae.Popup().setLngLat(j).setHTML(Be($e(w.properties,Le))).addTo(f);t.current.__activePopup=Dt}ge(`Length: ${ie.toFixed(2)} m`,{variant:"success"})}}),f.on("draw.selectionchange",v=>{if(v.features.length>0){const S=v.features[0];if(S.geometry.type==="LineString"&&S.properties.mode!=="draw_polygon"){console.log(S,"<==== feature line string selection");const p=et(S,{units:"kilometers"}),H=zt(S,p/2,{units:"kilometers"}).geometry.coordinates,w=p*1e3,ue=`${w.toFixed(2)} m`;if(H&&!H.some(Number.isNaN)){const de=new ae.Popup().setLngLat(H).setHTML(Be($e(S.properties,ue))).addTo(f);t.current.__activePopup=de}ge(`Length: ${w.toFixed(2)} m`,{variant:"success"})}if(S.geometry.type==="Point"){console.log(S,"<============wew");const p=new ae.Popup().setLngLat(S.geometry.coordinates).setHTML(Be($e(S.properties,S.properties.comment))).addTo(f);t.current.__activePopup=p}}})}),f.on("sourcedata",A=>{var te;(te=A.sourceId)!=null&&te.includes("ortho-")&&A.isSourceLoaded&&(console.log("on source data remove"),q(!1))}),()=>{f&&f.remove&&f.remove(),t.current=null,i(!1)}},[V]),F.useEffect(()=>{if(!s||!t.current||!n||!h.length)return;(async()=>{const m=h.find(T=>T.name===s);if(m){o.current.deleteAll();try{const{data:T}=await le.get("/mapFeature",{params:{workDayId:m.id},headers:{Authorization:Ce}}),O={type:"FeatureCollection",features:((T==null?void 0:T.data)||[]).map(({geometry:X,properties:A,createdBy:te,createdAt:x})=>({type:"Feature",geometry:X,properties:{...A,createdBy:te,createdAt:x,comment:(A==null?void 0:A.comment)||"",color:(A==null?void 0:A.color)||(A==null?void 0:A.color_hex)||_e,message:(A==null?void 0:A.message)||"No message set"}}))};console.log(O.features,"<======== yeeeter"),Ie(O.features)}catch(T){console.error("Error loading map features:",T)}}})()},[s,n,h]),F.useEffect(()=>{if(!s||!V.id)return;Mo(V.id);const f=h.find(v=>v.name===s);if(!t.current||!n||!f)return;const m=t.current,T=`overlay-${f.id}`,P=`shape-overlay-${f.id}`,O={fill:`overlay-fill-${f.id}`,line:`overlay-line-${f.id}`,point:`overlay-point-${f.id}`,text:`overlay-text-${f.id}`},X={fill:`shapeOverlay-fill-${f.id}`,line:`shapeOverlay-line-${f.id}`,point:`shapeOverlay-point-${f.id}`};Object.values(O).forEach(v=>{m.getLayer(v)&&m.removeLayer(v)}),Object.values(X).forEach(v=>{m.getLayer(v)&&m.removeLayer(v)}),m.getSource(T)&&m.removeSource(T),m.getSource(P)&&m.removeSource(P),o.current&&o.current.deleteAll();const A=J.filter(v=>{var S;return(S=v.properties)==null?void 0:S.overlay}),te=J.filter(v=>{var S;return!((S=v.properties)!=null&&S.overlay)}),x=J.filter(v=>{var S;return(S=v.properties)==null?void 0:S.shapefile});if(console.log(x,"<============ shape overlay features"),console.log(A,"<============ overlay features"),o.current&&te.length){const v=te.filter(S=>{var H;const p=(H=S.geometry)==null?void 0:H.type;return p==="Polygon"&&a.showPolygons||p==="LineString"&&a.showLineString||p==="Point"&&a.showComments});v.length&&a.annotations&&(o.current.add({type:"FeatureCollection",features:v}),o.current.changeMode("simple_select"))}if(a.builtinOverlay&&A.length&&(m.addSource(T,{type:"geojson",data:{type:"FeatureCollection",features:A}}),a.showPolygons&&m.addLayer({id:O.fill,type:"fill",source:T,filter:["==",["geometry-type"],"Polygon"],paint:{"fill-color":["coalesce",["get","color_hex"],"#2563EB"],"fill-opacity":.3}}),a.showLineString&&m.addLayer({id:O.line,type:"line",source:T,filter:["==",["geometry-type"],"LineString"],paint:{"line-color":["coalesce",["get","color_hex"],"#2563EB"],"line-width":1,"line-join":"round","line-cap":"round"}}),a.showComments&&m.addLayer({id:O.point,type:"circle",source:T,filter:["all",["==",["geometry-type"],"Point"],["!=",["get","isText"],!0]],paint:{"circle-radius":3,"circle-color":["coalesce",["get","color_hex"],"#2563EB"]}}),a.showComments&&m.addLayer({id:O.text,type:"symbol",source:T,filter:["all",["==",["geometry-type"],"Point"],["==",["get","isText"],!0]],layout:{"text-field":["get","Text"],"text-size":10,"text-offset":[0,1.2],"text-anchor":"bottom","text-rotation":["get","rotation"],"text-font":["Open Sans Regular","Arial Unicode MS Regular"],"text-allow-overlap":!1},paint:{"text-color":["coalesce",["get","color_hex"],"#000000"],"text-halo-color":"#ffffff","text-halo-width":1}})),a.shapeOverlay&&x.length&&(m.addSource(P,{type:"geojson",data:{type:"FeatureCollection",features:x}}),a.showPolygons&&m.addLayer({id:X.fill,type:"fill",source:P,filter:["any",["==",["geometry-type"],"Polygon"],["==",["geometry-type"],"MultiPolygon"]],paint:{"line-color":["coalesce",["get","color_hex"],["get","color"],"#2563EB"],"fill-opacity":.3}}),a.showLineString&&m.addLayer({id:X.line,type:"line",source:P,filter:["any",["==",["geometry-type"],"LineString"],["==",["geometry-type"],"MultiLineString"]],paint:{"line-color":["coalesce",["get","color_hex"],["get","color"],"#2563EB"],"line-width":1,"line-join":"round","line-cap":"round"}}),a.showComments&&m.addLayer({id:X.point,type:"circle",source:P,filter:["any",["==",["geometry-type"],"Point"],["==",["geometry-type"],"MultiPoint"]],paint:{"circle-radius":3,"line-color":["coalesce",["get","color_hex"],["get","color"],"#2563EB"],"circle-stroke-width":1,"circle-stroke-color":"#ffffff"}})),a.orthomosaic&&f.tileBaseUrl&&(q(!0),Lo(f)),f.tileBounds)wo(f.tileBounds);else if(A.length){const v=new ae.LngLatBounds;A.forEach(S=>{S.geometry.type==="Point"?v.extend(S.geometry.coordinates):S.geometry.type==="LineString"?S.geometry.coordinates.forEach(p=>v.extend(p)):S.geometry.type==="Polygon"&&S.geometry.coordinates.flat().forEach(p=>v.extend(p))}),v.isEmpty()||m.fitBounds(v,{padding:40})}},[J,a,n,s,h]);const Mo=f=>{const m=t.current;if(!m)return;[`ortho-${f}`,"all-features-points","all-features-lines","all-features-polygons","all-features-polygons-outline","comment-labels"].forEach(O=>{m.getLayer(O)&&(console.log("Removing layer:",O),m.removeLayer(O))}),[`ortho-${f}`,"all-features"].forEach(O=>{m.getSource(O)&&(console.log("Removing source:",O),m.removeSource(O))})},Lo=f=>{const m=t.current;if(!m||!f.tileBaseUrl)return;const T=`ortho-${f.id}`;try{m.getLayer(T)&&m.removeLayer(T),m.getSource(T)&&m.removeSource(T),m.addSource(T,{type:"raster",tiles:[`${f.tileBaseUrl}/{z}/{x}/{y}.png`],tileSize:256,minzoom:10,maxzoom:23});const P=m.getStyle().layers.find(O=>O.id.startsWith("gl-draw-")).id;m.addLayer({id:T,type:"raster",source:T,paint:{"raster-opacity":a.orthomosaic?1:0,"raster-brightness-min":0,"raster-brightness-max":1}},P),console.log("Raster layer added:",T,"URL:",f.tileBaseUrl),setTimeout(()=>{const O=m.getLayer(T),X=m.getSource(T);console.log("Layer check:",{layerExists:!!O,sourceExists:!!X,layerVisible:m.getLayoutProperty(T,"visibility")!=="none",paintOpacity:m.getPaintProperty(T,"raster-opacity")})},1e3),q(!1)}catch(P){console.error("Error adding tile layer:",P),R("Failed to load orthomosaic tiles."),q(!1)}},wo=f=>{const m=t.current;if(!m)return;const{north:T,south:P,east:O,west:X}=f;m.fitBounds([[X,P],[O,T]],{padding:50,maxZoom:18})},De=f=>{u(m=>({...m,[f.target.name]:f.target.checked}))},Po=f=>{c(f.target.value);const m=h.find(T=>T.name===f.target.value);$(m)},Oo=f=>{const m=t.current;if(!(!m||!n)){if(console.log("Updating comment layer with features:",f),m.getLayer("comment-points")&&(console.log("Removing existing comment layer"),m.removeLayer("comment-points")),m.getSource("comments")&&(console.log("Removing existing comment source"),m.removeSource("comments")),console.log("checking features ",f),f&&f.length>0&&a.showComments){console.log("Adding new comment layer with",f.length,"features"),m.addSource("comments",{type:"geojson",data:{type:"FeatureCollection",features:f}}),m.addLayer({id:"comment-points",type:"symbol",source:"comments",layout:{"icon-image":"marker-15","icon-size":1.5,"text-field":["get","comment"],"text-offset":[0,1.5],"text-anchor":"top"},paint:{"text-size":.5,"text-color":"#000","text-halo-color":"#fff","text-halo-width":2}});const T=m.getLayer("comment-points");T&&console.log("Comment layer added successfully with ID:",T.id)}else console.log("No features to display, comment layer removed");m.isStyleLoaded()&&m.triggerRepaint(),console.log("Comment layer update complete")}},xo=async f=>{console.log("=== COMMENT DELETION DEBUG ==="),console.log("Attempting to delete comment",f),console.log("Current commentFeatures:",ee),console.log(ee[0].properties.comment),console.log(f.properties.comment);const m=ee.filter(T=>T.properties.id!==f.properties.id);try{await le.delete(`/mapFeature/propertyId/${f.properties.id}`,{headers:{Authorization:Ce}})}catch(T){console.error(T)}console.log("Updated commentFeatures after deletion:",m),ge("Successfully Removed Comment",{variant:"success"}),Y(m),refreshCommentLayer(),we({open:!1,feature:null,isEdit:!1,position:{x:0,y:0}}),console.log("=== END DELETION DEBUG ===")};return Me?g.jsxs(Rt,{children:[g.jsxs(fe,{display:"flex",justifyContent:"space-between",alignItems:"center",children:[g.jsx(Pe,{variant:"h1",gutterBottom:!0,children:"Exterior (Map View)"}),g.jsx(Ge,{variant:"contained",onClick:()=>E(!0),disabled:b,children:"Upload New"})]}),g.jsx(wr,{open:y,onClose:()=>E(!1)}),g.jsx(jo,{links:Io,card:!0,custom:!0,rightAlign:!1}),g.jsx(Wo,{sx:{my:2}}),g.jsxs(fe,{display:"flex",height:"calc(100vh - 320px)",gap:1,children:[g.jsxs(fe,{sx:{width:"250px",pr:2,height:"100%"},children:[g.jsx(Pe,{onClick:()=>{const f=t.current.queryRenderedFeatures();console.log("Total Rendered Features:",f.length);const m=t.current.queryRenderedFeatures({layers:["overlay-fill-68ad75d9366cff02d631be9f","overlay-line-68ad75d9366cff02d631be9f","overlay-point-68ad75d9366cff02d631be9f"]});console.log("Overlay Rendered Features:",m.length)},variant:"h3",gutterBottom:!0,children:"Layers"}),g.jsxs(tr,{children:[g.jsx(ke,{control:g.jsx(Ue,{checked:a.orthomosaic,onChange:De,name:"orthomosaic",disabled:b}),label:"Orthomosaic"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.showLineString,onChange:De,name:"showLineString",disabled:b}),label:"Lines"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.showPolygons,onChange:De,name:"showPolygons",disabled:b}),label:"Polygons"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.showComments,onChange:De,name:"showComments",disabled:b}),label:"Comments"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.builtinOverlay,onChange:De,name:"builtinOverlay",disabled:b}),label:"CAD Overlay"}),g.jsx(ke,{control:g.jsx(Ue,{checked:a.shapeOverlay,onChange:De,name:"shapeOverlay",disabled:b}),label:"SHP Overlay"})]}),g.jsxs(qo,{fullWidth:!0,sx:{mt:3},children:[g.jsx(Yo,{children:"Historical Data"}),g.jsx(Xo,{value:s||"",onChange:Po,label:"Historical Data",disabled:b||l.length===0,children:l.map(f=>g.jsx(Zo,{value:f,children:Ko(f).format("DD-MM-YYYY")},f))})]}),b&&g.jsx(fe,{sx:{display:"flex",justifyContent:"center",mt:2},children:g.jsx(io,{size:24})}),!b&&l.length===0&&g.jsx($t,{severity:"info",sx:{mt:2},children:"No historical data available for this project."})]}),g.jsx(fe,{ref:e,sx:{flex:1,borderRadius:2,overflow:"hidden",height:"100%",position:"relative",border:"1px solid #e0e0e0","& .mapboxgl-ctrl-scale":{border:"2px solid #333",borderTop:"none",color:"#333",backgroundColor:"rgba(255, 255, 255, 0.8)",padding:"2px 6px",fontSize:"12px",fontWeight:"bold"}}}),g.jsx(fn,{addCommentLayer:Oo,setCommentFeatures:Y,commentInput:be,setCommentInput:we,commentFeatures:ee,handleDeleteComment:xo,workDay:V,drawRef:o.current})]})]}):g.jsx(Rt,{children:g.jsx($t,{severity:"warning",children:"No project selected. Please select a project first."})})}export{Sn as default};
