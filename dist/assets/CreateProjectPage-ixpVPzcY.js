import{r as g,a as ne,d as se,j as e,a5 as ie,T as u,a6 as oe,f as ce,a7 as le,B as p,Y as x,a8 as de,a9 as ue,S as k,aa as G,ab as pe,l as H,m as E,a4 as y,ac as he,ad as _,g as D,ae as me,G as K}from"./index-D8LqObyy.js";import{u as xe,I as je}from"./index-ComscEnM.js";const fe=ce().shape({name:D().required("Project name is required"),description:D().required("Project Description is required"),team:me().of(D().email("Invalid email")),location:D().required("Location  is required"),startDate:_().nullable().test("start-required-if-end","Start date is required if end date is set",function(m){const{endDate:d}=this.parent;return d&&!m?this.createError({message:"Start date is required if end date is set"}):!0}),endDate:_().nullable().test("end-required-if-start","End date is required if start date is set",function(m){const{startDate:d}=this.parent;return d&&!m?this.createError({message:"End date is required if start date is set"}):!0})}),ge=({onSubmit:m})=>{const[d,q]=g.useState(""),[n,Y]=g.useState(null),[w,v]=g.useState(!1),[T,z]=g.useState(null),[P,S]=g.useState(0),W=ne(),C=se(a=>a.auth.token),J=a=>{a.length&&Y(a[0])},{getRootProps:O,getInputProps:Q,isDragActive:X}=xe({onDrop:J,multiple:!1}),Z=async a=>{var r,s,o,t,j,f,A,B,M,U,$,N;if(v(!0),z(null),S(0),!n)try{const i=await E.post("/project",a,{headers:{Authorization:C}}),c=(s=(r=i.data)==null?void 0:r.data)==null?void 0:s._id;W(c?`/project/${c}/View`:"/project"),i.status===201&&y("Successfully Created Project",{variant:"success"});return}catch(i){z(((t=(o=i.response)==null?void 0:o.data)==null?void 0:t.message)||i.message||"Failed to create project"),v(!1);return}a.file={filename:n.name,contentType:n.type,size:n.size};try{const i=await E.post("/project",a,{headers:{Authorization:C}});if(n!==null){const c=i.data.data;let V=((j=c==null?void 0:c.project)==null?void 0:j.id)||((A=(f=i.data)==null?void 0:f.data)==null?void 0:A._id);if(((B=c.upload)==null?void 0:B.uploadType)==="single")await he.put(c.upload.url,n,{headers:{"Content-Type":n.type},onUploadProgress:h=>{const I=Math.round(h.loaded*100/h.total);S(I)}});else if(((M=c.upload)==null?void 0:M.uploadType)==="multipart"){const{parts:h,uploadId:I,key:ee,partSize:te}=c.upload,L=[];let b=0;for(;b<n.size;){const l=Math.min(b+te,n.size);L.push(n.slice(b,l)),b=l}const F=[];for(let l=0;l<h.length;l++){const R=await fetch(h[l].url,{method:"PUT",body:L[l]});if(!R.ok)throw new Error(`Chunk ${l+1} failed to upload`);const ae=(U=R.headers.get("ETag"))==null?void 0:U.replace(/"/g,"");F.push({PartNumber:h[l].partNumber,ETag:ae});const re=Math.round((l+1)/h.length*100);S(re)}await E.post("/work-day/complete-upload",{projectId:V,name:new Date,key:ee,uploadId:I,parts:F},{headers:{Authorization:C}})}y("Upload successful!",{variant:"success"})}y("Successfully Created Historical Data",{variant:"success"})}catch(i){y(((N=($=i.response)==null?void 0:$.data)==null?void 0:N.message)||i.message||"Failed to create project",{variant:"error"})}finally{v(!1),W("/project")}};return e.jsxs(ie,{elevation:4,sx:{p:5,maxWidth:500},children:[e.jsx(u,{variant:"h2",mb:2,children:"Create New Project"}),e.jsx(oe,{initialValues:{name:"",team:[],startDate:null,endDate:null,description:"",location:""},validationSchema:fe,onSubmit:Z,children:({values:a,errors:r,touched:s,setFieldValue:o})=>e.jsxs(le,{children:[e.jsxs(p,{mb:2,children:[e.jsx(x,{fullWidth:!0,name:"name",label:"Project Name",value:a.name,onChange:t=>o("name",t.target.value),error:s.name&&!!r.name}),s.name&&r.name&&e.jsx(u,{color:"error",variant:"caption",children:r.name})]}),e.jsxs(p,{mb:2,children:[e.jsx(x,{fullWidth:!0,name:"location",label:"Project Location",value:a.location||"",onChange:t=>o("location",t.target.value)}),s.location&&r.location&&e.jsx(u,{color:"error",variant:"caption",children:r.location})]}),e.jsx(de,{dateAdapter:ue,children:e.jsxs(k,{direction:"row",spacing:2,mb:2,children:[e.jsx(G,{label:"Start Date",value:a.startDate,onChange:t=>o("startDate",t),format:"dd-MM-yyyy",renderInput:t=>e.jsx(x,{...t,fullWidth:!0,error:s.startDate&&!!r.startDate,helperText:s.startDate&&r.startDate})}),e.jsx(G,{label:"End Date",value:a.endDate,onChange:t=>o("endDate",t),format:"dd-MM-yyyy",renderInput:t=>e.jsx(x,{...t,fullWidth:!0,error:s.endDate&&!!r.endDate,helperText:s.endDate&&r.endDate})})]})}),e.jsxs(p,{mb:2,children:[e.jsx(x,{fullWidth:!0,name:"description",label:"Project Description",value:a.description||"",onChange:t=>o("description",t.target.value)}),s.description&&r.description&&e.jsx(u,{color:"error",variant:"caption",children:r.description})]}),e.jsx(x,{sx:{mb:2},fullWidth:!0,label:"Invite Team Member (press Enter to add)",value:d,onChange:t=>q(t.target.value),onKeyDown:t=>{t.key==="Enter"&&d&&(t.preventDefault(),o("team",[...a.team,d]),q(""))}}),e.jsx(k,{direction:"row",spacing:1,flexWrap:"wrap",mb:2,children:a.team.map((t,j)=>e.jsx(pe,{label:t,onDelete:()=>{const f=[...a.team];f.splice(j,1),o("team",f)}},j))}),e.jsxs(p,{...O(),sx:{border:"2px dashed #ccc",borderRadius:"8px",padding:4,textAlign:"center",justifyContent:"center",cursor:"pointer",backgroundColor:X?"#f0f0f0":"transparent",mb:2},children:[e.jsx("input",{...Q()}),e.jsx(je,{}),e.jsx(u,{variant:"h6",gutterBottom:!0,children:"Upload Supporting File"}),e.jsx(u,{variant:"body2",sx:{mb:2},children:"Drag & drop a .zip file or click below to browse"}),e.jsx(H,{variant:"outlined",children:"Browse Files"}),n&&e.jsxs(u,{variant:"body2",sx:{mt:1},children:["Selected: ",n.name]}),w&&P>0&&e.jsxs(p,{sx:{mt:2,justifyContent:"center",alignContent:"center",textAlign:"center"},children:[e.jsxs(u,{variant:"caption",children:["Uploading... ",P,"%"]}),e.jsx(p,{sx:{width:"100%"},children:e.jsx(k,{spacing:1,children:e.jsx(p,{sx:{width:"100%"},children:e.jsx(p,{sx:{height:4,bgcolor:"#eee",borderRadius:2,overflow:"hidden"},children:e.jsx(p,{sx:{width:`${P}%`,height:"100%",bgcolor:"primary.main",transition:"width 0.2s"}})})})})})]})]}),T&&e.jsx(u,{color:"error",variant:"body2",sx:{mb:2},children:T}),e.jsx(H,{color:"primary",variant:"contained",type:"submit",fullWidth:!0,disabled:w,children:w?"Creating...":"Create Project"})]})})]})},De=()=>{const m=d=>{console.log("Project submitted:",d)};return e.jsx(K,{container:!0,sx:{minHeight:"80vh",flexDirection:"row",width:"100%",justifyContent:"center"},children:e.jsx(K,{item:!0,xs:12,md:6,sx:{display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(ge,{onSubmit:m})})})};export{De as default};
